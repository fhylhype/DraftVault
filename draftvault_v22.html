<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DRAFTVAULT</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    /* ════════════════════════════════════════════════════════════
       VARIABLES & RESET
    ════════════════════════════════════════════════════════════ */
    :root {
      --bg-main:       #F0EFEB;
      --bg-secondary:  #E8E5E0;
      --accent:        #C17B5E;
      --accent-light:  #D9B8A4;
      --text-main:     #1A1A1A;
      --text-secondary:#666666;
      --danger:        #e74c3c;
      --success:       #3A8040;
      --navbar-collapsed: 60px;
      --navbar-expanded:  210px;
      --transition: 0.28s cubic-bezier(0.4,0,0.2,1);
      --radius: 12px;
      --panel-w: 310px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    /* ════════════════════════════════════════════════════════════
       NAVBAR
    ════════════════════════════════════════════════════════════ */
    #navbar {
      width: var(--navbar-collapsed);
      min-width: var(--navbar-collapsed);
      background: var(--bg-secondary);
      border-right: 1.5px solid var(--accent-light);
      display: flex;
      flex-direction: column;
      transition: width var(--transition), min-width var(--transition);
      overflow: hidden;
      z-index: 100;
      flex-shrink: 0;
    }
    #navbar.expanded { width: var(--navbar-expanded); min-width: var(--navbar-expanded); }

    .nav-btn {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 18px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--text-main);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      transition: background var(--transition), color var(--transition);
      text-align: left;
      width: 100%;
    }
    .nav-btn:hover { background: rgba(193,123,94,0.08); }
    .nav-btn.active { color: var(--accent); }
    .nav-btn.active .nav-icon { color: var(--accent); }

    .nav-icon {
      font-size: 18px;
      min-width: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: color var(--transition);
    }
    .nav-label {
      opacity: 0;
      transform: translateX(-8px);
      transition: opacity var(--transition), transform var(--transition);
      pointer-events: none;
    }
    #navbar.expanded .nav-label { opacity: 1; transform: translateX(0); }

    #toggle-btn { border-bottom: 1.5px solid var(--accent-light); }
    .nav-spacer { flex: 1; }
    .nav-divider { height: 1.5px; background: var(--accent-light); margin: 4px 12px; opacity: 0.6; }

    /* ════════════════════════════════════════════════════════════
       LAYOUT GÉNÉRAL
    ════════════════════════════════════════════════════════════ */
    #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }

    #topbar {
      display: flex;
      align-items: center;
      padding: 14px 28px;
      background: var(--bg-main);
      border-bottom: 1.5px solid var(--accent-light);
      gap: 20px;
      flex-shrink: 0;
    }
    #search-wrap { position: relative; flex: 1; max-width: 420px; }
    #search-wrap svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; }
    #search {
      width: 100%;
      padding: 9px 14px 9px 38px;
      background: var(--bg-main);
      border: 1.5px solid var(--accent-light);
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      color: var(--text-main);
      outline: none;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    #search::placeholder { color: var(--text-secondary); }
    #search:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(193,123,94,0.12); }
    #topbar-logo {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: -0.5px;
      white-space: nowrap;
      flex-shrink: 0;
      margin-left: auto;
    }

    #page { flex: 1; overflow-y: auto; padding: 28px; }

    /* ════════════════════════════════════════════════════════════
       COMPOSANTS COMMUNS — BOUTONS
    ════════════════════════════════════════════════════════════ */
    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 18px;
      border: 1.5px solid var(--accent-light);
      border-radius: 8px;
      background: transparent;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-main);
      cursor: pointer;
      transition: background var(--transition), border-color var(--transition);
    }
    .action-btn:hover { background: var(--accent-light); border-color: var(--accent); }
    .action-btn.primary { background: var(--accent); color: white; border-color: var(--accent); }
    .action-btn.primary:hover { opacity: 0.88; background: var(--accent); }

    .btn-primary {
      padding: 9px 18px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: white;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity var(--transition);
    }
    .btn-primary:hover { opacity: 0.88; }

    .btn-secondary {
      padding: 9px 18px;
      border: 1.5px solid var(--accent-light);
      border-radius: 8px;
      background: transparent;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background var(--transition);
    }
    .btn-secondary:hover { background: var(--bg-secondary); }

    /* ════════════════════════════════════════════════════════════
       HOME — DOSSIERS
    ════════════════════════════════════════════════════════════ */
    #home-page .page-header {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 24px;
    }
    #folders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }
    .folder-card {
      background: var(--bg-secondary);
      border: 1.5px solid var(--accent-light);
      border-radius: var(--radius);
      cursor: pointer;
      position: relative;
      transition: border-color var(--transition), box-shadow var(--transition), transform var(--transition);
      animation: fadeIn 0.3s ease both;
      aspect-ratio: 4/3;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .folder-card:hover { border-color: var(--accent); box-shadow: 0 4px 18px rgba(193,123,94,0.15); transform: translateY(-2px); }
    .folder-info-btn {
      position: absolute;
      top: 10px; right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 4px;
      border-radius: 50%;
      transition: color var(--transition), background var(--transition);
      display: flex; align-items: center;
    }
    .folder-info-btn:hover { color: var(--accent); background: rgba(193,123,94,0.1); }
    .folder-name {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--text-main);
      text-align: center;
      padding: 0 16px;
      line-height: 1.2;
    }
    .folder-count { font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--text-secondary); margin-top: 6px; }

    /* ════════════════════════════════════════════════════════════
       EMPTY STATES
    ════════════════════════════════════════════════════════════ */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-state svg { display: block; margin: 0 auto 12px; opacity: 0.35; }
    .empty-state p { font-size: 15px; font-family: 'DM Sans', sans-serif; }

    /* ════════════════════════════════════════════════════════════
       FOLDER DETAIL — TEMPLATES
    ════════════════════════════════════════════════════════════ */
    #folder-detail-page { display: none; }
    .detail-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 28px;
      flex-wrap: wrap;
    }
    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border: 1.5px solid var(--accent-light);
      border-radius: 8px;
      background: transparent;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      cursor: pointer;
      transition: background var(--transition), border-color var(--transition);
      flex-shrink: 0;
    }
    .back-btn:hover { background: var(--bg-secondary); border-color: var(--accent); }
    .detail-title { font-family: 'Space Grotesk', sans-serif; font-size: 24px; font-weight: 700; color: var(--text-main); }
    .detail-subtitle { font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--text-secondary); }
    .detail-spacer { flex: 1; }

    #templates-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
    .template-card {
      background: var(--bg-main);
      border: 1.5px solid var(--accent-light);
      border-radius: var(--radius);
      overflow: hidden;
      cursor: pointer;
      position: relative;
      transition: border-color var(--transition), box-shadow var(--transition), transform var(--transition);
      animation: fadeIn 0.3s ease both;
    }
    .template-card:hover { border-color: var(--accent); box-shadow: 0 6px 24px rgba(193,123,94,0.18); transform: translateY(-3px); }
    .template-preview {
      height: 160px;
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .preview-bar { height: 20px; background: #d4d0ca; display: flex; align-items: center; padding: 0 8px; gap: 4px; flex-shrink: 0; }
    .preview-dot { width: 6px; height: 6px; border-radius: 50%; }
    .preview-body { flex: 1; display: flex; flex-direction: column; padding: 8px 10px 6px; gap: 5px; overflow: hidden; }
    .skel { border-radius: 3px; }
    .skel-hero { height: 38px; width: 100%; border-radius: 4px; }
    .skel-line { height: 6px; border-radius: 3px; }
    .skel-line.w100 { width: 100%; }
    .skel-line.w70  { width: 70%; }
    .skel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 2px; }
    .skel-card { height: 26px; border-radius: 4px; }
    .template-card-body {
      padding: 12px 14px 10px;
      border-top: 1.5px solid var(--accent-light);
    }
    .template-name { font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 600; color: var(--text-main); margin-bottom: 6px; }
    .template-meta { font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; justify-content: space-between; }
    .template-tag { display: inline-block; padding: 2px 8px; background: rgba(193,123,94,0.12); color: var(--accent); border-radius: 20px; font-size: 11px; font-weight: 500; }
    .template-overlay {
      position: absolute; inset: 0;
      background: rgba(193,123,94,0.08);
      display: flex; align-items: center; justify-content: center; gap: 8px;
      opacity: 0;
      transition: opacity var(--transition);
      pointer-events: none;
    }
    .template-card:hover .template-overlay { opacity: 1; }
    .overlay-open-btn, .overlay-info-btn {
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      pointer-events: all;
      display: flex; align-items: center; gap: 7px;
      transition: opacity var(--transition);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    .overlay-open-btn { background: var(--accent); color: white; }
    .overlay-open-btn:hover, .overlay-info-btn:hover { opacity: 0.88; }
    .overlay-info-btn { background: var(--bg-main); color: var(--text-main); }

    /* ════════════════════════════════════════════════════════════
       ÉDITEUR — STRUCTURE
    ════════════════════════════════════════════════════════════ */
    #editor-page { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    #editor-page.active { display: flex; }

    #editor-topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 20px;
      background: var(--bg-secondary);
      border-bottom: 1.5px solid var(--accent-light);
      flex-shrink: 0;
    }
    #editor-back-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 7px 14px;
      border: 1.5px solid var(--accent-light);
      border-radius: 8px;
      background: transparent;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      cursor: pointer;
      transition: background var(--transition), border-color var(--transition);
    }
    #editor-back-btn:hover { background: var(--bg-main); border-color: var(--accent); }
    #editor-template-name { font-family: 'Space Grotesk', sans-serif; font-size: 15px; font-weight: 600; color: var(--text-main); }
    #editor-folder-name { font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--text-secondary); }
    .editor-topbar-spacer { flex: 1; }
    #save-indicator { font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--text-secondary); opacity: 0; transition: opacity 0.3s; }
    #save-indicator.visible { opacity: 1; }

    #present-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 7px 14px;
      border: 1.5px solid var(--accent-light);
      border-radius: 8px;
      background: transparent;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      cursor: pointer;
      transition: background var(--transition), border-color var(--transition), color var(--transition);
    }
    #present-btn:hover { background: var(--bg-main); border-color: var(--accent); }
    #present-btn.presenting { background: var(--accent); color: white; border-color: var(--accent); }

    #export-pdf-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 7px 14px;
      border: 1.5px solid var(--accent-light);
      border-radius: 8px;
      background: transparent;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      cursor: pointer;
      transition: background var(--transition), border-color var(--transition);
    }
    #export-pdf-btn:hover { background: var(--bg-main); border-color: var(--accent); }

    #save-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 7px 16px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: white;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity var(--transition);
    }
    #save-btn:hover { opacity: 0.88; }

    #editor-body { flex: 1; display: flex; overflow: hidden; }

    /* ════════════════════════════════════════════════════════════
       ÉDITEUR — PANNEAU GAUCHE
    ════════════════════════════════════════════════════════════ */
    #editor-panel {
      width: var(--panel-w);
      min-width: var(--panel-w);
      background: var(--bg-secondary);
      border-right: 1.5px solid var(--accent-light);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: width var(--transition), min-width var(--transition), opacity var(--transition);
    }
    #editor-panel.hidden { width: 0; min-width: 0; opacity: 0; pointer-events: none; }
    #panel-scroll { flex: 1; overflow-y: auto; padding: 0; }

    /* Tabs du panneau */
    .panel-tabs { display: flex; border-bottom: 1.5px solid var(--accent-light); flex-shrink: 0; }
    .panel-tab {
      flex: 1;
      padding: 10px 8px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-secondary);
      cursor: pointer;
      text-align: center;
      border-bottom: 2px solid transparent;
      transition: color var(--transition), border-color var(--transition);
      margin-bottom: -1.5px;
    }
    .panel-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .panel-tab:hover:not(.active) { color: var(--text-main); }
    .panel-tab-content { display: none; }
    .panel-tab-content.active { display: block; }

    /* Sections du panneau (accordéon) */
    .panel-section { border-bottom: 1.5px solid var(--accent-light); }
    .panel-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      cursor: pointer;
      user-select: none;
      transition: background var(--transition);
    }
    .panel-section-header:hover { background: rgba(193,123,94,0.05); }
    .panel-section-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }
    .panel-chevron { transition: transform var(--transition); color: var(--text-secondary); }
    .panel-section.collapsed .panel-chevron { transform: rotate(-90deg); }
    .panel-section-body { padding: 4px 16px 14px; overflow: hidden; transition: max-height var(--transition), padding var(--transition); }
    .panel-section.collapsed .panel-section-body { max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; }

    /* Contrôles du panneau */
    .ctrl-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; gap: 8px; }
    .ctrl-label { font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--text-secondary); flex-shrink: 0; min-width: 80px; }
    .ctrl-select {
      flex: 1;
      padding: 6px 10px;
      border: 1.5px solid var(--accent-light);
      border-radius: 6px;
      background: var(--bg-main);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      color: var(--text-main);
      outline: none;
      transition: border-color var(--transition);
      cursor: pointer;
    }
    .ctrl-select:focus { border-color: var(--accent); }
    .ctrl-input {
      flex: 1;
      padding: 6px 10px;
      border: 1.5px solid var(--accent-light);
      border-radius: 6px;
      background: var(--bg-main);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      color: var(--text-main);
      outline: none;
      transition: border-color var(--transition);
    }
    .ctrl-input:focus { border-color: var(--accent); }
    .ctrl-textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1.5px solid var(--accent-light);
      border-radius: 6px;
      background: var(--bg-main);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      color: var(--text-main);
      outline: none;
      transition: border-color var(--transition);
      resize: vertical;
      min-height: 60px;
      line-height: 1.5;
      margin-top: 4px;
    }
    .ctrl-textarea:focus { border-color: var(--accent); }
    .ctrl-range { flex: 1; accent-color: var(--accent); cursor: pointer; }
    .ctrl-range-val { font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--text-secondary); min-width: 32px; text-align: right; }
    .color-swatch-wrap { width: 32px; height: 28px; border: 1.5px solid var(--accent-light); border-radius: 6px; overflow: hidden; cursor: pointer; flex-shrink: 0; }
    .color-swatch-wrap input[type="color"] { width: 44px; height: 44px; border: none; outline: none; cursor: pointer; padding: 0; margin: -6px 0 0 -6px; }

    /* Versions */
    .version-item {
      display: flex; align-items: center; gap: 8px;
      padding: 7px 0;
      border-bottom: 1px solid rgba(217,184,164,0.35);
      font-family: 'DM Sans', sans-serif;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .version-item:last-child { border-bottom: none; }
    .version-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-light); flex-shrink: 0; }
    .version-dot.current { background: var(--accent); }
    .version-name { flex: 1; color: var(--text-main); font-weight: 500; }
    .version-restore {
      background: none;
      border: 1px solid var(--accent-light);
      border-radius: 4px;
      padding: 2px 8px;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      font-size: 11px;
      color: var(--text-secondary);
      transition: border-color var(--transition), color var(--transition);
    }
    .version-restore:hover { border-color: var(--accent); color: var(--accent); }

    /* ════════════════════════════════════════════════════════════
       ÉDITEUR — ONGLET SECTIONS (liste D&D + sous-panneau)
    ════════════════════════════════════════════════════════════ */
    #sections-tab-content { display: flex; flex-direction: column; height: 100%; }
    #sections-list { padding: 12px; flex: 1; overflow-y: auto; }

    .section-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-main);
      border: 1.5px solid var(--accent-light);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: grab;
      transition: border-color var(--transition), box-shadow var(--transition), opacity var(--transition);
      user-select: none;
    }
    .section-item:hover { border-color: var(--accent-light); box-shadow: 0 2px 8px rgba(193,123,94,0.1); }
    .section-item.selected { border-color: var(--accent); background: rgba(193,123,94,0.06); }
    .section-item:active { cursor: grabbing; }
    .section-item.dragging { opacity: 0.4; }
    .section-item.drag-over { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(193,123,94,0.2); }

    .section-drag-handle { color: var(--text-secondary); flex-shrink: 0; cursor: grab; }
    .section-item-label { flex: 1; font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--text-main); }
    .section-item-actions { display: flex; align-items: center; gap: 4px; }

    .section-toggle {
      background: none; border: none;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 3px;
      transition: color var(--transition);
      display: flex; align-items: center;
    }
    .section-toggle:hover { color: var(--accent); }
    .section-toggle.hidden-section { opacity: 0.4; }

    .section-edit-btn {
      background: none; border: none;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 3px;
      transition: color var(--transition);
      display: flex; align-items: center;
      border-radius: 4px;
    }
    .section-edit-btn:hover { color: var(--accent); background: rgba(193,123,94,0.1); }

    .section-del-btn {
      background: none; border: none;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 3px;
      font-size: 16px;
      line-height: 1;
      opacity: 0.5;
      transition: opacity var(--transition), color var(--transition);
      display: flex; align-items: center;
    }
    .section-del-btn:hover { opacity: 1; color: var(--danger); }

    /* Bouton "Ajouter une section" en bas de la liste */
    #add-section-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin: 0 12px 12px;
      padding: 10px 16px;
      border: 1.5px dashed var(--accent-light);
      border-radius: 8px;
      background: transparent;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: border-color var(--transition), color var(--transition), background var(--transition);
      flex-shrink: 0;
    }
    #add-section-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(193,123,94,0.04); }

    /* ════════════════════════════════════════════════════════════
       ÉDITEUR — SOUS-PANNEAU D'ÉDITION DE SECTION
    ════════════════════════════════════════════════════════════ */
    #section-subpanel {
      position: absolute;
      top: 0; left: var(--panel-w);
      width: 300px;
      height: 100%;
      background: var(--bg-main);
      border-right: 1.5px solid var(--accent-light);
      border-left: 1.5px solid var(--accent-light);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transform: translateX(-16px);
      opacity: 0;
      pointer-events: none;
      transition: transform var(--transition), opacity var(--transition);
      z-index: 10;
      box-shadow: 4px 0 24px rgba(0,0,0,0.08);
    }
    #section-subpanel.open {
      transform: translateX(0);
      opacity: 1;
      pointer-events: all;
    }
    #subpanel-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      border-bottom: 1.5px solid var(--accent-light);
      flex-shrink: 0;
    }
    #subpanel-back {
      background: none; border: none;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 4px;
      border-radius: 6px;
      display: flex; align-items: center;
      transition: color var(--transition), background var(--transition);
    }
    #subpanel-back:hover { color: var(--accent); background: rgba(193,123,94,0.1); }
    #subpanel-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      font-weight: 700;
      color: var(--text-main);
      flex: 1;
    }
    #subpanel-scroll { flex: 1; overflow-y: auto; padding: 14px 16px; }

    /* Champs du sous-panneau */
    .subpanel-field { margin-bottom: 14px; }
    .subpanel-field label {
      display: block;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }
    .subpanel-field input,
    .subpanel-field textarea,
    .subpanel-field select {
      width: 100%;
      padding: 8px 10px;
      border: 1.5px solid var(--accent-light);
      border-radius: 7px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      background: var(--bg-secondary);
      color: var(--text-main);
      outline: none;
      transition: border-color var(--transition);
    }
    .subpanel-field input:focus,
    .subpanel-field textarea:focus,
    .subpanel-field select:focus { border-color: var(--accent); }
    .subpanel-field textarea { resize: vertical; min-height: 70px; line-height: 1.5; }

    /* Champ nombre avec +/- */
    .subpanel-counter {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .subpanel-counter-btn {
      width: 30px; height: 30px;
      border: 1.5px solid var(--accent-light);
      border-radius: 6px;
      background: var(--bg-secondary);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: border-color var(--transition), background var(--transition);
    }
    .subpanel-counter-btn:hover { border-color: var(--accent); background: rgba(193,123,94,0.1); }
    .subpanel-counter-val {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 15px;
      font-weight: 700;
      color: var(--text-main);
      min-width: 24px;
      text-align: center;
    }

    /* Zone image dans le sous-panneau */
    .subpanel-img-cell {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 8px;
      overflow: hidden;
      border: 1.5px dashed var(--accent-light);
      cursor: pointer;
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: border-color var(--transition), background var(--transition);
    }
    .subpanel-img-cell:hover { border-color: var(--accent); background: rgba(193,123,94,0.06); }
    .subpanel-img-cell.has-img { border-style: solid; }
    .subpanel-img-cell img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    .subpanel-img-label {
      font-family: 'DM Sans', sans-serif;
      font-size: 11px;
      color: var(--text-secondary);
      transition: color var(--transition);
    }
    .subpanel-img-cell:hover .subpanel-img-label { color: var(--accent); }

    /* Séparateur de section dans le sous-panneau */
    .subpanel-divider {
      height: 1px;
      background: var(--accent-light);
      margin: 14px 0;
      opacity: 0.6;
    }
    .subpanel-section-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    /* Bouton appliquer dans le sous-panneau */
    #subpanel-apply {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin: 0 16px 16px;
      padding: 11px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: white;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity var(--transition);
      flex-shrink: 0;
    }
    #subpanel-apply:hover { opacity: 0.88; }

    /* ════════════════════════════════════════════════════════════
       ÉDITEUR — ONGLET MÉDIAS
    ════════════════════════════════════════════════════════════ */
    #media-tab-content { padding: 12px; }
    .media-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .media-gallery-cell {
      position: relative;
      aspect-ratio: 1;
      border-radius: 6px;
      overflow: hidden;
      border: 1.5px dashed var(--accent-light);
      cursor: pointer;
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: border-color var(--transition), background var(--transition);
    }
    .media-gallery-cell:hover { border-color: var(--accent); background: rgba(193,123,94,0.06); }
    .media-gallery-cell:hover .media-gallery-cell-label { color: var(--accent); }
    .media-gallery-cell.has-img { border-style: solid; }
    .media-gallery-cell img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    .media-gallery-cell-label { font-family: 'DM Sans', sans-serif; font-size: 10px; color: var(--text-secondary); transition: color var(--transition); }

    /* Logo upload zone */
    .logo-drop-zone {
      border: 2px dashed var(--accent-light);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: border-color var(--transition), background var(--transition);
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
    }
    .logo-drop-zone:hover { border-color: var(--accent); background: rgba(193,123,94,0.04); }
    .logo-drop-zone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
    .logo-drop-zone .logo-preview { max-height: 56px; max-width: 100%; object-fit: contain; display: none; margin: 0 auto; }
    .logo-drop-zone.has-logo .logo-preview { display: block; }
    .logo-drop-zone.has-logo .logo-placeholder { display: none; }
    .logo-placeholder { color: var(--text-secondary); font-family: 'DM Sans', sans-serif; font-size: 12px; }
    .logo-placeholder svg { display: block; margin: 0 auto 6px; opacity: 0.4; }

    /* ════════════════════════════════════════════════════════════
       ÉDITEUR — APERÇU IFRAME
    ════════════════════════════════════════════════════════════ */
    #editor-preview {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: #ccc;
      position: relative;
      min-height: 0;
    }
    #preview-toolbar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border-bottom: 1.5px solid var(--accent-light);
      flex-shrink: 0;
    }
    .device-btn {
      display: flex; align-items: center; gap: 5px;
      padding: 5px 12px;
      border: 1.5px solid transparent;
      border-radius: 6px;
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: background var(--transition), border-color var(--transition), color var(--transition);
    }
    .device-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(193,123,94,0.08); }
    .device-btn:hover:not(.active) { background: rgba(193,123,94,0.05); }
    #preview-frame-wrap {
      flex: 1;
      overflow: auto !important;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 20px;
      background: #b8b4ae;
      min-height: 0;
    }
    #preview-scale-wrap { transform-origin: top left; flex-shrink: 0; }
    #preview-iframe-container {
      background: white;
      box-shadow: 0 8px 40px rgba(0,0,0,0.3);
      border-radius: 6px;
      overflow: hidden;
    }
    #preview-iframe-container.device-tablet { border-radius: 14px; }
    #preview-iframe-container.device-mobile { border-radius: 40px; border: 8px solid #333; background: #333; }
    #preview-iframe { border: none; display: block; }

    /* ════════════════════════════════════════════════════════════
       PROJECTS / CLIENTS
    ════════════════════════════════════════════════════════════ */
    #projects-page { display: none; flex-direction: column; height: 100%; color: var(--text-main); overflow-y: auto; }
    .projects-topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-shrink: 0; }
    .projects-title { font-family: 'Space Grotesk', sans-serif; font-size: 22px; font-weight: 700; color: var(--text-main); }
    #projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
    .project-card {
      background: var(--bg-secondary);
      border: 1.5px solid var(--accent-light);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: border-color var(--transition), box-shadow var(--transition), transform var(--transition);
      animation: fadeIn 0.3s ease both;
    }
    .project-card:hover { border-color: var(--accent); box-shadow: 0 4px 18px rgba(193,123,94,0.15); transform: translateY(-2px); }
    .project-card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 12px; }
    .project-card-name { font-family: 'Space Grotesk', sans-serif; font-size: 17px; font-weight: 700; color: var(--text-main); }
    .project-card-company { font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    .project-card-meta { font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--text-secondary); display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px; }
    .project-card-actions { display: flex; gap: 6px; }
    .project-card-edit-btn { background: none; border: 1px solid var(--accent-light); border-radius: 6px; padding: 4px 10px; font-family: 'DM Sans', sans-serif; font-size: 11px; color: var(--text-secondary); cursor: pointer; transition: border-color var(--transition), color var(--transition); }
    .project-card-edit-btn:hover { border-color: var(--accent); color: var(--accent); }
    .project-card-del-btn { background: none; border: 1px solid rgba(231,76,60,0.3); border-radius: 6px; padding: 4px 8px; font-family: 'DM Sans', sans-serif; font-size: 11px; color: var(--danger); cursor: pointer; transition: background var(--transition); }
    .project-card-del-btn:hover { background: rgba(231,76,60,0.1); }
    .project-card-projs { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(217,184,164,0.3); font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--text-secondary); }
    .project-card-proj-tag { display: inline-block; padding: 2px 8px; background: rgba(193,123,94,0.1); color: var(--accent); border-radius: 20px; font-size: 11px; margin: 2px 4px 2px 0; }

    /* Client modal */
    #client-modal { background: var(--bg-main); border: 1.5px solid var(--accent-light); border-radius: 14px; width: 560px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.18); animation: modalIn 0.2s ease both; overflow: hidden; }
    #client-modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px 16px; border-bottom: 1.5px solid var(--accent-light); flex-shrink: 0; }
    #client-modal-title { font-family: 'Space Grotesk', sans-serif; font-size: 17px; font-weight: 700; color: var(--text-main); }
    #client-modal-close { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 6px; border-radius: 50%; display: flex; align-items: center; }
    #client-modal-close:hover { color: var(--accent); }
    #client-modal-body { flex: 1; overflow-y: auto; padding: 24px; }

    /* Client fields */
    .client-fields-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px; }
    .client-field label { display: block; font-family: 'Space Grotesk', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 5px; }
    .client-field input, .client-field select, .client-field textarea { width: 100%; padding: 8px 10px; border: 1.5px solid var(--accent-light); border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 13px; background: var(--bg-main); color: var(--text-main); outline: none; transition: border-color var(--transition); }
    .client-field input:focus, .client-field select:focus, .client-field textarea:focus { border-color: var(--accent); }
    .client-field textarea { resize: vertical; min-height: 60px; line-height: 1.5; }
    .client-save-btn { width: 100%; padding: 11px; border: none; border-radius: 8px; background: var(--accent); color: white; font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 16px; transition: opacity var(--transition); }
    .client-save-btn:hover { opacity: 0.88; }

    /* Status badges */
    .client-status-badge { padding: 4px 12px; border-radius: 20px; font-family: 'Space Grotesk', sans-serif; font-size: 12px; font-weight: 600; }
    .status-prospect  { background: rgba(102,102,102,0.1); color: #555; }
    .status-active    { background: rgba(80,160,80,0.12); color: #3A8040; }
    .status-completed { background: rgba(80,130,200,0.12); color: #3A6AA0; }
    .status-paused    { background: rgba(200,140,60,0.12); color: #8A5A10; }

    /* ════════════════════════════════════════════════════════════
       INFO DRAWER (droit)
    ════════════════════════════════════════════════════════════ */
    #info-drawer-overlay { display: none; position: fixed; inset: 0; background: rgba(26,26,26,0.3); backdrop-filter: blur(2px); z-index: 210; }
    #info-drawer-overlay.visible { display: block; }
    #info-drawer {
      position: fixed; top: 0; right: 0;
      width: 420px; height: 100vh;
      background: var(--bg-main);
      border-left: 1.5px solid var(--accent-light);
      display: flex; flex-direction: column;
      z-index: 211;
      transform: translateX(100%);
      transition: transform 0.32s cubic-bezier(0.4,0,0.2,1);
      box-shadow: -8px 0 40px rgba(0,0,0,0.12);
    }
    #info-drawer.open { transform: translateX(0); }
    #info-drawer-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px 16px; border-bottom: 1.5px solid var(--accent-light); flex-shrink: 0; }
    #info-drawer-title { font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 700; color: var(--text-main); }
    #info-drawer-folder { font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
    #info-drawer-close { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 6px; border-radius: 50%; transition: color var(--transition), background var(--transition); display: flex; align-items: center; }
    #info-drawer-close:hover { color: var(--accent); background: rgba(193,123,94,0.1); }
    #info-drawer-body { flex: 1; overflow-y: auto; padding: 0; }

    /* Tabs inside drawer */
    .drawer-tabs { display: flex; border-bottom: 1.5px solid var(--accent-light); padding: 0 24px; flex-shrink: 0; }
    .drawer-tab { padding: 10px 14px; font-family: 'Space Grotesk', sans-serif; font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; transition: color var(--transition), border-color var(--transition); margin-bottom: -1.5px; }
    .drawer-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .drawer-tab:hover:not(.active) { color: var(--text-main); }
    .drawer-tab-content { display: none; padding: 20px 24px; }
    .drawer-tab-content.active { display: block; }

    /* Info fields */
    .info-field { margin-bottom: 18px; }
    .info-field label { display: block; font-family: 'Space Grotesk', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 0.07em; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 6px; }
    .info-field input, .info-field textarea, .info-field select { width: 100%; padding: 9px 12px; border: 1.5px solid var(--accent-light); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 14px; background: var(--bg-main); color: var(--text-main); outline: none; transition: border-color var(--transition); }
    .info-field input:focus, .info-field textarea:focus, .info-field select:focus { border-color: var(--accent); }
    .info-field textarea { resize: vertical; min-height: 80px; line-height: 1.5; }

    /* Tags */
    .tags-wrap { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
    .tag-chip { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; background: rgba(193,123,94,0.12); color: var(--accent); border-radius: 20px; font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 500; }
    .tag-chip button { background: none; border: none; cursor: pointer; color: var(--accent); opacity: 0.7; font-size: 14px; line-height: 1; padding: 0 0 1px; }
    .tag-chip button:hover { opacity: 1; }
    .tag-input-row { display: flex; gap: 8px; margin-top: 8px; }
    .tag-input-row input { flex: 1; padding: 7px 10px; border: 1.5px solid var(--accent-light); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 13px; background: var(--bg-main); color: var(--text-main); outline: none; transition: border-color var(--transition); }
    .tag-input-row input:focus { border-color: var(--accent); }
    .tag-input-row button { padding: 7px 14px; border: none; border-radius: 8px; background: var(--accent); color: white; font-family: 'Space Grotesk', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; }

    /* Historique */
    .history-entry { padding: 12px 0; border-bottom: 1px solid rgba(217,184,164,0.3); }
    .history-entry:last-child { border-bottom: none; }
    .history-date { font-family: 'DM Sans', sans-serif; font-size: 11px; color: var(--text-secondary); margin-bottom: 3px; }
    .history-action { font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--text-main); }

    /* Devis */
    .devis-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .devis-label { font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--text-main); flex: 1; }
    .devis-amount { font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 600; color: var(--text-main); min-width: 80px; text-align: right; }
    .devis-total-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-top: 2px solid var(--accent-light); margin-top: 6px; }
    .devis-total-label { font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 700; color: var(--text-main); }
    .devis-total-amount { font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 700; color: var(--accent); }
    .devis-status { display: inline-block; padding: 3px 10px; border-radius: 20px; font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 500; }
    .devis-status.draft { background: rgba(102,102,102,0.12); color: var(--text-secondary); }
    .devis-status.sent { background: rgba(80,130,200,0.12); color: #3A6AA0; }
    .devis-status.accepted { background: rgba(80,160,80,0.12); color: #3A8040; }
    .drawer-save-btn { width: 100%; padding: 11px; border: none; border-radius: 8px; background: var(--accent); color: white; font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; transition: opacity var(--transition); margin-top: 8px; }
    .drawer-save-btn:hover { opacity: 0.88; }

    /* ════════════════════════════════════════════════════════════
       NOTES (panneau flottant bas-droite)
    ════════════════════════════════════════════════════════════ */
    #notes-overlay { display: none; position: fixed; inset: 0; background: rgba(26,26,26,0.3); backdrop-filter: blur(2px); z-index: 220; }
    #notes-overlay.visible { display: block; }
    #notes-panel {
      position: fixed; bottom: 0; right: 0;
      width: 400px; height: 70vh; min-height: 400px;
      background: var(--bg-main);
      border-left: 1.5px solid var(--accent-light);
      border-top: 1.5px solid var(--accent-light);
      border-radius: 14px 0 0 0;
      display: flex; flex-direction: column;
      z-index: 221;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
      box-shadow: -4px -4px 30px rgba(0,0,0,0.12);
    }
    #notes-panel.open { transform: translateY(0); }
    #notes-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px 12px; border-bottom: 1.5px solid var(--accent-light); flex-shrink: 0; }
    #notes-header-title { font-family: 'Space Grotesk', sans-serif; font-size: 15px; font-weight: 700; color: var(--text-main); }
    .notes-header-actions { display: flex; gap: 8px; align-items: center; }
    #new-note-btn { padding: 5px 12px; border: 1.5px solid var(--accent-light); border-radius: 6px; background: transparent; font-family: 'Space Grotesk', sans-serif; font-size: 12px; font-weight: 600; color: var(--accent); cursor: pointer; transition: background var(--transition); }
    #new-note-btn:hover { background: rgba(193,123,94,0.1); }
    #notes-close { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 4px; border-radius: 50%; display: flex; align-items: center; transition: color var(--transition); }
    #notes-close:hover { color: var(--accent); }
    #notes-body { flex: 1; display: flex; overflow: hidden; }
    #notes-list { width: 150px; border-right: 1.5px solid var(--accent-light); overflow-y: auto; flex-shrink: 0; }
    .note-list-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid rgba(217,184,164,0.25); transition: background var(--transition); }
    .note-list-item:hover { background: rgba(193,123,94,0.05); }
    .note-list-item.active { background: rgba(193,123,94,0.1); }
    .note-list-title { font-family: 'Space Grotesk', sans-serif; font-size: 12px; font-weight: 600; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .note-list-date { font-family: 'DM Sans', sans-serif; font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
    #note-editor { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    #note-title-input { padding: 12px 16px; border: none; border-bottom: 1.5px solid var(--accent-light); font-family: 'Space Grotesk', sans-serif; font-size: 14px; font-weight: 600; color: var(--text-main); background: var(--bg-main); outline: none; }
    #note-content-input { flex: 1; padding: 14px 16px; border: none; font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--text-main); background: var(--bg-main); outline: none; resize: none; line-height: 1.6; }
    .note-empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 8px; color: var(--text-secondary); font-family: 'DM Sans', sans-serif; font-size: 14px; }

    /* ════════════════════════════════════════════════════════════
       RACCOURCIS CLAVIER (modale)
    ════════════════════════════════════════════════════════════ */
    #shortcuts-modal {
      background: var(--bg-main);
      border: 1.5px solid var(--accent-light);
      border-radius: 16px;
      padding: 0;
      min-width: 480px; max-width: 540px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.18);
      animation: modalIn 0.2s ease both;
      overflow: hidden;
      max-height: 80vh;
      display: flex; flex-direction: column;
    }
    #shortcuts-modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px 16px; border-bottom: 1.5px solid var(--accent-light); }
    #shortcuts-modal-header h3 { font-family: 'Space Grotesk', sans-serif; font-size: 17px; font-weight: 700; color: var(--text-main); }
    #shortcuts-close { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 4px; border-radius: 50%; display: flex; align-items: center; transition: color var(--transition); }
    #shortcuts-close:hover { color: var(--accent); }
    #shortcuts-body { overflow-y: auto; padding: 16px 24px 24px; }
    .shortcut-group-title { font-family: 'Space Grotesk', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-secondary); margin: 16px 0 8px; }
    .shortcut-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(217,184,164,0.25); }
    .shortcut-row:last-child { border-bottom: none; }
    .shortcut-desc { font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--text-main); }
    .shortcut-keys { display: flex; gap: 4px; align-items: center; }
    kbd { display: inline-block; padding: 3px 8px; background: var(--bg-secondary); border: 1.5px solid var(--accent-light); border-radius: 5px; font-family: 'Space Grotesk', sans-serif; font-size: 11px; font-weight: 600; color: var(--text-main); box-shadow: 0 1px 0 var(--accent-light); }

    #shortcuts-hint { position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%); background: var(--bg-secondary); border: 1.5px solid var(--accent-light); border-radius: 8px; padding: 6px 14px; font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--text-secondary); z-index: 10; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    #shortcuts-hint.visible { opacity: 1; }
    #shortcuts-hint kbd { font-size: 10px; padding: 2px 5px; }

    /* ════════════════════════════════════════════════════════════
       SYNC MODAL
    ════════════════════════════════════════════════════════════ */
    #sync-modal { background: var(--bg-main); border: 1.5px solid var(--accent-light); border-radius: 16px; padding: 0; width: 460px; box-shadow: 0 20px 60px rgba(0,0,0,0.18); animation: modalIn 0.2s ease both; overflow: hidden; }
    #sync-modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px 16px; border-bottom: 1.5px solid var(--accent-light); }
    #sync-modal-header h3 { font-family: 'Space Grotesk', sans-serif; font-size: 17px; font-weight: 700; }
    #sync-close { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 4px; border-radius: 50%; display: flex; align-items: center; transition: color var(--transition); }
    #sync-close:hover { color: var(--accent); }
    .sync-body { padding: 24px; }
    .sync-section { margin-bottom: 24px; }
    .sync-section-title { font-family: 'Space Grotesk', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 12px; }
    .sync-btn { display: flex; align-items: center; gap: 10px; width: 100%; padding: 12px 16px; border: 1.5px solid var(--accent-light); border-radius: 10px; background: transparent; font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--text-main); cursor: pointer; transition: border-color var(--transition), background var(--transition); margin-bottom: 10px; }
    .sync-btn:hover { border-color: var(--accent); background: rgba(193,123,94,0.05); }
    .sync-btn svg { color: var(--accent); flex-shrink: 0; }
    .sync-btn-label { font-weight: 500; }
    .sync-btn-sub { font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--text-secondary); margin-top: 1px; }
    .sync-drop-zone { border: 2px dashed var(--accent-light); border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: all var(--transition); position: relative; }
    .sync-drop-zone:hover { border-color: var(--accent); background: rgba(193,123,94,0.03); }
    .sync-drop-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
    .sync-drop-zone p { font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--text-secondary); margin-top: 8px; }
    .sync-info { font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--text-secondary); padding: 10px 14px; background: rgba(193,123,94,0.06); border-radius: 8px; margin-top: 12px; line-height: 1.5; }

    /* ════════════════════════════════════════════════════════════
       RÉGLAGES (raccourcis personnalisables)
    ════════════════════════════════════════════════════════════ */
    #settings-modal {
      background: var(--bg-main);
      border: 1.5px solid var(--accent-light);
      border-radius: 16px;
      padding: 0;
      min-width: 520px; max-width: 600px;
      width: 100%;
      max-height: 85vh;
      display: flex; flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.18);
      animation: modalIn 0.2s ease both;
      overflow: hidden;
    }
    #settings-modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px 16px; border-bottom: 1.5px solid var(--accent-light); }
    #settings-modal-header h3 { font-family: 'Space Grotesk', sans-serif; font-size: 17px; font-weight: 700; }
    #settings-close { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 6px; border-radius: 50%; display: flex; align-items: center; }
    #settings-close:hover { color: var(--accent); }
    #settings-modal-body { overflow-y: auto; flex: 1; padding: 20px 24px; }

    /* ════════════════════════════════════════════════════════════
       MODAL ADD/EDIT (dossier, maquette, bloc)
    ════════════════════════════════════════════════════════════ */
    #modal {
      background: var(--bg-main);
      border: 1.5px solid var(--accent-light);
      border-radius: 14px;
      padding: 28px 28px 22px;
      min-width: 320px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
      animation: modalIn 0.2s ease both;
    }
    #modal h3 { font-family: 'Space Grotesk', sans-serif; font-size: 17px; font-weight: 600; margin-bottom: 16px; }
    #modal input, #modal select {
      width: 100%;
      padding: 10px 14px;
      border: 1.5px solid var(--accent-light);
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      background: var(--bg-main);
      color: var(--text-main);
      outline: none;
      transition: border-color var(--transition);
      margin-bottom: 12px;
      appearance: none;
    }
    #modal input:focus, #modal select:focus { border-color: var(--accent); }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 4px; }

    /* ════════════════════════════════════════════════════════════
       MODAL SÉLECTEUR DE SECTEUR (nouveau template)
    ════════════════════════════════════════════════════════════ */
    /* ← Prévu ici — sera utilisé en Phase 4
       Les classes sont déclarées maintenant pour ne pas bloquer la Phase 4 */
    #sector-picker-modal {
      background: var(--bg-main);
      border: 1.5px solid var(--accent-light);
      border-radius: 16px;
      padding: 0;
      width: 680px;
      max-height: 85vh;
      display: flex; flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.18);
      animation: modalIn 0.2s ease both;
      overflow: hidden;
    }
    #sector-picker-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px 16px; border-bottom: 1.5px solid var(--accent-light); flex-shrink: 0; }
    #sector-picker-header h3 { font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 700; color: var(--text-main); }
    #sector-picker-close { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 6px; border-radius: 50%; display: flex; align-items: center; }
    #sector-picker-close:hover { color: var(--accent); }
    #sector-picker-body { padding: 24px; overflow-y: auto; flex: 1; }
    #sector-picker-body p { font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5; }
    #sectors-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
    .sector-card {
      padding: 18px 16px;
      border: 1.5px solid var(--accent-light);
      border-radius: 10px;
      cursor: pointer;
      background: var(--bg-secondary);
      transition: border-color var(--transition), box-shadow var(--transition), transform var(--transition);
      text-align: center;
    }
    .sector-card:hover { border-color: var(--accent); box-shadow: 0 4px 16px rgba(193,123,94,0.15); transform: translateY(-2px); }
    .sector-card.selected { border-color: var(--accent); background: rgba(193,123,94,0.08); }
    .sector-icon { font-size: 28px; margin-bottom: 8px; }
    .sector-label { font-family: 'Space Grotesk', sans-serif; font-size: 13px; font-weight: 600; color: var(--text-main); }
    .sector-desc { font-family: 'DM Sans', sans-serif; font-size: 11px; color: var(--text-secondary); margin-top: 3px; line-height: 1.4; }
    #sector-picker-footer { padding: 16px 24px; border-top: 1.5px solid var(--accent-light); display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; }

    /* ════════════════════════════════════════════════════════════
       MODAL AJOUTER UNE SECTION (remplace bibliothèque autonome)
    ════════════════════════════════════════════════════════════ */
    #add-section-modal {
      background: var(--bg-main);
      border: 1.5px solid var(--accent-light);
      border-radius: 16px;
      padding: 0;
      width: 640px;
      max-height: 80vh;
      display: flex; flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.18);
      animation: modalIn 0.2s ease both;
      overflow: hidden;
    }
    #add-section-modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px 16px; border-bottom: 1.5px solid var(--accent-light); flex-shrink: 0; }
    #add-section-modal-header h3 { font-family: 'Space Grotesk', sans-serif; font-size: 17px; font-weight: 700; color: var(--text-main); }
    #add-section-close { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 6px; border-radius: 50%; display: flex; align-items: center; }
    #add-section-close:hover { color: var(--accent); }
    #add-section-body { overflow-y: auto; flex: 1; padding: 20px 24px; }
    #available-sections-list { display: flex; flex-direction: column; gap: 8px; }
    .avail-section-item {
      display: flex; align-items: center; gap: 14px;
      padding: 14px 16px;
      border: 1.5px solid var(--accent-light);
      border-radius: 10px;
      cursor: pointer;
      background: var(--bg-secondary);
      transition: border-color var(--transition), background var(--transition), transform var(--transition);
    }
    .avail-section-item:hover { border-color: var(--accent); background: rgba(193,123,94,0.05); transform: translateX(3px); }
    .avail-section-icon { font-size: 22px; flex-shrink: 0; }
    .avail-section-info { flex: 1; }
    .avail-section-name { font-family: 'Space Grotesk', sans-serif; font-size: 13px; font-weight: 600; color: var(--text-main); }
    .avail-section-desc { font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    .avail-section-add {
      background: var(--accent); color: white;
      border: none; border-radius: 6px;
      padding: 6px 14px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 12px; font-weight: 600;
      cursor: pointer;
      flex-shrink: 0;
      transition: opacity var(--transition);
    }
    .avail-section-add:hover { opacity: 0.88; }

    /* ════════════════════════════════════════════════════════════
       IMAGE UPLOADER GLOBAL (context menu)
    ════════════════════════════════════════════════════════════ */
    #dv-img-picker { position: fixed; left: -9999px; top: -9999px; opacity: 0; pointer-events: none; }
    .dv-img-ctx-menu {
      position: fixed;
      z-index: 600;
      background: var(--bg-main);
      border: 1.5px solid var(--accent-light);
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      padding: 6px;
      min-width: 160px;
      animation: fadeIn 0.15s ease both;
    }
    .dv-img-ctx-menu button { display: flex; align-items: center; gap: 8px; width: 100%; padding: 8px 12px; border: none; background: transparent; font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--text-main); cursor: pointer; border-radius: 6px; transition: background var(--transition); }
    .dv-img-ctx-menu button:hover { background: rgba(193,123,94,0.1); color: var(--accent); }
    .dv-img-ctx-menu button.danger:hover { background: rgba(231,76,60,0.1); color: var(--danger); }

    /* ════════════════════════════════════════════════════════════
       MODAL BASE (overlay)
    ════════════════════════════════════════════════════════════ */
    .modal-overlay-base {
      display: none;
      position: fixed; inset: 0;
      background: rgba(26,26,26,0.45);
      backdrop-filter: blur(4px);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay-base.visible { display: flex; }

    /* ════════════════════════════════════════════════════════════
       TOAST
    ════════════════════════════════════════════════════════════ */
    #toast {
      position: fixed;
      bottom: 28px; right: 28px;
      background: var(--text-main);
      color: white;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      padding: 10px 18px;
      border-radius: 8px;
      z-index: 500;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.25s, transform 0.25s;
      pointer-events: none;
    }
    #toast.show { opacity: 1; transform: translateY(0); }

    /* ════════════════════════════════════════════════════════════
       PLACEHOLDER PAGES
    ════════════════════════════════════════════════════════════ */
    .placeholder-page { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 12px; color: var(--text-secondary); }
    .placeholder-page h2 { font-family: 'Space Grotesk', sans-serif; font-size: 22px; color: var(--text-main); }
    .placeholder-page p { font-size: 14px; }

    /* ════════════════════════════════════════════════════════════
       SCROLLBAR
    ════════════════════════════════════════════════════════════ */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--accent-light); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

    /* ════════════════════════════════════════════════════════════
       ANIMATIONS
    ════════════════════════════════════════════════════════════ */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.96) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
  </style>
</head>
<body>

<!-- ═══════════════════════════════════════
     NAVBAR
═══════════════════════════════════════ -->
<div id="dv-app-root" style="display:none;flex:1;overflow:hidden;min-width:0;">
<nav id="navbar">
  <button class="nav-btn" id="toggle-btn" title="Réduire / Déployer">
    <span class="nav-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </span>
    <span class="nav-label">Menu</span>
  </button>

  <button class="nav-btn active" data-page="home" title="Accueil">
    <span class="nav-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9.5L12 3l9 6.5V20a1 1 0 01-1 1H4a1 1 0 01-1-1z"/><polyline points="9 21 9 12 15 12 15 21"/></svg>
    </span>
    <span class="nav-label">Accueil</span>
  </button>

  <button class="nav-btn" data-page="projects" title="Projets clients">
    <span class="nav-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
    </span>
    <span class="nav-label">Projets</span>
  </button>

  <div class="nav-spacer"></div>
  <div class="nav-divider"></div>

  <button class="nav-btn" id="sync-nav-btn" title="Synchronisation cloud">
    <span class="nav-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><polyline points="23 20 23 14 17 14"/><path d="M20.49 9A9 9 0 005.64 5.64L1 10M23 14l-4.64 4.36A9 9 0 013.51 15"/></svg>
    </span>
    <span class="nav-label">Sync cloud</span>
  </button>

  <button class="nav-btn" id="notes-nav-btn" title="Notes rapides">
    <span class="nav-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
    </span>
    <span class="nav-label">Notes</span>
  </button>

  <button class="nav-btn" id="shortcuts-nav-btn" title="Raccourcis clavier">
    <span class="nav-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 10h.01M10 10h.01M14 10h.01M18 10h.01M8 14h8"/></svg>
    </span>
    <span class="nav-label">Raccourcis</span>
  </button>

  <button class="nav-btn" id="settings-nav-btn" title="Réglages">
    <span class="nav-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
    </span>
    <span class="nav-label">Réglages</span>
  </button>
</nav>

<!-- ═══════════════════════════════════════
     MAIN
═══════════════════════════════════════ -->
<div id="main">

  <!-- TOPBAR -->
  <div id="topbar">
    <div id="search-wrap">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="search" placeholder="Rechercher un template, un projet…" autocomplete="off"/>
    </div>
    <div id="topbar-logo">DRAFTVAULT</div>
  </div>

  <!-- PAGE (contenu scrollable) -->
  <div id="page">

    <!-- ── HOME ── -->
    <div id="home-page">
      <div class="page-header">
        <button class="action-btn" id="add-folder-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Ajouter un dossier
        </button>
      </div>
      <div id="folders-grid"></div>
      <div id="empty-state" class="empty-state" style="display:none">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
        <p>Aucun dossier. Créez-en un pour commencer.</p>
      </div>
    </div>

    <!-- ── FOLDER DETAIL ── -->
    <div id="folder-detail-page">
      <div class="detail-header">
        <button class="back-btn" id="back-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
          Retour
        </button>
        <div class="detail-title" id="detail-title">Dossier</div>
        <span class="detail-subtitle" id="detail-subtitle"></span>
        <div class="detail-spacer"></div>
        <button class="action-btn" id="import-html-btn" title="Importer du HTML comme maquette">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
          Importer HTML
        </button>
        <button class="action-btn" id="add-template-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Ajouter une maquette
        </button>
      </div>
      <div id="templates-grid"></div>
      <div id="templates-empty" class="empty-state" style="display:none">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
        <p>Aucune maquette dans ce dossier.</p>
      </div>
    </div>

    <!-- ── PROJETS CLIENTS ── -->
    <div id="projects-page">
      <div class="projects-topbar">
        <h2 class="projects-title">Projets clients</h2>
        <button class="action-btn primary" id="add-client-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nouveau client
        </button>
      </div>
      <div id="projects-grid"></div>
      <div id="projects-empty" class="empty-state" style="display:none">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.3"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
        <p>Aucun client. Créez-en un pour commencer.</p>
      </div>
    </div>

    <!-- Client detail modal -->
    <div id="client-modal-overlay" class="modal-overlay-base">
      <div id="client-modal">
        <div id="client-modal-header">
          <div id="client-modal-title">Client</div>
          <button id="client-modal-close">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <div id="client-modal-body"></div>
      </div>
    </div>

  </div><!-- /page -->

  <!-- ═══════════════════════════════════════
       ÉDITEUR
  ═══════════════════════════════════════ -->
  <div id="editor-page">

    <!-- TOPBAR ÉDITEUR -->
    <div id="editor-topbar">
      <button id="editor-back-btn">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        Retour
      </button>
      <div>
        <div id="editor-template-name">—</div>
        <div id="editor-folder-name">—</div>
      </div>
      <div class="editor-topbar-spacer"></div>
      <span id="save-indicator">✓ Sauvegardé</span>
      <button id="export-pdf-btn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
        Export PDF
      </button>
      <button id="present-btn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        Présentation
      </button>
      <button id="save-btn">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Sauvegarder
      </button>
    </div>

    <!-- CORPS DE L'ÉDITEUR -->
    <div id="editor-body">

      <!-- PANNEAU GAUCHE -->
      <div id="editor-panel">
        <!-- Tabs -->
        <div class="panel-tabs">
          <div class="panel-tab active" data-ptab="perso">Style</div>
          <div class="panel-tab" data-ptab="sections">Sections</div>
          <div class="panel-tab" data-ptab="media">Médias</div>
        </div>

        <div id="panel-scroll">

          <!-- ── TAB STYLE ── -->
          <div class="panel-tab-content active" data-ptab-content="perso">

            <!-- Couleurs -->
            <div class="panel-section" id="sec-colors">
              <div class="panel-section-header">
                <span class="panel-section-title">Couleurs</span>
                <svg class="panel-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </div>
              <div class="panel-section-body">
                <div class="ctrl-row"><span class="ctrl-label">Principale</span><div class="color-swatch-wrap"><input type="color" id="c-primary" value="#C17B5E"/></div></div>
                <div class="ctrl-row"><span class="ctrl-label">Secondaire</span><div class="color-swatch-wrap"><input type="color" id="c-secondary" value="#F0EFEB"/></div></div>
                <div class="ctrl-row"><span class="ctrl-label">Accent</span><div class="color-swatch-wrap"><input type="color" id="c-accent" value="#D9B8A4"/></div></div>
                <div class="ctrl-row"><span class="ctrl-label">Texte</span><div class="color-swatch-wrap"><input type="color" id="c-text" value="#1A1A1A"/></div></div>
                <div class="ctrl-row"><span class="ctrl-label">Fond</span><div class="color-swatch-wrap"><input type="color" id="c-bg" value="#FFFFFF"/></div></div>
              </div>
            </div>

            <!-- Typographie -->
            <div class="panel-section" id="sec-typo">
              <div class="panel-section-header">
                <span class="panel-section-title">Typographie</span>
                <svg class="panel-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </div>
              <div class="panel-section-body">
                <div class="ctrl-row">
                  <span class="ctrl-label">Titres</span>
                  <select class="ctrl-select" id="t-heading">
                    <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
                    <option value="'Playfair Display', serif">Playfair Display</option>
                    <option value="'Space Grotesk', sans-serif">Space Grotesk</option>
                    <option value="'Montserrat', sans-serif">Montserrat</option>
                    <option value="'Raleway', sans-serif">Raleway</option>
                    <option value="'DM Serif Display', serif">DM Serif</option>
                    <option value="Georgia, serif">Georgia</option>
                  </select>
                </div>
                <div class="ctrl-row">
                  <span class="ctrl-label">Corps</span>
                  <select class="ctrl-select" id="t-body">
                    <option value="'DM Sans', sans-serif">DM Sans</option>
                    <option value="'Outfit', sans-serif">Outfit</option>
                    <option value="'Inter', sans-serif">Inter</option>
                    <option value="'Open Sans', sans-serif">Open Sans</option>
                    <option value="'Nunito', sans-serif">Nunito</option>
                    <option value="'Source Sans 3', sans-serif">Source Sans</option>
                  </select>
                </div>
                <div class="ctrl-row">
                  <span class="ctrl-label">Taille base</span>
                  <input type="range" class="ctrl-range" id="t-size" min="12" max="20" value="16" step="1"/>
                  <span class="ctrl-range-val" id="t-size-val">16px</span>
                </div>
                <div class="ctrl-row">
                  <span class="ctrl-label">Interligne</span>
                  <input type="range" class="ctrl-range" id="t-line" min="1.2" max="2.0" value="1.6" step="0.1"/>
                  <span class="ctrl-range-val" id="t-line-val">1.6</span>
                </div>
              </div>
            </div>

            <!-- Contenu global -->
            <div class="panel-section" id="sec-content">
              <div class="panel-section-header">
                <span class="panel-section-title">Contenu global</span>
                <svg class="panel-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </div>
              <div class="panel-section-body">
                <div class="ctrl-row" style="flex-direction:column;align-items:flex-start;gap:4px">
                  <span class="ctrl-label">Nom du client</span>
                  <input type="text" class="ctrl-input" id="cnt-name" placeholder="Ex: Le Botaniste" style="width:100%"/>
                </div>
                <div class="ctrl-row" style="flex-direction:column;align-items:flex-start;gap:4px;margin-top:4px">
                  <span class="ctrl-label">Slogan</span>
                  <input type="text" class="ctrl-input" id="cnt-tagline" placeholder="Ex: Cuisine du marché" style="width:100%"/>
                </div>
                <div class="ctrl-row" style="flex-direction:column;align-items:flex-start;gap:4px;margin-top:4px">
                  <span class="ctrl-label">Description</span>
                  <textarea class="ctrl-textarea" id="cnt-desc" placeholder="Texte de présentation…"></textarea>
                </div>
                <div class="ctrl-row" style="flex-direction:column;align-items:flex-start;gap:4px;margin-top:4px">
                  <span class="ctrl-label">Téléphone</span>
                  <input type="text" class="ctrl-input" id="cnt-phone" placeholder="06 00 00 00 00" style="width:100%"/>
                </div>
                <div class="ctrl-row" style="flex-direction:column;align-items:flex-start;gap:4px;margin-top:4px">
                  <span class="ctrl-label">Adresse</span>
                  <input type="text" class="ctrl-input" id="cnt-address" placeholder="12 rue de Paris, 75001" style="width:100%"/>
                </div>
                <div class="ctrl-row" style="flex-direction:column;align-items:flex-start;gap:4px;margin-top:4px">
                  <span class="ctrl-label">CTA principal</span>
                  <input type="text" class="ctrl-input" id="cnt-cta" placeholder="Réserver une table" style="width:100%"/>
                </div>
              </div>
            </div>

            <!-- Espacements & Mise en page -->
            <div class="panel-section" id="sec-spacing">
              <div class="panel-section-header">
                <span class="panel-section-title">Mise en page</span>
                <svg class="panel-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </div>
              <div class="panel-section-body">
                <div class="ctrl-row">
                  <span class="ctrl-label">Padding sections</span>
                  <input type="range" class="ctrl-range" id="s-padding" min="20" max="120" value="60" step="4"/>
                  <span class="ctrl-range-val" id="s-padding-val">60px</span>
                </div>
                <div class="ctrl-row">
                  <span class="ctrl-label">Border radius</span>
                  <input type="range" class="ctrl-range" id="s-radius" min="0" max="24" value="10" step="1"/>
                  <span class="ctrl-range-val" id="s-radius-val">10px</span>
                </div>
                <div class="ctrl-row">
                  <span class="ctrl-label">Largeur max</span>
                  <select class="ctrl-select" id="s-maxw">
                    <option value="960px">960px</option>
                    <option value="1100px" selected>1100px</option>
                    <option value="1200px">1200px</option>
                    <option value="1440px">1440px</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Composants -->
            <div class="panel-section" id="sec-components">
              <div class="panel-section-header">
                <span class="panel-section-title">Composants</span>
                <svg class="panel-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </div>
              <div class="panel-section-body">
                <div class="ctrl-row">
                  <span class="ctrl-label">Navbar</span>
                  <select class="ctrl-select" id="comp-navbar">
                    <option value="solid">Plein (couleur principale)</option>
                    <option value="border">Fond blanc + bordure</option>
                    <option value="transparent">Transparent (sur hero)</option>
                  </select>
                </div>
                <div class="ctrl-row">
                  <span class="ctrl-label">Hero</span>
                  <select class="ctrl-select" id="comp-hero">
                    <option value="image-right">Split (image droite)</option>
                    <option value="centered">Centré</option>
                    <option value="left">Texte gauche</option>
                  </select>
                </div>
                <div class="ctrl-row">
                  <span class="ctrl-label">Nb services</span>
                  <input type="range" class="ctrl-range" id="comp-services" min="2" max="6" value="3" step="1"/>
                  <span class="ctrl-range-val" id="comp-services-val">3</span>
                </div>
                <div class="ctrl-row">
                  <span class="ctrl-label">Contact</span>
                  <select class="ctrl-select" id="comp-contact">
                    <option value="yes">Afficher</option>
                    <option value="no">Masquer</option>
                  </select>
                </div>
                <div class="ctrl-row">
                  <span class="ctrl-label">Galerie</span>
                  <select class="ctrl-select" id="comp-gallery">
                    <option value="yes">Afficher</option>
                    <option value="no">Masquer</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Versions -->
            <div class="panel-section" id="sec-versions">
              <div class="panel-section-header">
                <span class="panel-section-title">Versions</span>
                <svg class="panel-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
              </div>
              <div class="panel-section-body" id="versions-list">
                <!-- Rendu JS -->
              </div>
            </div>

          </div><!-- /perso tab -->

          <!-- ── TAB SECTIONS ── -->
          <div class="panel-tab-content" data-ptab-content="sections" id="sections-tab-content">
            <div id="sections-list">
              <!-- Rendu JS : items D&D avec bouton édition -->
            </div>
            <button id="add-section-btn">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Ajouter une section
            </button>
          </div>

          <!-- ── TAB MÉDIAS ── -->
          <div class="panel-tab-content" data-ptab-content="media" id="media-tab-content">
            <div style="padding:12px;">
              <div style="font-family:'Space Grotesk',sans-serif;font-size:10px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-secondary);margin-bottom:10px;">Logo</div>
              <div class="logo-drop-zone" id="logo-drop-zone">
                <input type="file" id="logo-file-input" accept="image/*"/>
                <img class="logo-preview" id="logo-preview-img" alt="Logo"/>
                <div class="logo-placeholder">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                  Cliquer pour ajouter un logo
                </div>
              </div>
              <div style="font-family:'Space Grotesk',sans-serif;font-size:10px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-secondary);margin:14px 0 10px;">Galerie</div>
              <div class="media-grid" id="media-gallery-grid">
                <!-- Rendu JS -->
              </div>
            </div>
          </div>

        </div><!-- /panel-scroll -->
      </div><!-- /editor-panel -->

      <!-- SOUS-PANNEAU D'ÉDITION DE SECTION (glisse depuis le panneau gauche) -->
      <div id="section-subpanel">
        <div id="subpanel-header">
          <button id="subpanel-back" title="Retour aux sections">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
          </button>
          <div id="subpanel-title">Éditer la section</div>
        </div>
        <div id="subpanel-scroll">
          <!-- Rendu dynamiquement par renderSectionSubpanel() selon le type de section -->
        </div>
        <button id="subpanel-apply">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
          Appliquer
        </button>
      </div>

      <!-- APERÇU IFRAME -->
      <div id="editor-preview">
        <div id="preview-toolbar">
          <button class="device-btn active" data-device="desktop">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
            Bureau
          </button>
          <button class="device-btn" data-device="tablet">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
            Tablette
          </button>
          <button class="device-btn" data-device="mobile">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
            Mobile
          </button>
          <div style="flex:1;"></div>
          <button id="toggle-panel-btn" style="display:flex;align-items:center;gap:5px;padding:5px 10px;border:1.5px solid transparent;border-radius:6px;background:transparent;font-family:'DM Sans',sans-serif;font-size:12px;color:var(--text-secondary);cursor:pointer;transition:all var(--transition);" title="Afficher/masquer le panneau">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
          </button>
          <button id="info-btn" style="display:flex;align-items:center;gap:5px;padding:5px 10px;border:1.5px solid transparent;border-radius:6px;background:transparent;font-family:'DM Sans',sans-serif;font-size:12px;color:var(--text-secondary);cursor:pointer;transition:all var(--transition);" title="Infos maquette, devis, tags">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
            Infos
          </button>
        </div>
        <div id="preview-frame-wrap">
          <div id="preview-scale-wrap">
            <div id="preview-iframe-container">
              <iframe id="preview-iframe" title="Aperçu maquette"></iframe>
            </div>
          </div>
        </div>
      </div><!-- /editor-preview -->

    </div><!-- /editor-body -->
  </div><!-- /editor-page -->

</div><!-- /main -->
</div><!-- /dv-app-root -->


<!-- ═══════════════════════════════════════
     PANNEAU INFO MAQUETTE (drawer droit)
═══════════════════════════════════════ -->
<div id="info-drawer-overlay"></div>
<div id="info-drawer">
  <div id="info-drawer-header">
    <div>
      <div id="info-drawer-title">Infos maquette</div>
      <div id="info-drawer-folder"></div>
    </div>
    <button id="info-drawer-close">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="drawer-tabs">
    <div class="drawer-tab active" data-dtab="info">Infos</div>
    <div class="drawer-tab" data-dtab="tags">Tags</div>
    <div class="drawer-tab" data-dtab="devis">Devis</div>
    <div class="drawer-tab" data-dtab="history">Historique</div>
  </div>
  <div id="info-drawer-body">
    <div class="drawer-tab-content active" id="dtab-info">
      <div class="info-field">
        <label>Nom de la maquette</label>
        <input type="text" id="info-tpl-name" placeholder="Nom…"/>
      </div>
      <div class="info-field">
        <label>Client associé</label>
        <input type="text" id="info-client-name" placeholder="Nom du client…"/>
      </div>
      <div class="info-field">
        <label>Statut</label>
        <select id="info-status">
          <option value="draft">Brouillon</option>
          <option value="review">En révision</option>
          <option value="sent">Envoyé</option>
          <option value="accepted">Accepté</option>
        </select>
      </div>
      <div class="info-field">
        <label>Notes internes</label>
        <textarea id="info-notes" placeholder="Notes pour vous-même…"></textarea>
      </div>
      <button class="drawer-save-btn" id="info-save-btn">Enregistrer</button>
    </div>
    <div class="drawer-tab-content" id="dtab-tags">
      <div class="info-field">
        <label>Tags</label>
        <div class="tags-wrap" id="tags-wrap"></div>
        <div class="tag-input-row">
          <input type="text" id="tag-input" placeholder="Nouveau tag…"/>
          <button id="tag-add-btn">Ajouter</button>
        </div>
      </div>
    </div>
    <div class="drawer-tab-content" id="dtab-devis">
      <div id="devis-body"></div>
    </div>
    <div class="drawer-tab-content" id="dtab-history">
      <div id="history-body"></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════
     NOTES (panneau flottant)
═══════════════════════════════════════ -->
<div id="notes-overlay"></div>
<div id="notes-panel">
  <div id="notes-header">
    <div id="notes-header-title">Notes rapides</div>
    <div class="notes-header-actions">
      <button id="new-note-btn">+ Nouvelle note</button>
      <button id="notes-close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
  </div>
  <div id="notes-body">
    <div id="notes-list"></div>
    <div id="note-editor">
      <div class="note-empty-state" id="note-empty-hint">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.3"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        <span>Sélectionnez ou créez une note</span>
      </div>
      <input type="text" id="note-title-input" placeholder="Titre de la note…" style="display:none"/>
      <textarea id="note-content-input" placeholder="Votre note…" style="display:none"></textarea>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════
     RACCOURCIS CLAVIER (modale info)
═══════════════════════════════════════ -->
<div id="shortcuts-overlay" class="modal-overlay-base">
  <div id="shortcuts-modal">
    <div id="shortcuts-modal-header">
      <h3>Raccourcis clavier</h3>
      <button id="shortcuts-close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div id="shortcuts-body">
      <!-- Rendu JS -->
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════
     RÉGLAGES (raccourcis personnalisables)
═══════════════════════════════════════ -->
<div id="settings-overlay" class="modal-overlay-base">
  <div id="settings-modal">
    <div id="settings-modal-header">
      <h3>Réglages — Raccourcis clavier</h3>
      <button id="settings-close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div id="settings-modal-body">
      <div style="font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text-secondary);margin-bottom:18px;line-height:1.5;">
        Personnalisez vos raccourcis. Cliquez sur un champ et appuyez sur la combinaison souhaitée.
      </div>
      <div id="shortcuts-editor-list"></div>
      <div style="display:flex;gap:10px;margin-top:20px;">
        <button class="btn-secondary" id="shortcuts-reset-btn">Réinitialiser les défauts</button>
        <button class="btn-primary" id="shortcuts-save-btn">Sauvegarder</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════
     SYNC MODAL
═══════════════════════════════════════ -->
<div id="sync-overlay" class="modal-overlay-base">
  <div id="sync-modal">
    <div id="sync-modal-header">
      <h3>Synchronisation cloud</h3>
      <button id="sync-close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="sync-body">
      <div class="sync-section">
        <div class="sync-section-title">Exporter</div>
        <button class="sync-btn" id="sync-export-all">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          <div>
            <div class="sync-btn-label">Tout exporter (JSON)</div>
            <div class="sync-btn-sub">Dossiers, maquettes, configs, clients, notes</div>
          </div>
        </button>
        <button class="sync-btn" id="sync-export-configs">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          <div>
            <div class="sync-btn-label">Exporter les configs éditeur</div>
            <div class="sync-btn-sub">Couleurs, typographies, contenus</div>
          </div>
        </button>
      </div>
      <div class="sync-section">
        <div class="sync-section-title">Importer</div>
        <div class="sync-drop-zone" id="sync-import-zone">
          <input type="file" id="sync-import-file" accept=".json"/>
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin:0 auto;opacity:0.4;display:block"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          <p>Glissez un fichier JSON ici ou cliquez pour parcourir</p>
        </div>
        <div class="sync-info">⚠️ L'import <strong>remplace</strong> les données existantes. Faites une sauvegarde avant.</div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════
     MODAL ADD (dossier / maquette)
═══════════════════════════════════════ -->
<div id="modal-overlay" class="modal-overlay-base">
  <div id="modal">
    <h3 id="modal-title">Nouveau dossier</h3>
    <input type="text" id="modal-input" placeholder="Nom…"/>
    <select id="modal-sector" style="display:none">
      <option value="">Choisir un secteur…</option>
      <!-- Options injectées dynamiquement — Phase 2 -->
    </select>
    <div class="modal-actions">
      <button class="btn-secondary" id="modal-cancel">Annuler</button>
      <button class="btn-primary" id="modal-confirm">Créer</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════
     MODAL SÉLECTEUR DE SECTEUR
     (ouvert lors de la création d'un template)
═══════════════════════════════════════ -->
<div id="sector-picker-overlay" class="modal-overlay-base">
  <div id="sector-picker-modal">
    <div id="sector-picker-header">
      <h3>Choisir un point de départ</h3>
      <button id="sector-picker-close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div id="sector-picker-body">
      <p>Sélectionnez le secteur d'activité de votre client. Le template généré sera adapté au contexte, au vocabulaire et à la structure de ce secteur.</p>
      <div id="sectors-grid">
        <!-- Rendu JS — Phase 2 -->
      </div>
    </div>
    <div id="sector-picker-footer">
      <button class="btn-secondary" id="sector-picker-cancel">Annuler</button>
      <button class="btn-primary" id="sector-picker-confirm">Créer la maquette</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════
     MODAL AJOUTER UNE SECTION
     (remplace la bibliothèque autonome)
═══════════════════════════════════════ -->
<div id="add-section-overlay" class="modal-overlay-base">
  <div id="add-section-modal">
    <div id="add-section-modal-header">
      <h3>Ajouter une section</h3>
      <button id="add-section-close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div id="add-section-body">
      <div id="available-sections-list">
        <!-- Rendu JS — Phase 3 -->
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════
     IMPORT HTML MODAL
═══════════════════════════════════════ -->
<div id="import-html-overlay" class="modal-overlay-base">
  <div style="background:var(--bg-main);border:1.5px solid var(--accent-light);border-radius:16px;padding:0;width:600px;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.18);animation:modalIn .2s ease both;overflow:hidden;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:20px 24px 16px;border-bottom:1.5px solid var(--accent-light);">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:17px;font-weight:700;">Importer du HTML</div>
      <button id="import-html-close" style="background:none;border:none;cursor:pointer;color:var(--text-secondary);padding:6px;border-radius:50%;display:flex;align-items:center;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div style="padding:20px 24px;flex:1;overflow-y:auto;">
      <div style="font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text-secondary);margin-bottom:16px;line-height:1.5;">
        Collez votre code HTML ci-dessous. Il sera utilisé comme base de la maquette et pourra être édité directement dans l'aperçu.
      </div>
      <div style="margin-bottom:12px;">
        <label style="display:block;font-family:'Space Grotesk',sans-serif;font-size:10px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-secondary);margin-bottom:6px;">Nom de la maquette</label>
        <input type="text" id="import-html-name" placeholder="Ex: Landing Page v1" style="width:100%;padding:9px 12px;border:1.5px solid var(--accent-light);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:14px;background:var(--bg-main);color:var(--text-main);outline:none;"/>
      </div>
      <div>
        <label style="display:block;font-family:'Space Grotesk',sans-serif;font-size:10px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-secondary);margin-bottom:6px;">Code HTML</label>
        <textarea id="import-html-code" placeholder="<!DOCTYPE html>…" style="width:100%;height:220px;padding:12px;border:1.5px solid var(--accent-light);border-radius:8px;font-family:monospace;font-size:12px;background:var(--bg-secondary);color:var(--text-main);outline:none;resize:vertical;line-height:1.5;"></textarea>
      </div>
    </div>
    <div style="padding:16px 24px;border-top:1.5px solid var(--accent-light);display:flex;gap:10px;justify-content:flex-end;">
      <button class="btn-secondary" id="import-html-cancel">Annuler</button>
      <button class="btn-primary" id="import-html-confirm">Importer</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════
     IMAGE UPLOADER GLOBAL
═══════════════════════════════════════ -->
<input type="file" id="dv-img-picker" accept="image/*"/>
<div id="dv-img-ctx-menu" class="dv-img-ctx-menu" style="display:none;">
  <button id="dv-ctx-change">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
    Changer l'image
  </button>
  <button id="dv-ctx-delete" class="danger">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>
    Supprimer l'image
  </button>
</div>

<!-- TOAST -->
<div id="toast"></div>
<div id="shortcuts-hint"></div>

<script>

/* ════════════════════════════════════════════════════════════
   CONFIG & DONNÉES
════════════════════════════════════════════════════════════ */

/* ── Firebase DB wrapper (remplace localStorage) ── */
const LS = {
  get: (k, d) => {
    if (!window._dvReady) return d;
    if (k==='dv_folders')   return state.folders         ??d;
    if (k==='dv_templates') return state.templates        ??d;
    if (k==='dv_configs')   return state.templateConfigs  ??d;
    if (k==='dv_meta')      return state.templateMeta     ??d;
    if (k==='dv_clients')   return state.clients          ??d;
    if (k==='dv_notes')     return state.notes            ??d;
    if (k==='dv_versions')  return state.versions         ??d;
    if (k==='dv_nextId')    return state.nextId           ??d;
    if (k==='dv_shortcuts') return window._dvSC??d;
    if (k==='dv_onboarding_done') return window._dvOB??d;
    if (k.startsWith('dv_imported_html_')) return (window._dvIH||{})[k]??d;
    return d;
  },
  set: (k, v) => {
    if (k==='dv_shortcuts') window._dvSC=v;
    if (k==='dv_onboarding_done') window._dvOB=v;
    if (k.startsWith('dv_imported_html_')) { window._dvIH=window._dvIH||{}; window._dvIH[k]=v; }
    if (window._dvDB) window._dvDB.set(k,v);
  }
};
window._dvSC=null; window._dvOB=false; window._dvIH={}; window._dvReady=false;

/* ── Escape HTML ── */
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* ── Sections par défaut ── */
const DEFAULT_SECTIONS = [
  { id:'nav',          label:'Navigation',      visible:true },
  { id:'hero',         label:'Hero',            visible:true },
  { id:'services',     label:'Services / Atouts',visible:true },
  { id:'gallery',      label:'Galerie',         visible:true },
  { id:'cta',          label:'Carte / CTA',     visible:true },
  { id:'testimonials', label:'Témoignages',     visible:false },
  { id:'pricing',      label:'Tarifs',          visible:false },
  { id:'faq',          label:'FAQ',             visible:false },
  { id:'contact',      label:'Contact',         visible:true },
  { id:'footer',       label:'Footer',          visible:true },
];

/* ── Sections disponibles à l'ajout (remplace bibliothèque) ── */
const AVAILABLE_SECTIONS = [
  { id:'testimonials', label:'Témoignages',  icon:'⭐', desc:'Avis clients avec étoiles et citations' },
  { id:'pricing',      label:'Tarifs',       icon:'💰', desc:'Grille de tarifs ou forfaits' },
  { id:'faq',          label:'FAQ',          icon:'❓', desc:'Questions fréquentes en accordéon' },
  { id:'team',         label:'Équipe',       icon:'👥', desc:'Présentation des membres de l\'équipe' },
];

/* ── Définitions des champs éditables par section ── */
const SECTION_DEFINITIONS = {
  nav: {
    label: 'Navigation',
    fields: [
      { key:'navItems',  type:'text',   label:'Liens nav (séparés par ;)', placeholder:'Accueil;Services;Galerie;Contact' },
      { key:'navCta',    type:'text',   label:'Bouton CTA nav',            placeholder:'Réserver' },
    ]
  },
  hero: {
    label: 'Hero',
    fields: [
      { key:'heroTitle',    type:'text',     label:'Titre principal',  placeholder:'Nom ou accroche' },
      { key:'heroTagline',  type:'text',     label:'Sous-titre / badge', placeholder:'Votre slogan' },
      { key:'heroDesc',     type:'textarea', label:'Description',      placeholder:'Présentation courte…' },
      { key:'heroCta',      type:'text',     label:'Texte CTA bouton', placeholder:'Réserver maintenant' },
      { key:'heroImg',      type:'image',    label:'Image hero',       imageId:'hero' },
    ]
  },
  services: {
    label: 'Services / Atouts',
    fields: [
      { key:'servicesTitle',  type:'text',    label:'Titre section',    placeholder:'Une expérience unique' },
      { key:'servicesLabel',  type:'text',    label:'Label au-dessus',  placeholder:'Pourquoi nous choisir' },
      { key:'servicesDesc',   type:'textarea',label:'Sous-titre',       placeholder:'Description courte…' },
      { key:'nbServices',     type:'counter', label:'Nombre de cartes', min:2, max:6 },
    ]
  },
  gallery: {
    label: 'Galerie',
    fields: [
      { key:'galleryTitle',   type:'text',  label:'Titre section',      placeholder:'La galerie' },
      { key:'galleryLabel',   type:'text',  label:'Label au-dessus',    placeholder:'Notre cuisine en images' },
      { key:'galleryLinkText',type:'text',  label:'Texte lien "voir tout"', placeholder:'Voir toutes les photos' },
    ]
  },
  cta: {
    label: 'Carte / CTA',
    fields: [
      { key:'ctaTitle',  type:'text',    label:'Titre section',   placeholder:'Notre carte' },
      { key:'ctaLabel',  type:'text',    label:'Label au-dessus', placeholder:'Sélection du chef' },
      { key:'ctaDesc',   type:'textarea',label:'Description',     placeholder:'Formules déjeuner…' },
    ]
  },
  testimonials: {
    label: 'Témoignages',
    fields: [
      { key:'testTitle',   type:'text',    label:'Titre section',   placeholder:'Ce que disent nos clients' },
      { key:'testLabel',   type:'text',    label:'Label au-dessus', placeholder:'Avis clients' },
      { key:'nbTestimonials', type:'counter', label:'Nombre de témoignages', min:1, max:6 },
    ]
  },
  pricing: {
    label: 'Tarifs',
    fields: [
      { key:'pricingTitle',type:'text',    label:'Titre section',   placeholder:'Nos formules' },
      { key:'pricingLabel',type:'text',    label:'Label au-dessus', placeholder:'Tarifs' },
      { key:'pricingDesc', type:'textarea',label:'Description',     placeholder:'Choisissez la formule…' },
    ]
  },
  faq: {
    label: 'FAQ',
    fields: [
      { key:'faqTitle',  type:'text',    label:'Titre section',   placeholder:'Questions fréquentes' },
      { key:'faqLabel',  type:'text',    label:'Label au-dessus', placeholder:'FAQ' },
      { key:'nbFaq',     type:'counter', label:'Nombre de questions', min:3, max:10 },
    ]
  },
  contact: {
    label: 'Contact',
    fields: [
      { key:'contactTitle', type:'text',    label:'Titre section',   placeholder:'Réserver une table' },
      { key:'contactLabel', type:'text',    label:'Label au-dessus', placeholder:'Venez nous rendre visite' },
      { key:'contactHours', type:'text',    label:'Horaires',        placeholder:'Mar–Sam : 12h–14h30 · 19h–22h30' },
    ]
  },
  footer: {
    label: 'Footer',
    fields: [
      { key:'footerDesc', type:'textarea', label:'Texte pied de page', placeholder:'Une courte description…' },
      { key:'footerLinks',type:'text',     label:'Liens footer (;)', placeholder:'Mentions;Confidentialité' },
    ]
  },
};

/* ════════════════════════════════════════════════════════════
   SECTOR TEMPLATES
   Structure : { label, emoji, defaults:{}, sectionData:{} }
   — defaults  : valeurs pré-remplies pour les champs globaux (cfg)
   — sectionData : valeurs pré-remplies pour les champs par section
   Les templates seront complétés progressivement.
   Les 8 secteurs sont déclarés ici ; seul "restaurant" est complet.
   Les autres partagent la même structure HTML mais avec des textes adaptés.
════════════════════════════════════════════════════════════ */
const SECTOR_TEMPLATES = {

  restaurant: {
    label: 'Restaurant / Café',
    emoji: '🍽️',
    desc:  'Bistrot, brasserie, gastronomique, café…',
    defaultConfig: {
      cPrimary:'#2D6A4F', cSecondary:'#F8F4EF', cAccent:'#D4A574',
      cText:'#1C1C1C', cBg:'#FDFAF6',
      tHeading:"'Cormorant Garamond', serif", tBody:"'Outfit', sans-serif",
      tSize:16, tLine:1.65, sPadding:64, sRadius:10, sMaxw:'1100px',
      compNavbar:'solid', compHero:'image-right', compServices:3,
      compContact:'yes', compGallery:'yes',
      cntName:'Le Botaniste', cntTagline:'Cuisine du marché & Saveurs d\'ici',
      cntDesc:'Une table où les produits locaux deviennent poésie. Chaque assiette raconte une saison, chaque recette une rencontre.',
      cntPhone:'01 23 45 67 89', cntAddress:'12 rue du Marché, 75011 Paris', cntCta:'Réserver une table',
    },
    sectionData: {
      nav:      { navItems:'La Carte;Formules;Galerie;Réservation', navCta:'Réserver' },
      hero:     { heroTitle:'', heroTagline:'', heroDesc:'', heroCta:'' },
      services: { servicesTitle:'Une expérience unique', servicesLabel:'Pourquoi nous choisir', servicesDesc:'De la salle à la cuisine, chaque détail est pensé pour vous.', nbServices:3 },
      gallery:  { galleryTitle:'La galerie', galleryLabel:'Notre cuisine en images', galleryLinkText:'Voir toutes les photos' },
      cta:      { ctaTitle:'Notre carte', ctaLabel:'Sélection du chef', ctaDesc:'Formules déjeuner dès 24€ · Menu dégustation 58€' },
      contact:  { contactTitle:'Réserver une table', contactLabel:'Venez nous rendre visite', contactHours:'Mar–Sam : 12h–14h30 · 19h–22h30' },
      footer:   { footerDesc:'', footerLinks:'Mentions légales;Politique de confidentialité' },
    },
    itemLabels: {
      services: ['Produits locaux','Vins naturels','Chef étoilé','Terrasse','Privatisation','Brunch'],
      servicesDesc: [
        'Fruits, légumes et viandes sourcés en circuit court, directement chez nos producteurs.',
        'Une cave soigneusement sélectionnée, entre biodynamie et découvertes de petits domaines.',
        'Notre chef, passé par les grandes maisons, sublime chaque ingrédient avec délicatesse.',
        'Une terrasse ombragée pour les beaux jours, idéale pour déjeuner en plein air.',
        'Réservez l\'espace entier pour vos événements privés, mariages et soirées d\'entreprise.',
        'Chaque dimanche, retrouvez notre brunch gourmand avec buffet salé-sucré sans gluten.',
      ],
      navItems: ['La Carte','Formules','Galerie','Réservation'],
      ctaItems: [
        { nom:'Entrée du marché',   desc:'Selon arrivage du jour, tomates anciennes, burrata crémeuse', prix:'14€' },
        { nom:'Filet de bar rôti',  desc:'Fenouil braisé, citron confit, émulsion de persil plat',     prix:'28€' },
        { nom:'Tarte au citron',    desc:'Crème légère yuzu, meringue soufflée, zestes frais',          prix:'11€' },
      ],
    }
  },

  beaute: {
    label: 'Beauté / Coiffure',
    emoji: '💅',
    desc:  'Salon de coiffure, esthétique, spa, nail art…',
    defaultConfig: {
      cPrimary:'#9B6B8A', cSecondary:'#FDF6F9', cAccent:'#E8B4CC',
      cText:'#2A1A24', cBg:'#FFFBFD',
      tHeading:"'Playfair Display', serif", tBody:"'DM Sans', sans-serif",
      tSize:16, tLine:1.65, sPadding:64, sRadius:14, sMaxw:'1100px',
      compNavbar:'border', compHero:'centered', compServices:4,
      compContact:'yes', compGallery:'yes',
      cntName:'Studio Belle', cntTagline:'L\'art de prendre soin de soi',
      cntDesc:'Un espace dédié à votre bien-être et à votre beauté. Nos expertes vous accueillent dans un cadre chaleureux pour sublimer votre style.',
      cntPhone:'01 23 45 67 89', cntAddress:'24 rue de la Paix, 75002 Paris', cntCta:'Prendre rendez-vous',
    },
    sectionData: {
      nav:      { navItems:'Services;Tarifs;Galerie;Contact', navCta:'Rendez-vous' },
      services: { servicesTitle:'Notre savoir-faire', servicesLabel:'Nos spécialités', servicesDesc:'Des soins personnalisés pour mettre en valeur votre beauté naturelle.', nbServices:4 },
      gallery:  { galleryTitle:'Nos créations', galleryLabel:'Inspirations & réalisations', galleryLinkText:'Voir le portfolio' },
      cta:      { ctaTitle:'Nos prestations', ctaLabel:'Menu beauté', ctaDesc:'Forfaits à partir de 35€' },
      contact:  { contactTitle:'Prendre rendez-vous', contactLabel:'On vous attend', contactHours:'Lun–Sam : 9h–19h · Dim : sur RDV' },
    },
    itemLabels: {
      services: ['Coupe & Coiffage','Coloration','Soins du visage','Manucure','Épilation','Maquillage'],
      servicesDesc: [
        'Coupe femme, homme ou enfant. Brushing et mise en forme inclus sur demande.',
        'Balayage, ombré, teinture ou couleur fantaisie. Produits respectueux de la fibre capillaire.',
        'Nettoyage de peau, hydratation intense, anti-âge. Protocoles personnalisés selon votre type de peau.',
        'Pose de vernis semi-permanent, nail art, extension d\'ongles. Mains et pieds soignés.',
        'Épilation à la cire chaude ou froide. Résultats durables, peau douce garantie.',
        'Maquillage de jour ou de soirée, cours de maquillage. Mise en beauté pour occasions spéciales.',
      ],
      navItems: ['Services','Tarifs','Galerie','Contact'],
      ctaItems: [
        { nom:'Formule Éclat',   desc:'Coupe + couleur + soin + brushing', prix:'95€' },
        { nom:'Mini soin visage',desc:'Nettoyage + masque + hydratation',  prix:'45€' },
        { nom:'Manucure express',desc:'Vernis semi-permanent',             prix:'35€' },
      ],
    }
  },

  medical: {
    label: 'Médical / Bien-être',
    emoji: '🏥',
    desc:  'Cabinet médical, ostéo, kiné, psychologue, naturopathe…',
    defaultConfig: {
      cPrimary:'#1A6B8A', cSecondary:'#F0F7FA', cAccent:'#7EC8D8',
      cText:'#0E2C38', cBg:'#F8FCFE',
      tHeading:"'Space Grotesk', sans-serif", tBody:"'DM Sans', sans-serif",
      tSize:16, tLine:1.7, sPadding:64, sRadius:10, sMaxw:'1060px',
      compNavbar:'border', compHero:'centered', compServices:3,
      compContact:'yes', compGallery:'no',
      cntName:'Cabinet Santé', cntTagline:'Votre santé, notre priorité',
      cntDesc:'Un accompagnement bienveillant et professionnel pour prendre soin de vous. Consultations sur rendez-vous.',
      cntPhone:'01 23 45 67 89', cntAddress:'8 avenue de la Santé, 75014 Paris', cntCta:'Prendre rendez-vous',
    },
    sectionData: {
      nav:      { navItems:'Accueil;Spécialités;L\'équipe;Contact', navCta:'Rendez-vous' },
      services: { servicesTitle:'Nos spécialités', servicesLabel:'Ce que nous proposons', servicesDesc:'Des soins adaptés à chaque patient, dans un cadre rassurant.', nbServices:3 },
      contact:  { contactTitle:'Prendre rendez-vous', contactLabel:'Nous consulter', contactHours:'Lun–Ven : 8h–19h · Sam : 9h–13h' },
    },
    itemLabels: {
      services: ['Consultation générale','Suivi chronique','Prévention & bilan','Urgences du jour','Téléconsultation','Suivi pédiatrique'],
      servicesDesc: [
        'Diagnostic, ordonnances, certificats médicaux. Prise en charge Sécurité sociale.',
        'Accompagnement sur le long terme pour diabète, hypertension, pathologies chroniques.',
        'Bilan de santé complet, dépistage, vaccinations et conseils nutritionnels.',
        'Créneaux réservés aux urgences du cabinet. Appelez avant de vous déplacer.',
        'Consultation à distance par vidéo pour les non-déplaçables. Ordonnances dématérialisées.',
        'Suivi de la croissance, vaccins enfants, certificats scolaires.',
      ],
      navItems: ['Accueil','Spécialités','L\'équipe','Contact'],
      ctaItems: [
        { nom:'Consultation standard', desc:'30 min · Prise en charge SS', prix:'25€' },
        { nom:'Bilan de prévention',   desc:'1h · Bilan complet',         prix:'60€' },
        { nom:'Téléconsultation',      desc:'20 min · Ordonnance incluse', prix:'25€' },
      ],
    }
  },

  artisan: {
    label: 'Artisan / BTP',
    emoji: '🔨',
    desc:  'Plombier, électricien, maçon, peintre, menuisier…',
    defaultConfig: {
      cPrimary:'#D4430A', cSecondary:'#F5F2EE', cAccent:'#E8A87C',
      cText:'#1A1108', cBg:'#FEFCF9',
      tHeading:"'Space Grotesk', sans-serif", tBody:"'DM Sans', sans-serif",
      tSize:16, tLine:1.6, sPadding:60, sRadius:8, sMaxw:'1100px',
      compNavbar:'solid', compHero:'left', compServices:3,
      compContact:'yes', compGallery:'yes',
      cntName:'Pro Réno', cntTagline:'Artisans de confiance depuis 2005',
      cntDesc:'Devis gratuit sous 24h. Travaux soignés, délais tenus, garantie décennale. Votre satisfaction, notre fierté.',
      cntPhone:'06 00 00 00 00', cntAddress:'Zone artisanale, 77000 Melun', cntCta:'Devis gratuit',
    },
    sectionData: {
      nav:      { navItems:'Accueil;Nos métiers;Réalisations;Contact', navCta:'Devis gratuit' },
      services: { servicesTitle:'Nos savoir-faire', servicesLabel:'Nos métiers', servicesDesc:'Intervention rapide, travaux garantis, prix transparents.', nbServices:3 },
      gallery:  { galleryTitle:'Nos réalisations', galleryLabel:'Avant / Après', galleryLinkText:'Voir tous les chantiers' },
      cta:      { ctaTitle:'Nos prestations', ctaLabel:'Tarifs & devis', ctaDesc:'Devis gratuit et sans engagement sous 24h' },
      contact:  { contactTitle:'Demander un devis', contactLabel:'Contactez-nous', contactHours:'Lun–Sam : 7h–19h · Urgences 24h/24' },
    },
    itemLabels: {
      services: ['Plomberie','Électricité','Maçonnerie','Peinture','Menuiserie','Carrelage'],
      servicesDesc: [
        'Installation, réparation, dépannage. Eau chaude, sanitaires, chauffage central.',
        'Tableaux électriques, prises, éclairage. Mise aux normes NFC 15-100.',
        'Crépi, enduit, isolation, montage de cloisons. Travaux neufs et rénovation.',
        'Peinture intérieure et extérieure, papier peint, revêtements décoratifs.',
        'Portes, fenêtres, parquet, escaliers. Bois massif et dérivés sur mesure.',
        'Pose de carrelage sol et mur, faïence, mosaïque. Joints et finitions.',
      ],
      navItems: ['Accueil','Nos métiers','Réalisations','Contact'],
      ctaItems: [
        { nom:'Dépannage urgent',  desc:'Intervention sous 2h, devis sur place', prix:'Sur devis' },
        { nom:'Rénovation complète',desc:'Gestion clé en main, devis détaillé',   prix:'Sur devis' },
        { nom:'Entretien annuel',  desc:'Contrat de maintenance et vérification', prix:'À partir de 99€/an' },
      ],
    }
  },

  juridique: {
    label: 'Avocat / Conseil',
    emoji: '⚖️',
    desc:  'Avocat, notaire, expert-comptable, consultant…',
    defaultConfig: {
      cPrimary:'#1A3A5C', cSecondary:'#F4F6F9', cAccent:'#8EACC8',
      cText:'#0A1929', cBg:'#F8FAFC',
      tHeading:"'Playfair Display', serif", tBody:"'DM Sans', sans-serif",
      tSize:16, tLine:1.7, sPadding:64, sRadius:6, sMaxw:'1060px',
      compNavbar:'border', compHero:'centered', compServices:3,
      compContact:'yes', compGallery:'no',
      cntName:'Cabinet Dupont & Associés', cntTagline:'Expertise juridique à votre service',
      cntDesc:'Nous défendons vos intérêts avec rigueur et discrétion. Consultations en présentiel ou par visioconférence.',
      cntPhone:'01 44 00 00 00', cntAddress:'42 rue de Rivoli, 75004 Paris', cntCta:'Prendre contact',
    },
    sectionData: {
      nav:      { navItems:'Domaines;L\'équipe;Honoraires;Contact', navCta:'Consulter' },
      services: { servicesTitle:'Nos domaines d\'intervention', servicesLabel:'Expertise', servicesDesc:'Une équipe pluridisciplinaire pour tous vos besoins juridiques.', nbServices:3 },
      contact:  { contactTitle:'Demander une consultation', contactLabel:'Nous contacter', contactHours:'Lun–Ven : 9h–18h' },
    },
    itemLabels: {
      services: ['Droit des affaires','Droit de la famille','Droit immobilier','Droit du travail','Droit pénal','Contentieux'],
      servicesDesc: [
        'Création de sociétés, contrats commerciaux, fusions-acquisitions, litiges entre associés.',
        'Divorce, garde d\'enfants, succession, adoption, protection des majeurs.',
        'Achat-vente, baux, copropriété, permis de construire, litiges voisinage.',
        'Contrats de travail, licenciements, prud\'hommes, accords d\'entreprise.',
        'Défense pénale, représentation devant les juridictions criminelles et correctionnelles.',
        'Gestion de contentieux civils et commerciaux, médiation, arbitrage.',
      ],
      navItems: ['Domaines','L\'équipe','Honoraires','Contact'],
      ctaItems: [
        { nom:'Consultation initiale', desc:'1h · Premier entretien confidentiel', prix:'150€' },
        { nom:'Dossier complet',        desc:'Prise en charge intégrale du dossier', prix:'Sur devis' },
        { nom:'Abonnement entreprise',  desc:'Conseil juridique mensuel illimité',   prix:'À partir de 350€/mois' },
      ],
    }
  },

  ecommerce: {
    label: 'E-commerce / Boutique',
    emoji: '🛍️',
    desc:  'Boutique en ligne, marketplace, click & collect…',
    defaultConfig: {
      cPrimary:'#2563EB', cSecondary:'#F0F4FF', cAccent:'#93B4F8',
      cText:'#0F172A', cBg:'#FFFFFF',
      tHeading:"'Space Grotesk', sans-serif", tBody:"'DM Sans', sans-serif",
      tSize:16, tLine:1.6, sPadding:60, sRadius:12, sMaxw:'1200px',
      compNavbar:'border', compHero:'image-right', compServices:4,
      compContact:'yes', compGallery:'yes',
      cntName:'ShopNow', cntTagline:'Livraison offerte dès 50€',
      cntDesc:'Des produits soigneusement sélectionnés, livrés chez vous en 24h. Retours gratuits sous 30 jours.',
      cntPhone:'0800 00 00 00', cntAddress:'Boutique en ligne · France', cntCta:'Découvrir la boutique',
    },
    sectionData: {
      nav:      { navItems:'Nouveautés;Collections;Promotions;Contact', navCta:'Panier' },
      services: { servicesTitle:'Pourquoi nous choisir', servicesLabel:'Nos engagements', servicesDesc:'Qualité, livraison rapide et service client réactif.', nbServices:4 },
      gallery:  { galleryTitle:'Nos produits', galleryLabel:'Nouveautés', galleryLinkText:'Voir la boutique' },
      cta:      { ctaTitle:'Sélection du moment', ctaLabel:'Nos bestsellers', ctaDesc:'Livraison express disponible' },
      contact:  { contactTitle:'Besoin d\'aide ?', contactLabel:'Service client', contactHours:'Lun–Sam : 9h–18h' },
    },
    itemLabels: {
      services: ['Livraison rapide','Retours gratuits','Paiement sécurisé','Service client 7j/7','Eco-responsable','Programme fidélité'],
      servicesDesc: [
        'Livraison en 24h à 48h, suivi en temps réel et point relais disponibles.',
        'Retours gratuits sous 30 jours, sans condition. Remboursement immédiat.',
        'Paiement par CB, PayPal, Apple Pay. Cryptage SSL 256 bits.',
        'Chat en direct, email et téléphone. Réponse garantie en moins de 2h.',
        'Packaging recyclé, partenaires éco-certifiés, compensation carbone.',
        'Cumulez des points à chaque achat et accédez à des offres exclusives.',
      ],
      navItems: ['Nouveautés','Collections','Promotions','Contact'],
      ctaItems: [
        { nom:'Produit vedette',    desc:'Best-seller de la saison, stock limité',   prix:'49€' },
        { nom:'Pack découverte',    desc:'3 produits assortis à prix réduit',         prix:'89€' },
        { nom:'Abonnement mensuel', desc:'Sélection surprise livrée chaque mois',    prix:'35€/mois' },
      ],
    }
  },

  portfolio: {
    label: 'Portfolio / Créatif',
    emoji: '🎨',
    desc:  'Designer, photographe, illustrateur, architecte…',
    defaultConfig: {
      cPrimary:'#111111', cSecondary:'#F5F5F5', cAccent:'#888888',
      cText:'#111111', cBg:'#FFFFFF',
      tHeading:"'Space Grotesk', sans-serif", tBody:"'DM Sans', sans-serif",
      tSize:16, tLine:1.7, sPadding:80, sRadius:4, sMaxw:'1200px',
      compNavbar:'transparent', compHero:'centered', compServices:3,
      compContact:'yes', compGallery:'yes',
      cntName:'Studio Makk', cntTagline:'Direction artistique & Design',
      cntDesc:'Je conçois des identités visuelles et expériences digitales mémorables pour des marques ambitieuses.',
      cntPhone:'+33 6 00 00 00 00', cntAddress:'Paris · Remote disponible', cntCta:'Démarrer un projet',
    },
    sectionData: {
      nav:      { navItems:'Projets;Services;À propos;Contact', navCta:'Devis' },
      services: { servicesTitle:'Ce que je fais', servicesLabel:'Services', servicesDesc:'Du concept à la réalisation, un accompagnement complet.', nbServices:3 },
      gallery:  { galleryTitle:'Sélection de projets', galleryLabel:'Portfolio', galleryLinkText:'Voir tous les projets' },
      cta:      { ctaTitle:'Mes offres', ctaLabel:'Prestations', ctaDesc:'Mission ponctuelle ou partenariat long terme' },
      contact:  { contactTitle:'Travaillons ensemble', contactLabel:'Me contacter', contactHours:'Réponse sous 24h' },
    },
    itemLabels: {
      services: ['Identité visuelle','Design UI/UX','Direction artistique','Motion design','Illustration','Photographie'],
      servicesDesc: [
        'Logo, charte graphique, système de design cohérent et déclinable sur tous supports.',
        'Interfaces web et mobile centrées sur l\'expérience utilisateur. Prototypage Figma.',
        'Positionnement visuel de marque, storytelling, campagnes digitales et print.',
        'Animations, vidéos d\'entreprise, motion graphics pour réseaux sociaux.',
        'Illustrations vectorielles sur mesure, iconographie, character design.',
        'Reportages produit, portraits professionnels, photographies d\'architecture.',
      ],
      navItems: ['Projets','Services','À propos','Contact'],
      ctaItems: [
        { nom:'Identité de marque', desc:'Logo + charte graphique complète',    prix:'À partir de 1 200€' },
        { nom:'Site vitrine',       desc:'Design + intégration responsive',      prix:'À partir de 2 500€' },
        { nom:'Mission mensuelle',  desc:'Directeur artistique à temps partiel', prix:'À partir de 800€/mois' },
      ],
    }
  },

  immobilier: {
    label: 'Immobilier',
    emoji: '🏠',
    desc:  'Agence immobilière, promoteur, chasseur de biens…',
    defaultConfig: {
      cPrimary:'#2E4057', cSecondary:'#F3F5F7', cAccent:'#7C9CBB',
      cText:'#1A2535', cBg:'#FAFBFC',
      tHeading:"'Space Grotesk', sans-serif", tBody:"'DM Sans', sans-serif",
      tSize:16, tLine:1.65, sPadding:64, sRadius:10, sMaxw:'1100px',
      compNavbar:'border', compHero:'image-right', compServices:3,
      compContact:'yes', compGallery:'yes',
      cntName:'Agence Lumière', cntTagline:'Votre projet immobilier, notre expertise',
      cntDesc:'Achat, vente, location : nous vous accompagnons à chaque étape avec transparence et professionnalisme.',
      cntPhone:'01 23 45 67 89', cntAddress:'15 boulevard Haussmann, 75009 Paris', cntCta:'Estimer mon bien',
    },
    sectionData: {
      nav:      { navItems:'Acheter;Vendre;Location;Contact', navCta:'Estimation gratuite' },
      services: { servicesTitle:'Pourquoi nous confier votre projet', servicesLabel:'Notre expertise', servicesDesc:'20 ans d\'expérience, 500 transactions réalisées.', nbServices:3 },
      gallery:  { galleryTitle:'Biens en avant-première', galleryLabel:'Sélection du moment', galleryLinkText:'Voir tous les biens' },
      cta:      { ctaTitle:'Nos services', ctaLabel:'Ce que nous proposons', ctaDesc:'Honoraires transparents, sans surprise' },
      contact:  { contactTitle:'Estimer votre bien gratuitement', contactLabel:'Nous contacter', contactHours:'Lun–Sam : 9h–19h' },
    },
    itemLabels: {
      services: ['Estimation gratuite','Accompagnement achat','Gestion locative','Vente rapide','Investissement','Bilan patrimonial'],
      servicesDesc: [
        'Estimation précise de votre bien par nos experts locaux. Bilan comparatif du marché.',
        'Recherche sur mesure, visites organisées, négociation, suivi notarial jusqu\'à la signature.',
        'Gestion de vos biens locatifs : recherche de locataires, loyers, travaux, déclarations.',
        'Mandat exclusif, mise en valeur photographique, diffusion maximale sur tous portails.',
        'Sélection des meilleures opportunités locatives et optimisation fiscale (Pinel, LMNP…).',
        'Audit complet de votre patrimoine et conseils personnalisés par nos experts.',
      ],
      navItems: ['Acheter','Vendre','Location','Contact'],
      ctaItems: [
        { nom:'Estimation express',  desc:'Résultat en 48h, sans engagement',     prix:'Gratuit' },
        { nom:'Mandat de vente',     desc:'Commission au résultat uniquement',     prix:'3% du prix' },
        { nom:'Gestion locative',    desc:'Gestion complète clé en main',          prix:'8% des loyers' },
      ],
    }
  },
};

/* ── Helper : récupérer le template sectoriel actif ── */
function getSectorTemplate(key) {
  const cfg = state.templateConfigs[key] || {};
  const sector = cfg.sector || 'restaurant';
  return SECTOR_TEMPLATES[sector] || SECTOR_TEMPLATES.restaurant;
}

/* ── Helper : récupérer les sections d'une maquette ── */
function getSections(key) {
  return state.templateConfigs[key]
    ? (state.templateConfigs[key].sections || JSON.parse(JSON.stringify(DEFAULT_SECTIONS)))
    : JSON.parse(JSON.stringify(DEFAULT_SECTIONS));
}

/* ════════════════════════════════════════════════════════════
   STATE & PERSISTANCE
════════════════════════════════════════════════════════════ */
let state = {
  folders:[],templates:{},templateConfigs:{},templateMeta:{},
  navExpanded:false,currentPage:'home',currentFolderId:null,
  currentTplId:null,searchQuery:'',nextId:100,presenting:false,
  currentDevice:'desktop',versions:{},notes:[],activeNoteId:null,clients:[],
};
window._dvInitState = function(data, user) {
  state.folders=data.dv_folders||[]; state.templates=data.dv_templates||{};
  state.templateConfigs=data.dv_configs||{}; state.templateMeta=data.dv_meta||{};
  state.clients=data.dv_clients||[]; state.notes=data.dv_notes||[];
  state.versions=data.dv_versions||{}; state.nextId=data.dv_nextId||100;
  window._dvSC=data.dv_shortcuts||null; window._dvReady=true;
  var av=document.getElementById('dv-user-avatar');
  var nm=document.getElementById('dv-user-name');
  if(av&&user.photoURL){av.src=user.photoURL;av.style.display='block';}
  if(nm){nm.textContent=user.displayName||user.email;nm.style.opacity='1';}
  navigate('home'); checkOnboarding();
};

function bumpId() { state.nextId++; LS.set('dv_nextId', state.nextId); return state.nextId; }

/* ════════════════════════════════════════════════════════════
   CONFIG PAR DÉFAUT & PANEL
════════════════════════════════════════════════════════════ */
function getDefaultConfig(sector) {
  const tmpl = SECTOR_TEMPLATES[sector] || SECTOR_TEMPLATES.restaurant;
  return {
    ...tmpl.defaultConfig,
    sector: sector || 'restaurant',
    sections: JSON.parse(JSON.stringify(DEFAULT_SECTIONS)),
    sectionData: JSON.parse(JSON.stringify(tmpl.sectionData || {})),
    images: {},
  };
}

function applyConfigToPanel(cfg) {
  const set = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
  const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
  set('c-primary',   cfg.cPrimary);
  set('c-secondary', cfg.cSecondary);
  set('c-accent',    cfg.cAccent);
  set('c-text',      cfg.cText);
  set('c-bg',        cfg.cBg);
  set('t-heading',   cfg.tHeading);
  set('t-body',      cfg.tBody);
  set('t-size',      cfg.tSize);   setTxt('t-size-val', cfg.tSize + 'px');
  set('t-line',      cfg.tLine);   setTxt('t-line-val', cfg.tLine);
  set('cnt-name',    cfg.cntName);
  set('cnt-tagline', cfg.cntTagline);
  set('cnt-desc',    cfg.cntDesc);
  set('cnt-phone',   cfg.cntPhone);
  set('cnt-address', cfg.cntAddress);
  set('cnt-cta',     cfg.cntCta);
  set('s-padding',   cfg.sPadding); setTxt('s-padding-val', cfg.sPadding + 'px');
  set('s-radius',    cfg.sRadius);  setTxt('s-radius-val',  cfg.sRadius + 'px');
  set('s-maxw',      cfg.sMaxw);
  set('comp-navbar',   cfg.compNavbar);
  set('comp-hero',     cfg.compHero);
  set('comp-services', cfg.compServices); setTxt('comp-services-val', cfg.compServices);
  set('comp-contact',  cfg.compContact);
  set('comp-gallery',  cfg.compGallery);
}

function readConfigFromPanel() {
  const gv = id => { const el = document.getElementById(id); return el ? el.value : ''; };
  const gn = id => { const el = document.getElementById(id); return el ? +el.value : 0; };
  const key = `${state.currentFolderId}_${state.currentTplId}`;
  const prev = state.templateConfigs[key] || {};
  return {
    ...prev,
    cPrimary:    gv('c-primary'),
    cSecondary:  gv('c-secondary'),
    cAccent:     gv('c-accent'),
    cText:       gv('c-text'),
    cBg:         gv('c-bg'),
    tHeading:    gv('t-heading'),
    tBody:       gv('t-body'),
    tSize:       gn('t-size'),
    tLine:       gn('t-line'),
    cntName:     gv('cnt-name'),
    cntTagline:  gv('cnt-tagline'),
    cntDesc:     gv('cnt-desc'),
    cntPhone:    gv('cnt-phone'),
    cntAddress:  gv('cnt-address'),
    cntCta:      gv('cnt-cta'),
    sPadding:    gn('s-padding'),
    sRadius:     gn('s-radius'),
    sMaxw:       gv('s-maxw'),
    compNavbar:  gv('comp-navbar'),
    compHero:    gv('comp-hero'),
    compServices:gn('comp-services'),
    compContact: gv('comp-contact'),
    compGallery: gv('comp-gallery'),
  };
}

/* ════════════════════════════════════════════════════════════
   GÉNÉRATEUR DE PREVIEW — BUILDERS

   Chaque builder reçoit (cfg, sd, tmpl, ctx) où :
     cfg   = config globale (couleurs, typo, etc.)
     sd    = sectionData de cette maquette (textes par section)
     tmpl  = SECTOR_TEMPLATES[sector]
     ctx   = { P,S,AC,TX,BG,TH,TB,TS,TL,R,PD,MW,onPrimary,
               name,tagline,desc,phone,address,cta,
               imgs, imgPlaceholder }
════════════════════════════════════════════════════════════ */

/* ── Helpers couleur & image ── */
function hexLuma(hex) {
  const h = hex.replace('#','');
  return 0.299*parseInt(h.substring(0,2),16) + 0.587*parseInt(h.substring(2,4),16) + 0.114*parseInt(h.substring(4,6),16);
}

function buildCtx(cfg, key) {
  const tmpl  = getSectorTemplate(key);
  const sd    = (cfg.sectionData) || {};
  const imgs  = (cfg.images) || {};
  const P     = cfg.cPrimary;
  const S     = cfg.cSecondary;
  const AC    = cfg.cAccent;
  const TX    = cfg.cText;
  const BG    = cfg.cBg;
  const TH    = cfg.tHeading;
  const TB    = cfg.tBody;
  const TS    = cfg.tSize;
  const TL    = cfg.tLine;
  const R     = cfg.sRadius;
  const PD    = cfg.sPadding;
  const MW    = cfg.sMaxw;
  const onPrimary = hexLuma(P) > 145 ? TX : '#ffffff';

  const name    = cfg.cntName    || tmpl.defaultConfig.cntName;
  const tagline = cfg.cntTagline || tmpl.defaultConfig.cntTagline;
  const desc    = cfg.cntDesc    || tmpl.defaultConfig.cntDesc;
  const phone   = cfg.cntPhone   || tmpl.defaultConfig.cntPhone;
  const address = cfg.cntAddress || tmpl.defaultConfig.cntAddress;
  const cta     = cfg.cntCta     || tmpl.defaultConfig.cntCta;

  function imgPlaceholder(id, label, extraStyle) {
    const src = imgs[id];
    const sty = extraStyle || '';
    if (src) {
      return `<div data-dv-img-id="${id}" style="position:relative;cursor:pointer;overflow:hidden;${sty}">
        <img src="${src}" style="width:100%;height:100%;object-fit:cover;display:block;" alt="${label}"/>
        <div class="dv-gallery-overlay" style="position:absolute;inset:0;background:rgba(0,0,0,0);display:flex;align-items:center;justify-content:center;transition:background .2s;">
          <svg width="28" height="28" viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' style='opacity:0;transition:opacity .2s'><rect x='3' y='3' width='18' height='18' rx='2'/><circle cx='8.5' cy='8.5' r='1.5'/><polyline points='21 15 16 10 5 21'/></svg>
        </div></div>`;
    }
    return `<div data-dv-img-id="${id}" title="Cliquer pour ajouter une photo"
      style="cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;
      background:${AC}20;border:2px dashed ${AC}77;transition:all .2s;opacity:.8;${sty}">
      <svg width="26" height="26" viewBox='0 0 24 24' fill='none' stroke='${P}' stroke-width='1.5' opacity='.7'><rect x='3' y='3' width='18' height='18' rx='2'/><circle cx='8.5' cy='8.5' r='1.5'/><polyline points='21 15 16 10 5 21'/></svg>
      <span style="font-family:${TB};font-size:11px;color:${P};opacity:.7;">${label}</span>
    </div>`;
  }

  return { P,S,AC,TX,BG,TH,TB,TS,TL,R,PD,MW,onPrimary, name,tagline,desc,phone,address,cta, imgs,imgPlaceholder, sd,tmpl };
}

/* ── NAVBAR ── */
function buildNav(cfg, ctx) {
  const { P,S,AC,TX,BG,TH,TB,TS,R,MW,onPrimary,name,cta,imgs,sd } = ctx;
  const isSolid  = cfg.compNavbar === 'solid';
  const isBorder = cfg.compNavbar === 'border';
  const isTrans  = cfg.compNavbar === 'transparent';
  const navBg    = isSolid ? P : isBorder ? BG : 'transparent';
  const navCol   = isSolid ? onPrimary : TX;
  const pos      = isTrans ? 'position:absolute;top:0;left:0;width:100%;z-index:20;' : 'position:relative;z-index:20;';
  const border   = isBorder ? `border-bottom:2px solid ${P}30;` : '';
  const shadow   = isSolid  ? `box-shadow:0 2px 24px ${P}44;` : '';

  const logoHtml = imgs.logo
    ? `<img src="${imgs.logo}" data-dv-img-id="logo" style="max-height:40px;max-width:140px;object-fit:contain;cursor:pointer;display:block;" alt="Logo"/>`
    : `<div data-dv-img-id="logo" style="cursor:pointer;display:inline-flex;align-items:center;gap:10px;opacity:.9;" title="Cliquer pour ajouter un logo">
        <div style="width:36px;height:36px;border-radius:50%;background:${isSolid?'rgba(255,255,255,.2)':P+'22'};display:flex;align-items:center;justify-content:center;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${navCol}" stroke-width="1.8" opacity=".8"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        </div>
        <span style="font-family:${TH};font-size:${TS+1}px;font-weight:700;color:${navCol};letter-spacing:-.01em;">${name}</span>
      </div>`;

  const rawItems = (sd.nav && sd.nav.navItems) ? sd.nav.navItems.split(';').map(x=>x.trim()).filter(Boolean) : ctx.tmpl.itemLabels.navItems;
  const navItems = rawItems.map(l => `<a style="font-family:${TB};font-size:${TS-1}px;color:${navCol};font-weight:500;opacity:.8;text-decoration:none;letter-spacing:.01em;">${l}</a>`).join('');

  const navCtaText = (sd.nav && sd.nav.navCta) || cta;
  const ctaBg    = isSolid ? `rgba(255,255,255,.15)` : P;
  const ctaCol   = isSolid ? onPrimary : '#fff';
  const ctaBorder= isSolid ? `1.5px solid rgba(255,255,255,.3)` : `1.5px solid ${P}`;

  return `<nav style="${pos}${shadow}${border}background:${navBg};padding:0 40px;">
    <div style="max-width:${MW};margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:70px;">
      ${logoHtml}
      <div style="display:flex;align-items:center;gap:28px;">${navItems}</div>
      <a style="background:${ctaBg};color:${ctaCol};padding:10px 22px;border-radius:100px;
        font-family:${TH};font-size:${TS-2}px;font-weight:700;text-decoration:none;
        border:${ctaBorder};letter-spacing:.02em;text-transform:uppercase;">${navCtaText}</a>
    </div>
  </nav>`;
}

/* ── HERO ── */
function buildHero(cfg, ctx) {
  const { P,S,AC,TX,BG,TH,TB,TS,TL,R,PD,MW,onPrimary,name,tagline,desc,cta,imgs,imgPlaceholder,sd } = ctx;
  const isSplit    = cfg.compHero === 'image-right';
  const isCentered = cfg.compHero === 'centered';
  const isTrans    = cfg.compNavbar === 'transparent';
  const hasImg     = !!imgs.hero;
  const topPad     = isTrans ? PD * 2.4 : PD * 1.4;

  const heroTitle   = (sd.hero && sd.hero.heroTitle)   || name;
  const heroTagline = (sd.hero && sd.hero.heroTagline) || tagline;
  const heroDesc    = (sd.hero && sd.hero.heroDesc)    || desc;
  const heroCta     = (sd.hero && sd.hero.heroCta)     || cta;

  if (isSplit) {
    const imgHtml = imgPlaceholder('hero','Photo hero', `width:100%;height:100%;min-height:480px;border-radius:${R*2}px;`);
    return `<section style="background:${BG};padding:${topPad}px 0 ${PD}px;overflow:hidden;">
      <div style="max-width:${MW};margin:0 auto;padding:0 40px;display:grid;grid-template-columns:1fr 1fr;gap:64px;align-items:center;">
        <div>
          <div style="display:inline-flex;align-items:center;gap:8px;background:${P}18;border-radius:100px;padding:6px 16px;margin-bottom:24px;border:1px solid ${P}25;">
            <span style="width:5px;height:5px;border-radius:50%;background:${P};display:inline-block;"></span>
            <span style="font-family:${TB};font-size:${TS-3}px;font-weight:600;color:${P};text-transform:uppercase;letter-spacing:.12em;">${heroTagline}</span>
          </div>
          <h1 style="font-family:${TH};font-size:${TS+28}px;font-weight:700;color:${TX};line-height:1.08;margin-bottom:20px;letter-spacing:-.025em;">${heroTitle}</h1>
          <p style="font-family:${TB};font-size:${TS+1}px;color:${TX}88;line-height:${TL};margin-bottom:36px;max-width:420px;">${heroDesc}</p>
          <a style="display:inline-flex;align-items:center;gap:8px;background:${P};color:${onPrimary};padding:14px 30px;border-radius:100px;font-family:${TH};font-size:${TS-1}px;font-weight:700;text-decoration:none;box-shadow:0 8px 20px ${P}44;">${heroCta}</a>
        </div>
        <div style="position:relative;">
          <div style="position:absolute;top:-24px;right:-24px;width:200px;height:200px;border-radius:50%;background:${P}14;z-index:0;"></div>
          <div style="position:relative;z-index:1;">${imgHtml}</div>
        </div>
      </div>
    </section>`;
  }

  if (isCentered) {
    const heroBg   = hasImg ? `background:linear-gradient(to bottom,rgba(0,0,0,.55) 0%,rgba(0,0,0,.3) 100%),url('${imgs.hero}') center/cover no-repeat;` : `background:linear-gradient(135deg,${P}22 0%,${AC}28 50%,${S} 100%);`;
    const tCol     = hasImg ? '#fff' : TX;
    const sCol     = hasImg ? 'rgba(255,255,255,.8)' : `${TX}88`;
    const editOv   = hasImg
      ? `<div data-dv-img-id="hero" style="position:absolute;top:16px;right:16px;z-index:10;width:36px;height:36px;background:rgba(0,0,0,.5);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>`
      : imgPlaceholder('hero','Image de fond',`position:absolute;inset:0;width:100%;height:100%;z-index:0;opacity:.35;`);
    return `<section style="${heroBg}padding:${topPad}px 0 ${PD*1.3}px;position:relative;text-align:center;overflow:hidden;">
      <div style="position:relative;z-index:1;max-width:700px;margin:0 auto;padding:0 40px;">
        <div style="display:inline-flex;align-items:center;gap:8px;margin-bottom:22px;background:${hasImg?'rgba(255,255,255,.12)':P+'18'};border-radius:100px;padding:7px 18px;border:1px solid ${hasImg?'rgba(255,255,255,.25)':P+'30'};">
          <span style="width:5px;height:5px;border-radius:50%;background:${hasImg?'#fff':P};display:inline-block;"></span>
          <span style="font-family:${TB};font-size:${TS-3}px;font-weight:600;color:${hasImg?'#fff':P};text-transform:uppercase;letter-spacing:.12em;">${heroTagline}</span>
        </div>
        <h1 style="font-family:${TH};font-size:${TS+30}px;font-weight:700;color:${tCol};line-height:1.06;margin-bottom:18px;letter-spacing:-.03em;">${heroTitle}</h1>
        <p style="font-family:${TB};font-size:${TS+1}px;color:${sCol};line-height:${TL};margin-bottom:36px;">${heroDesc}</p>
        <a style="display:inline-flex;align-items:center;gap:8px;background:${P};color:${onPrimary};padding:14px 32px;border-radius:100px;font-family:${TH};font-size:${TS-1}px;font-weight:700;text-decoration:none;box-shadow:0 8px 24px ${P}55;">${heroCta}</a>
      </div>
      ${editOv}
    </section>`;
  }

  // Left
  const heroBg2  = hasImg ? `background:linear-gradient(to right,${TX}e8 45%,rgba(0,0,0,.1) 100%),url('${imgs.hero}') center/cover no-repeat;` : `background:${S};`;
  const tCol2    = hasImg ? '#fff' : TX;
  const editOv2  = hasImg
    ? `<div data-dv-img-id="hero" style="position:absolute;top:16px;right:16px;z-index:10;width:36px;height:36px;background:rgba(0,0,0,.5);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>`
    : imgPlaceholder('hero','Image de fond',`position:absolute;right:0;top:0;width:50%;height:100%;z-index:0;`);
  return `<section style="${heroBg2}padding:${topPad}px 0 ${PD*1.3}px;position:relative;overflow:hidden;">
    <div style="position:relative;z-index:1;max-width:${MW};margin:0 auto;padding:0 40px;max-width:560px;">
      <div style="display:inline-flex;align-items:center;gap:8px;margin-bottom:22px;background:${hasImg?'rgba(255,255,255,.15)':P+'18'};border-radius:100px;padding:6px 16px;border:1px solid ${hasImg?'rgba(255,255,255,.25)':P+'30'};">
        <span style="width:5px;height:5px;border-radius:50%;background:${hasImg?'#fff':P};display:inline-block;"></span>
        <span style="font-family:${TB};font-size:${TS-3}px;font-weight:600;color:${hasImg?'#fff':P};text-transform:uppercase;letter-spacing:.12em;">${heroTagline}</span>
      </div>
      <h1 style="font-family:${TH};font-size:${TS+26}px;font-weight:700;color:${tCol2};line-height:1.08;margin-bottom:18px;letter-spacing:-.02em;">${heroTitle}</h1>
      <p style="font-family:${TB};font-size:${TS+1}px;color:${tCol2}88;line-height:${TL};margin-bottom:36px;">${heroDesc}</p>
      <a style="display:inline-flex;align-items:center;gap:8px;background:${P};color:${onPrimary};padding:14px 30px;border-radius:100px;font-family:${TH};font-size:${TS-1}px;font-weight:700;text-decoration:none;box-shadow:0 8px 20px ${P}44;">${heroCta}</a>
    </div>
    ${editOv2}
  </section>`;
}

/* ── SERVICES ── */
function buildServices(cfg, ctx) {
  const { P,S,AC,TX,BG,TH,TB,TS,TL,R,PD,MW,sd,tmpl } = ctx;
  const nb = Math.min(6, Math.max(2, cfg.compServices || 3));
  const sdSvc = sd.services || {};
  const labels = tmpl.itemLabels.services.slice(0, nb);
  const descs  = tmpl.itemLabels.servicesDesc.slice(0, nb);
  const secTitle = sdSvc.servicesTitle || 'Une expérience unique';
  const secLabel = sdSvc.servicesLabel || 'Pourquoi nous choisir';
  const secDesc  = sdSvc.servicesDesc  || '';
  const cols = nb <= 2 ? 2 : nb === 4 ? 2 : 3;
  const icons = [
    `<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>`,
    `<path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/>`,
    `<circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>`,
    `<path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/>`,
    `<rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>`,
    `<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>`,
  ];
  const cards = labels.map((label, i) => `
    <div style="background:${BG};border-radius:${R*2}px;padding:28px 24px;border:1.5px solid ${AC}33;position:relative;overflow:hidden;">
      <div style="position:absolute;top:-16px;right:-16px;width:80px;height:80px;border-radius:50%;background:${P}08;"></div>
      <div style="width:46px;height:46px;border-radius:${R+4}px;background:${P}15;display:flex;align-items:center;justify-content:center;margin-bottom:18px;">
        <svg width="21" height="21" viewBox="0 0 24 24" fill="none" stroke="${P}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">${icons[i]}</svg>
      </div>
      <div style="font-family:${TH};font-size:${TS+1}px;font-weight:700;color:${TX};margin-bottom:8px;">${label}</div>
      <div style="font-family:${TB};font-size:${TS-1}px;color:${TX}88;line-height:${TL};">${descs[i]}</div>
    </div>`).join('');
  return `<section style="padding:${PD}px 0;background:${S};">
    <div style="max-width:${MW};margin:0 auto;padding:0 40px;">
      <div style="text-align:center;margin-bottom:${PD*0.7}px;">
        <div style="display:inline-flex;align-items:center;gap:12px;margin-bottom:14px;">
          <div style="width:28px;height:2px;background:${P};border-radius:2px;"></div>
          <span style="font-family:${TB};font-size:${TS-3}px;font-weight:700;color:${P};text-transform:uppercase;letter-spacing:.15em;">${secLabel}</span>
          <div style="width:28px;height:2px;background:${P};border-radius:2px;"></div>
        </div>
        <h2 style="font-family:${TH};font-size:${TS+14}px;font-weight:700;color:${TX};letter-spacing:-.02em;margin-bottom:10px;">${secTitle}</h2>
        ${secDesc ? `<p style="font-family:${TB};font-size:${TS}px;color:${TX}77;max-width:440px;margin:0 auto;line-height:${TL};">${secDesc}</p>` : ''}
      </div>
      <div style="display:grid;grid-template-columns:repeat(${cols},1fr);gap:18px;">${cards}</div>
    </div>
  </section>`;
}

/* ── GALERIE ── */
function buildGallery(cfg, ctx) {
  const { P,AC,TX,BG,TH,TB,TS,TL,R,PD,MW,imgPlaceholder,sd } = ctx;
  if (cfg.compGallery !== 'yes') {
    return `<section style="padding:${PD}px 0;background:${BG};">
      <div style="max-width:${MW};margin:0 auto;padding:0 40px;text-align:center;">
        <div style="padding:40px;border:2px dashed ${AC}55;border-radius:${R*2}px;">
          <div style="font-family:${TB};font-size:${TS}px;color:${TX}55;">Galerie désactivée.</div>
        </div>
      </div></section>`;
  }
  const sdG = sd.gallery || {};
  const gTitle    = sdG.galleryTitle    || 'La galerie';
  const gLabel    = sdG.galleryLabel    || 'En images';
  const gLinkText = sdG.galleryLinkText || 'Voir toutes les photos';
  const cells = [0,1,2,3,4,5].map(i => imgPlaceholder('gallery_'+i, `Photo ${i+1}`, `aspect-ratio:4/3;border-radius:${R*1.5}px;width:100%;`)).join('');
  return `<section style="padding:${PD}px 0;background:${BG};">
    <div style="max-width:${MW};margin:0 auto;padding:0 40px;">
      <div style="display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:${PD*0.55}px;gap:20px;flex-wrap:wrap;">
        <div>
          <div style="display:inline-flex;align-items:center;gap:10px;margin-bottom:10px;">
            <div style="width:24px;height:2px;background:${P};border-radius:2px;"></div>
            <span style="font-family:${TB};font-size:${TS-3}px;font-weight:700;color:${P};text-transform:uppercase;letter-spacing:.14em;">${gLabel}</span>
          </div>
          <h2 style="font-family:${TH};font-size:${TS+14}px;font-weight:700;color:${TX};letter-spacing:-.02em;line-height:1.15;">${gTitle}</h2>
        </div>
        <a style="display:inline-flex;align-items:center;gap:6px;font-family:${TB};font-size:${TS-2}px;color:${P};font-weight:600;text-decoration:none;border-bottom:1.5px solid ${P}44;padding-bottom:2px;">${gLinkText}
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        </a>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:auto auto;gap:12px;">${cells}</div>
    </div>
  </section>`;
}

/* ── CTA / CARTE ── */
function buildCta(cfg, ctx) {
  const { P,AC,TX,BG,TH,TB,TS,TL,R,PD,MW,onPrimary,cta,sd,tmpl } = ctx;
  const sdC    = sd.cta || {};
  const title  = sdC.ctaTitle || 'Notre carte';
  const label  = sdC.ctaLabel || 'Sélection';
  const ctaDesc= sdC.ctaDesc  || '';
  const items  = tmpl.itemLabels.ctaItems || [];
  const rows = items.map(p => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:18px 0;border-bottom:1px solid rgba(255,255,255,.1);">
      <div>
        <div style="font-family:${TH};font-size:${TS+1}px;font-weight:600;color:#fff;margin-bottom:4px;">${p.nom}</div>
        <div style="font-family:${TB};font-size:${TS-2}px;color:rgba(255,255,255,.6);line-height:1.5;">${p.desc}</div>
      </div>
      <div style="font-family:${TH};font-size:${TS+2}px;font-weight:700;color:${AC};margin-left:24px;white-space:nowrap;">${p.prix}</div>
    </div>`).join('');
  return `<section style="background:${TX};padding:${PD}px 0;position:relative;overflow:hidden;">
    <div style="position:absolute;top:-100px;right:-80px;width:360px;height:360px;border-radius:50%;background:${P}18;pointer-events:none;"></div>
    <div style="max-width:${MW};margin:0 auto;padding:0 40px;display:grid;grid-template-columns:1fr 1fr;gap:60px;align-items:center;position:relative;z-index:1;">
      <div>
        <div style="display:inline-flex;align-items:center;gap:8px;margin-bottom:20px;background:rgba(255,255,255,.08);border-radius:100px;padding:6px 16px;border:1px solid rgba(255,255,255,.12);">
          <span style="width:5px;height:5px;border-radius:50%;background:${P};display:inline-block;"></span>
          <span style="font-family:${TB};font-size:${TS-3}px;font-weight:600;color:rgba(255,255,255,.7);text-transform:uppercase;letter-spacing:.12em;">${label}</span>
        </div>
        <h2 style="font-family:${TH};font-size:${TS+16}px;font-weight:700;color:#fff;line-height:1.1;margin-bottom:10px;letter-spacing:-.02em;">${title}</h2>
        ${ctaDesc ? `<p style="font-family:${TB};font-size:${TS}px;color:rgba(255,255,255,.55);line-height:${TL};margin-bottom:28px;">${ctaDesc}</p>` : ''}
        <a style="display:inline-flex;align-items:center;gap:8px;background:${P};color:${onPrimary};padding:13px 26px;border-radius:100px;font-family:${TH};font-size:${TS-2}px;font-weight:700;text-decoration:none;text-transform:uppercase;letter-spacing:.04em;">${cta}</a>
      </div>
      <div>${rows}</div>
    </div>
  </section>`;
}

/* ── TÉMOIGNAGES ── */
function buildTestimonials(cfg, ctx) {
  const { P,S,AC,TX,BG,TH,TB,TS,TL,R,PD,MW,sd } = ctx;
  const sdT   = sd.testimonials || {};
  const nb    = Math.min(6, Math.max(1, sdT.nbTestimonials || 3));
  const title = sdT.testTitle || 'Ce que disent nos clients';
  const label = sdT.testLabel || 'Avis clients';
  const stars = `<svg width="14" height="14" viewBox="0 0 24 24" fill="${P}" stroke="none"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`.repeat(5);
  const quotes = [
    { name:'Marie D.',  text:'Service exceptionnel, je recommande vivement. Une expérience inoubliable du début à la fin.', sub:'Cliente fidèle depuis 3 ans' },
    { name:'Thomas L.', text:'Exactement ce que je cherchais. Professionnalisme et qualité au rendez-vous.', sub:'Client satisfait' },
    { name:'Sophie M.', text:'Une équipe à l\'écoute et des résultats qui dépassent mes attentes. Merci !', sub:'Première visite' },
    { name:'Paul R.',   text:'Rapport qualité-prix imbattable. Je reviens régulièrement et c\'est toujours parfait.', sub:'Client régulier' },
    { name:'Claire B.', text:'Accueil chaleureux, prestations soignées. Je me sens entre de bonnes mains.', sub:'Cliente depuis 1 an' },
    { name:'Julien F.', text:'Très bonne expérience, je referai appel à eux sans hésitation.', sub:'Client occasionnel' },
  ];
  const cards = quotes.slice(0, nb).map(q => `
    <div style="background:${BG};border-radius:${R*2}px;padding:28px 24px;border:1.5px solid ${AC}33;">
      <div style="display:flex;gap:2px;margin-bottom:14px;">${stars}</div>
      <p style="font-family:${TB};font-size:${TS-1}px;color:${TX};line-height:${TL};margin-bottom:18px;font-style:italic;">"${q.text}"</p>
      <div style="font-family:${TH};font-size:${TS-1}px;font-weight:700;color:${TX};">${q.name}</div>
      <div style="font-family:${TB};font-size:${TS-3}px;color:${TX}66;">${q.sub}</div>
    </div>`).join('');
  const cols = nb <= 2 ? 2 : nb === 4 ? 2 : 3;
  return `<section style="padding:${PD}px 0;background:${S};">
    <div style="max-width:${MW};margin:0 auto;padding:0 40px;">
      <div style="text-align:center;margin-bottom:${PD*0.7}px;">
        <div style="display:inline-flex;align-items:center;gap:12px;margin-bottom:14px;">
          <div style="width:28px;height:2px;background:${P};border-radius:2px;"></div>
          <span style="font-family:${TB};font-size:${TS-3}px;font-weight:700;color:${P};text-transform:uppercase;letter-spacing:.15em;">${label}</span>
          <div style="width:28px;height:2px;background:${P};border-radius:2px;"></div>
        </div>
        <h2 style="font-family:${TH};font-size:${TS+14}px;font-weight:700;color:${TX};letter-spacing:-.02em;">${title}</h2>
      </div>
      <div style="display:grid;grid-template-columns:repeat(${cols},1fr);gap:18px;">${cards}</div>
    </div>
  </section>`;
}

/* ── TARIFS ── */
function buildPricing(cfg, ctx) {
  const { P,S,AC,TX,BG,TH,TB,TS,TL,R,PD,MW,onPrimary,cta,sd,tmpl } = ctx;
  const sdP   = sd.pricing || {};
  const title = sdP.pricingTitle || 'Nos formules';
  const label = sdP.pricingLabel || 'Tarifs';
  const items = tmpl.itemLabels.ctaItems || [];
  const cards = items.map((item, i) => {
    const featured = i === 1;
    return `<div style="background:${featured?P:BG};border-radius:${R*2}px;padding:32px 28px;border:${featured?'none':'1.5px solid '+AC+'33'};${featured?'box-shadow:0 16px 40px '+P+'44;':''}position:relative;">
      ${featured ? `<div style="position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:${AC};color:#fff;padding:4px 16px;border-radius:100px;font-family:${TB};font-size:${TS-3}px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;">Recommandé</div>` : ''}
      <div style="font-family:${TH};font-size:${TS+2}px;font-weight:700;color:${featured?onPrimary:TX};margin-bottom:8px;">${item.nom}</div>
      <div style="font-family:${TH};font-size:${TS+16}px;font-weight:700;color:${featured?onPrimary:P};margin-bottom:10px;">${item.prix}</div>
      <div style="font-family:${TB};font-size:${TS-1}px;color:${featured?onPrimary+'cc':TX+'88'};line-height:${TL};margin-bottom:24px;">${item.desc}</div>
      <a style="display:block;text-align:center;background:${featured?'rgba(255,255,255,.2)':P};color:${featured?onPrimary:'#fff'};padding:12px 24px;border-radius:100px;font-family:${TH};font-size:${TS-2}px;font-weight:700;text-decoration:none;border:${featured?'1.5px solid rgba(255,255,255,.4)':'none'};">${cta}</a>
    </div>`;
  }).join('');
  return `<section style="padding:${PD}px 0;background:${S};">
    <div style="max-width:${MW};margin:0 auto;padding:0 40px;">
      <div style="text-align:center;margin-bottom:${PD*0.7}px;">
        <div style="display:inline-flex;align-items:center;gap:12px;margin-bottom:14px;">
          <div style="width:28px;height:2px;background:${P};border-radius:2px;"></div>
          <span style="font-family:${TB};font-size:${TS-3}px;font-weight:700;color:${P};text-transform:uppercase;letter-spacing:.15em;">${label}</span>
          <div style="width:28px;height:2px;background:${P};border-radius:2px;"></div>
        </div>
        <h2 style="font-family:${TH};font-size:${TS+14}px;font-weight:700;color:${TX};letter-spacing:-.02em;">${title}</h2>
      </div>
      <div style="display:grid;grid-template-columns:repeat(${Math.min(3,items.length)},1fr);gap:20px;padding-top:12px;">${cards}</div>
    </div>
  </section>`;
}

/* ── FAQ ── */
function buildFAQ(cfg, ctx) {
  const { P,S,AC,TX,BG,TH,TB,TS,TL,R,PD,MW,sd,tmpl } = ctx;
  const sdF   = sd.faq || {};
  const nb    = Math.min(10, Math.max(3, sdF.nbFaq || 5));
  const title = sdF.faqTitle || 'Questions fréquentes';
  const label = sdF.faqLabel || 'FAQ';
  const sector= tmpl.label;
  const defaultQA = [
    { q:'Comment réserver ?', r:`Vous pouvez réserver directement sur notre site ou nous contacter par téléphone. Réponse sous 24h.` },
    { q:'Quelles sont vos modalités de paiement ?', r:'Nous acceptons les paiements par carte bancaire, espèces et virement. Acompte de 30% pour les réservations groupes.' },
    { q:'Est-ce que vous travaillez le week-end ?', r:'Oui, nous sommes disponibles du lundi au samedi. Contactez-nous pour les interventions exceptionnelles le dimanche.' },
    { q:'Proposez-vous des tarifs préférentiels ?', r:'Des remises sont disponibles pour les commandes récurrentes et les partenariats long terme. Demandez un devis.' },
    { q:'Comment fonctionne le service après-vente ?', r:'Nous garantissons notre travail et intervenons rapidement en cas de problème. Service client disponible 6j/7.' },
    { q:'Quelle est votre zone d\'intervention ?', r:'Nous intervenons dans toute la région. Des frais de déplacement peuvent s\'appliquer au-delà de 50km.' },
    { q:'Avez-vous des références clients ?', r:'Oui, n\'hésitez pas à consulter nos avis en ligne ou à demander des références directement.' },
    { q:'Quels délais pour obtenir un rendez-vous ?', r:'En général sous 48h à 72h. Pour les urgences, nous faisons notre possible pour intervenir le jour même.' },
    { q:'Proposez-vous des contrats d\'entretien ?', r:'Oui, des contrats annuels sont disponibles avec des conditions avantageuses et une priorité d\'intervention.' },
    { q:'Êtes-vous assurés ?', r:'Oui, nous disposons de toutes les assurances nécessaires à l\'exercice de notre activité. Sur demande.' },
  ];
  const items = defaultQA.slice(0, nb).map(item => `
    <div style="border-bottom:1.5px solid ${AC}33;padding:18px 0;">
      <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;gap:16px;">
        <div style="font-family:${TH};font-size:${TS}px;font-weight:600;color:${TX};flex:1;">${item.q}</div>
        <div style="width:28px;height:28px;border-radius:50%;background:${P}15;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="${P}" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
        </div>
      </div>
      <div style="font-family:${TB};font-size:${TS-1}px;color:${TX}88;line-height:${TL};padding-top:10px;">${item.r}</div>
    </div>`).join('');
  return `<section style="padding:${PD}px 0;background:${BG};">
    <div style="max-width:760px;margin:0 auto;padding:0 40px;">
      <div style="text-align:center;margin-bottom:${PD*0.7}px;">
        <div style="display:inline-flex;align-items:center;gap:12px;margin-bottom:14px;">
          <div style="width:28px;height:2px;background:${P};border-radius:2px;"></div>
          <span style="font-family:${TB};font-size:${TS-3}px;font-weight:700;color:${P};text-transform:uppercase;letter-spacing:.15em;">${label}</span>
          <div style="width:28px;height:2px;background:${P};border-radius:2px;"></div>
        </div>
        <h2 style="font-family:${TH};font-size:${TS+14}px;font-weight:700;color:${TX};letter-spacing:-.02em;">${title}</h2>
      </div>
      ${items}
    </div>
  </section>`;
}

/* ── CONTACT ── */
function buildContact(cfg, ctx) {
  const { P,S,AC,TX,BG,TH,TB,TS,TL,R,PD,MW,onPrimary,tagline,phone,address,cta,sd } = ctx;
  if (cfg.compContact !== 'yes') {
    return `<section style="padding:${PD}px 0;background:${BG};">
      <div style="max-width:${MW};margin:0 auto;padding:0 40px;text-align:center;">
        <div style="padding:40px;border:2px dashed ${AC}55;border-radius:${R*2}px;">
          <div style="font-family:${TB};font-size:${TS}px;color:${TX}55;">Contact désactivé.</div>
        </div>
      </div></section>`;
  }
  const sdC    = sd.contact || {};
  const title  = sdC.contactTitle || 'Réserver';
  const label  = sdC.contactLabel || 'Nous contacter';
  const hours  = sdC.contactHours || 'Lun–Sam : 9h–19h';
  const infos  = [
    { icon:`<path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 016.19 15.9a19.79 19.79 0 01-3.07-8.67A2 2 0 015.11 5h3a2 2 0 012 1.72c.13.96.36 1.9.7 2.81a2 2 0 01-.45 2.11L9.09 12.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.91.34 1.85.57 2.81.7A2 2 0 0122 19.92v3z"/>`, label:'Téléphone', val:phone },
    { icon:`<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/>`, label:'Adresse', val:address },
    { icon:`<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>`, label:'Horaires', val:hours },
  ];
  const infoHtml = infos.map(info => `
    <div style="display:flex;align-items:flex-start;gap:16px;padding:18px 22px;background:${S};border-radius:${R*1.5}px;">
      <div style="width:40px;height:40px;border-radius:${R}px;background:${P}18;flex-shrink:0;display:flex;align-items:center;justify-content:center;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${P}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">${info.icon}</svg>
      </div>
      <div>
        <div style="font-family:${TH};font-size:${TS-3}px;font-weight:700;color:${TX}55;text-transform:uppercase;letter-spacing:.1em;margin-bottom:3px;">${info.label}</div>
        <div style="font-family:${TB};font-size:${TS}px;color:${TX};font-weight:500;">${info.val}</div>
      </div>
    </div>`).join('');
  const fields = ['Votre prénom et nom','Adresse e-mail'].map(ph => `<input placeholder="${ph}" style="width:100%;padding:12px 16px;border:1.5px solid ${AC}44;border-radius:${R}px;font-family:${TB};font-size:${TS-1}px;color:${TX};background:${BG};box-sizing:border-box;outline:none;"/>`).join('');
  return `<section style="padding:${PD}px 0;background:${BG};">
    <div style="max-width:${MW};margin:0 auto;padding:0 40px;">
      <div style="text-align:center;margin-bottom:${PD*0.7}px;">
        <div style="display:inline-flex;align-items:center;gap:10px;margin-bottom:12px;">
          <div style="width:24px;height:2px;background:${P};border-radius:2px;"></div>
          <span style="font-family:${TB};font-size:${TS-3}px;font-weight:700;color:${P};text-transform:uppercase;letter-spacing:.14em;">${label}</span>
          <div style="width:24px;height:2px;background:${P};border-radius:2px;"></div>
        </div>
        <h2 style="font-family:${TH};font-size:${TS+14}px;font-weight:700;color:${TX};letter-spacing:-.02em;margin-bottom:8px;">${title}</h2>
        <p style="font-family:${TB};font-size:${TS}px;color:${TX}77;max-width:400px;margin:0 auto;">${tagline}</p>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1.3fr;gap:40px;align-items:start;">
        <div style="display:flex;flex-direction:column;gap:12px;">${infoHtml}</div>
        <div style="background:${S};border-radius:${R*2}px;padding:34px;border:1.5px solid ${AC}22;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">${fields}</div>
          <textarea placeholder="Message…" rows="3" style="width:100%;padding:12px 16px;border:1.5px solid ${AC}44;border-radius:${R}px;font-family:${TB};font-size:${TS-1}px;color:${TX};background:${BG};resize:none;box-sizing:border-box;outline:none;margin-bottom:14px;display:block;"></textarea>
          <button style="width:100%;background:${P};color:${onPrimary};padding:14px 24px;border:none;border-radius:100px;font-family:${TH};font-size:${TS-1}px;font-weight:700;cursor:pointer;letter-spacing:.03em;text-transform:uppercase;">${cta} →</button>
        </div>
      </div>
    </div>
  </section>`;
}

/* ── FOOTER ── */
function buildFooter(cfg, ctx) {
  const { P,S,AC,TX,BG,TH,TB,TS,TL,R,PD,MW,name,desc,phone,address,imgs,sd,tmpl } = ctx;
  const sdF  = sd.footer || {};
  const fdesc= sdF.footerDesc || desc.substring(0, 88) + '…';
  const rawLinks = (sdF.footerLinks || '').split(';').map(x=>x.trim()).filter(Boolean);
  const linkItems= rawLinks.length ? rawLinks : ['Mentions légales','Politique de confidentialité'];
  const logoHtml = imgs.logo
    ? `<img src="${imgs.logo}" data-dv-img-id="logo" style="max-height:34px;object-fit:contain;cursor:pointer;display:block;" alt="Logo"/>`
    : `<span style="font-family:${TH};font-size:${TS+3}px;font-weight:700;color:#fff;letter-spacing:-.02em;">${name}</span>`;
  const rawNavItems = (sd.nav && sd.nav.navItems) ? sd.nav.navItems.split(';').map(x=>x.trim()).filter(Boolean) : tmpl.itemLabels.navItems;
  const navLinks = rawNavItems.map(l => `<a style="font-family:${TB};font-size:${TS-2}px;color:rgba(255,255,255,.5);text-decoration:none;">${l}</a>`).join('');
  return `<footer style="background:${TX};padding:${PD*0.8}px 0 ${PD*0.5}px;">
    <div style="max-width:${MW};margin:0 auto;padding:0 40px;">
      <div style="display:grid;grid-template-columns:1.6fr 1fr 1fr;gap:40px;padding-bottom:${PD*0.5}px;border-bottom:1px solid rgba(255,255,255,.07);margin-bottom:${PD*0.4}px;">
        <div>
          ${logoHtml}
          <p style="font-family:${TB};font-size:${TS-2}px;color:rgba(255,255,255,.42);line-height:${TL};margin-top:14px;max-width:250px;">${fdesc}</p>
        </div>
        <div>
          <div style="font-family:${TH};font-size:${TS-3}px;font-weight:700;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:16px;">Navigation</div>
          <div style="display:flex;flex-direction:column;gap:9px;">${navLinks}</div>
        </div>
        <div>
          <div style="font-family:${TH};font-size:${TS-3}px;font-weight:700;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:16px;">Contact</div>
          <div style="font-family:${TB};font-size:${TS-2}px;color:rgba(255,255,255,.5);line-height:2.0;">${phone}<br/>${address}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
        <span style="font-family:${TB};font-size:${TS-3}px;color:rgba(255,255,255,.28);">© ${new Date().getFullYear()} ${name} — Tous droits réservés</span>
        <div style="display:flex;gap:16px;">${linkItems.map(l=>`<a style="font-family:${TB};font-size:${TS-3}px;color:rgba(255,255,255,.28);text-decoration:none;">${l}</a>`).join('')}</div>
      </div>
    </div>
  </footer>`;
}

/* ════════════════════════════════════════════════════════════
   generatePreviewHTMLBase — Assemblage pour maquettes générées
════════════════════════════════════════════════════════════ */
function generatePreviewHTMLBase(cfg, sects) {
  const key = `${state.currentFolderId}_${state.currentTplId}`;
  const ctx = buildCtx(cfg, key);
  const { TB, TS, TL, BG, TX } = ctx;

  const SECTION_BUILDERS = {
    nav:          () => buildNav(cfg, ctx),
    hero:         () => buildHero(cfg, ctx),
    services:     () => buildServices(cfg, ctx),
    gallery:      () => buildGallery(cfg, ctx),
    cta:          () => buildCta(cfg, ctx),
    testimonials: () => buildTestimonials(cfg, ctx),
    pricing:      () => buildPricing(cfg, ctx),
    faq:          () => buildFAQ(cfg, ctx),
    contact:      () => buildContact(cfg, ctx),
    footer:       () => buildFooter(cfg, ctx),
  };

  const effectiveSects = sects || JSON.parse(JSON.stringify(DEFAULT_SECTIONS));
  const bodyHtml = effectiveSects
    .filter(s => s.visible !== false)
    .map(s => SECTION_BUILDERS[s.id] ? SECTION_BUILDERS[s.id]() : '')
    .join('\n');

  const dvImgScript = `<script>
(function(){
  var PRIMARY='${cfg.cPrimary}';
  document.addEventListener('click',function(e){
    var el=e.target.closest('[data-dv-img-id]');
    if(!el)return;
    e.preventDefault();e.stopPropagation();
    var id=el.getAttribute('data-dv-img-id');
    window.parent.postMessage({type:'DV_IMG_CLICK',imageId:id},'*');
  });
  document.addEventListener('contextmenu',function(e){
    var el=e.target.closest('[data-dv-img-id]');
    if(!el)return;
    e.preventDefault();
    var id=el.getAttribute('data-dv-img-id');
    var rect=el.getBoundingClientRect();
    window.parent.postMessage({type:'DV_IMG_CONTEXTMENU',imageId:id,x:e.clientX,y:e.clientY},'*');
  });
  document.querySelectorAll('.dv-gallery-overlay').forEach(function(ov){
    var par=ov.parentElement;var svg=ov.querySelector('svg');
    par.addEventListener('mouseenter',function(){ov.style.background='rgba(0,0,0,.38)';if(svg)svg.style.opacity='1';});
    par.addEventListener('mouseleave',function(){ov.style.background='rgba(0,0,0,0)';if(svg)svg.style.opacity='0';});
  });
  document.querySelectorAll('[data-dv-img-id]').forEach(function(el){
    if(el.tagName==='IMG'||el.querySelector('img'))return;
    el.addEventListener('mouseenter',function(){el.style.opacity='1';el.style.borderColor=PRIMARY;});
    el.addEventListener('mouseleave',function(){el.style.opacity='0.8';el.style.borderColor=PRIMARY+'66';});
  });
})();
<\/script>`;

  const globalStyles = `*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:${TB};background:${BG};color:${TX};font-size:${TS}px;line-height:${TL};}
a{text-decoration:none;}
input,textarea,select,button{font-family:inherit;}
input:focus,textarea:focus,select:focus{border-color:${cfg.cPrimary} !important;box-shadow:0 0 0 3px ${cfg.cPrimary}20;}`;

  return `<!DOCTYPE html><html lang="fr"><head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Outfit:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:ital,wght@0,400;0,500;1,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@400;600;700&family=Raleway:wght@400;600;700&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet"/>
<title>${ctx.name}</title>
<style>${globalStyles}</style>
</head><body>
${bodyHtml}
${dvImgScript}
</body></html>`;
}

/* ════════════════════════════════════════════════════════════
   generatePreviewHTML — Dispatcher principal
   CAS 1 : maquette importée → HTML brut + overrides CSS
   CAS 2 : maquette générée → generatePreviewHTMLBase()
════════════════════════════════════════════════════════════ */
function generatePreviewHTML(cfg) {
  const key = `${state.currentFolderId}_${state.currentTplId}`;
  const importedHtml = LS.get('dv_imported_html_' + key, null);

  if (importedHtml) {
    const sects = getSections(key);
    // Réordonner le HTML selon l'ordre/visibilité des sections si elles ont été parsées
    const rawHtml = (sects && sects.length > 0 && sects[0].id.startsWith('imported_'))
      ? reorderImportedHTML(importedHtml, sects)
      : importedHtml;

    const cleanHtml = rawHtml
      .replace(/<link[^>]+id="dv-fonts"[^>]*>/gi, '')
      .replace(/<style[^>]+id="dv-overrides"[^>]*>[\s\S]*?<\/style>/gi, '')
      .replace(/<script[^>]+id="dv-sections"[^>]*>[\s\S]*?<\/script>/gi, '');

    const overrideCSS = `
:root{
  --dv-primary:${cfg.cPrimary};--dv-secondary:${cfg.cSecondary};--dv-accent:${cfg.cAccent};
  --dv-text:${cfg.cText};--dv-bg:${cfg.cBg};
  --dv-font-heading:${cfg.tHeading};--dv-font-body:${cfg.tBody};
  --dv-size:${cfg.tSize}px;--dv-line:${cfg.tLine};
  --dv-padding:${cfg.sPadding}px;--dv-radius:${cfg.sRadius}px;--dv-maxw:${cfg.sMaxw};
}
body{font-family:var(--dv-font-body)!important;font-size:var(--dv-size)!important;line-height:var(--dv-line)!important;background-color:var(--dv-bg)!important;color:var(--dv-text)!important;}
h1,h2,h3,h4,h5,h6{font-family:var(--dv-font-heading)!important;color:var(--dv-text)!important;}
[class*="btn"],[class*="button"],[class*="cta"]{background-color:var(--dv-primary)!important;border-color:var(--dv-primary)!important;border-radius:var(--dv-radius)!important;}
header,nav,[class*="header"],[class*="navbar"]{${cfg.compNavbar==='solid'?`background-color:var(--dv-primary)!important;color:#fff!important;`:cfg.compNavbar==='border'?`background-color:var(--dv-bg)!important;border-bottom:2px solid var(--dv-primary)!important;`:`background:transparent!important;`}}
section,[class*="section"]{padding-top:var(--dv-padding)!important;padding-bottom:var(--dv-padding)!important;}
[class*="container"],[class*="wrapper"]{max-width:var(--dv-maxw)!important;}`;

    const savedCfg = state.templateConfigs[key] || {};
    const dvImages = JSON.stringify(savedCfg.images || {});
    const sectsData= JSON.stringify(sects.map(s=>({id:s.id,visible:s.visible})));

    const injected = cleanHtml
      .replace(/<\/head>/i, `<style id="dv-overrides">${overrideCSS}</style></head>`)
      .replace(/<\/body>/i, `<script id="dv-sections">
(function(){
  var imgs=${dvImages};
  Object.keys(imgs).forEach(function(id){
    var el=document.querySelector('[data-dv-img-id="'+id+'"]');
    if(el&&imgs[id]){if(el.tagName==='IMG'){el.src=imgs[id];}else{el.style.backgroundImage='url('+imgs[id]+')';el.style.backgroundSize='cover';el.style.backgroundPosition='center';}}
  });
  var PRIMARY='${cfg.cPrimary}';
  document.addEventListener('click',function(e){var el=e.target.closest('[data-dv-img-id]');if(!el)return;e.preventDefault();e.stopPropagation();window.parent.postMessage({type:'DV_IMG_CLICK',imageId:el.getAttribute('data-dv-img-id')},'*');});
  document.addEventListener('contextmenu',function(e){var el=e.target.closest('[data-dv-img-id]');if(!el)return;e.preventDefault();window.parent.postMessage({type:'DV_IMG_CONTEXTMENU',imageId:el.getAttribute('data-dv-img-id'),x:e.clientX,y:e.clientY},'*');});
})();
<\/script></body>`);

    return injected;
  }

  // CAS 2 : maquette générée
  const sects = getSections(key);
  return generatePreviewHTMLBase(cfg, sects);
}



/* ════════════════════════════════════════════════════════════
   PHASE 3 — Navigation, Éditeur, Panel, Sous-panneau, Aperçu
════════════════════════════════════════════════════════════ */

/* ── Toast ── */
let _toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

/* ── Preview globals ── */
let previewTimeout;
let _panelListenersAttached = false;
let _dvPendingImageId = null;

/* ── Device widths ── */
function getDeviceWidth() {
  if (state.currentDevice === 'tablet')  return 768;
  if (state.currentDevice === 'mobile')  return 390;
  return 1280;
}

/* ════════════════════════════════════════════════════════════
   NAVIGATION
════════════════════════════════════════════════════════════ */
function navigate(page, folderId, tplId) {
  // Quitter l'éditeur
  const edPage = document.getElementById('editor-page');
  edPage.classList.remove('active');
  document.getElementById('topbar').style.display = '';
  document.getElementById('page').style.display   = '';

  state.currentPage = page;

  // Navbar active state
  document.querySelectorAll('.nav-btn[data-page]').forEach(b => {
    const activePage = (page === 'folder-detail') ? 'home' : page;
    b.classList.toggle('active', b.dataset.page === activePage);
  });

  // Cacher toutes les pages
  ['home-page','folder-detail-page','projects-page'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });

  if (page === 'home') {
    document.getElementById('home-page').style.display = 'block';
    renderFolders();
  } else if (page === 'folder-detail') {
    state.currentFolderId = folderId;
    const el = document.getElementById('folder-detail-page');
    el.style.display = 'block';
    renderTemplates(folderId);
  } else if (page === 'projects') {
    const el = document.getElementById('projects-page');
    el.style.display = 'flex';
    el.style.flexDirection = 'column';
    initClients();
  } else if (page === 'editor') {
    openEditor(folderId, tplId);
  }
}

/* Navbar toggle */
document.getElementById('toggle-btn').addEventListener('click', () => {
  state.navExpanded = !state.navExpanded;
  document.getElementById('navbar').classList.toggle('expanded', state.navExpanded);
});

/* Navbar nav-btn clicks */
document.querySelectorAll('.nav-btn[data-page]').forEach(b => {
  b.addEventListener('click', () => navigate(b.dataset.page));
});

/* Back button (folder-detail → home) */
document.getElementById('back-btn').addEventListener('click', () => navigate('home'));

/* ════════════════════════════════════════════════════════════
   RENDER FOLDERS
════════════════════════════════════════════════════════════ */
function renderFolders() {
  const grid  = document.getElementById('folders-grid');
  const empty = document.getElementById('empty-state');
  const q     = state.searchQuery.toLowerCase().trim();
  const vis   = state.folders.filter(f => f.name.toLowerCase().includes(q));
  grid.innerHTML = '';
  empty.style.display = vis.length === 0 ? 'block' : 'none';
  vis.forEach((folder, i) => {
    const cnt  = (state.templates[folder.id] || []).length;
    const card = document.createElement('div');
    card.className = 'folder-card';
    card.style.animationDelay = (i * 0.04) + 's';
    card.innerHTML = `
      <button class="folder-info-btn" title="Supprimer ce dossier" data-del-folder="${folder.id}">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
      </button>
      <div class="folder-name">${esc(folder.name)}</div>
      <div class="folder-count">${cnt} maquette${cnt !== 1 ? 's' : ''}</div>`;
    card.addEventListener('click', e => {
      if (e.target.closest('[data-del-folder]')) return;
      navigate('folder-detail', folder.id);
    });
    card.querySelector('[data-del-folder]').addEventListener('click', e => {
      e.stopPropagation();
      if (!confirm(`Supprimer le dossier "${folder.name}" et toutes ses maquettes ?`)) return;
      state.folders = state.folders.filter(f => f.id !== folder.id);
      delete state.templates[folder.id];
      LS.set('dv_folders',   state.folders);
      LS.set('dv_templates', state.templates);
      renderFolders();
      showToast('🗑 Dossier supprimé');
    });
    grid.appendChild(card);
  });
}

/* ════════════════════════════════════════════════════════════
   RENDER TEMPLATES
════════════════════════════════════════════════════════════ */
const PREVIEW_STYLES = {
  light:  { hero:'#D9B8A4', line:'#e0dbd4', card:'#f0ece6' },
  dark:   { hero:'#3a3530', line:'#524d47', card:'#2a2520' },
  green:  { hero:'#2D6A4F', line:'#d0e8d9', card:'#b7dfc8' },
  violet: { hero:'#6B4F8A', line:'#d4c6e0', card:'#c2aed8' },
  blue:   { hero:'#2A5FA8', line:'#c4d8f0', card:'#a8c4e8' },
  warm:   { hero:'#C17B5E', line:'#f0ddd4', card:'#e8c8bb' },
};

function buildPreview(style) {
  const s = PREVIEW_STYLES[style] || PREVIEW_STYLES.light;
  return `<div class="preview-bar">
    <span class="preview-dot" style="background:#E8A999"></span>
    <span class="preview-dot" style="background:#E8D799"></span>
    <span class="preview-dot" style="background:#A8D8A8"></span>
  </div>
  <div class="preview-body">
    <div class="skel skel-hero" style="background:${s.hero}"></div>
    <div class="skel skel-line w100" style="background:${s.line};margin-top:3px"></div>
    <div class="skel skel-line w70"  style="background:${s.line}"></div>
    <div class="skel-grid">
      <div class="skel-card" style="background:${s.card}"></div>
      <div class="skel-card" style="background:${s.card}"></div>
      <div class="skel-card" style="background:${s.card}"></div>
      <div class="skel-card" style="background:${s.card}"></div>
    </div>
  </div>`;
}

function getMeta(folderId, tplId) {
  const key = `${folderId}_${tplId}`;
  if (!state.templateMeta[key]) state.templateMeta[key] = {
    name:'', tag:'Vitrine', status:'draft', client:'',
    created: new Date().toLocaleDateString('fr-FR'), tags:[], notes:'',
    devis:{ status:'draft', lines:[] }, historique:[]
  };
  return state.templateMeta[key];
}
function saveMeta() { LS.set('dv_meta', state.templateMeta); }

function renderTemplates(folderId) {
  const folder      = state.folders.find(f => f.id === folderId);
  const allTemplates= state.templates[folderId] || [];
  const q           = state.searchQuery.toLowerCase().trim();
  const templates   = q ? allTemplates.filter(t =>
    t.name.toLowerCase().includes(q) ||
    ((getMeta(folderId,t.id).tag||t.tag||'').toLowerCase().includes(q))
  ) : allTemplates;
  const grid  = document.getElementById('templates-grid');
  const empty = document.getElementById('templates-empty');
  document.getElementById('detail-title').textContent    = folder ? folder.name : 'Dossier';
  document.getElementById('detail-subtitle').textContent = `${allTemplates.length} maquette${allTemplates.length!==1?'s':''}${q?' (filtré)':''}`;
  grid.innerHTML = ''; empty.style.display = templates.length === 0 ? 'block' : 'none';
  templates.forEach((tpl, i) => {
    const meta = getMeta(folderId, tpl.id);
    const statusColors  = {draft:'#999',review:'#3A6AA0',validated:'#3A8040',accepted:'#3A8040',sent:'#C17B5E',delivered:'#C17B5E'};
    const statusLabels  = {draft:'Brouillon',review:'En révision',validated:'Validé',accepted:'Accepté',sent:'Envoyé',delivered:'Livré'};
    const status        = meta.status || 'draft';
    const card = document.createElement('div');
    card.className = 'template-card';
    card.style.animationDelay = (i * 0.05) + 's';
    card.innerHTML = `
      <div class="template-preview">${buildPreview(tpl.style || 'light')}</div>
      <div class="template-overlay">
        <button class="overlay-open-btn" data-open>
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Ouvrir
        </button>
        <button class="overlay-info-btn" data-info>
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          Infos
        </button>
      </div>
      <div class="template-card-body">
        <div class="template-name">${esc(tpl.name)}</div>
        <div class="template-meta">
          <span class="template-tag">${esc(meta.tag || tpl.tag || 'Vitrine')}</span>
          <span style="display:flex;align-items:center;gap:5px;">
            <span style="width:7px;height:7px;border-radius:50%;background:${statusColors[status]};display:inline-block;"></span>
            <span style="font-size:11px;color:${statusColors[status]}">${statusLabels[status]||'Brouillon'}</span>
          </span>
        </div>
      </div>`;
    card.querySelector('[data-open]').addEventListener('click', e => { e.stopPropagation(); openEditor(tpl.id, folderId); });
    card.querySelector('[data-info]').addEventListener('click', e => { e.stopPropagation(); openInfoDrawer(tpl.id, folderId); });
    card.addEventListener('click', () => openEditor(tpl.id, folderId));
    grid.appendChild(card);
  });
}

/* ════════════════════════════════════════════════════════════
   RECHERCHE
════════════════════════════════════════════════════════════ */
document.getElementById('search').addEventListener('input', e => {
  state.searchQuery = e.target.value;
  if (state.currentPage === 'home')          renderFolders();
  else if (state.currentPage === 'folder-detail') renderTemplates(state.currentFolderId);
});

/* ════════════════════════════════════════════════════════════
   MODALS — NOUVEAU DOSSIER / MAQUETTE
════════════════════════════════════════════════════════════ */
const modalOverlay = document.getElementById('modal-overlay');
const modalInput   = document.getElementById('modal-input');
const modalTitle   = document.getElementById('modal-title');
let _modalMode     = 'folder';
let _selectedSector= 'restaurant';

function openModal(mode) {
  _modalMode = mode;
  modalTitle.textContent     = mode === 'folder' ? 'Nouveau dossier' : 'Nouvelle maquette';
  modalInput.placeholder     = mode === 'folder' ? 'Nom du domaine (ex: Coiffure)' : 'Nom de la maquette';
  modalInput.value           = '';
  const sectorSel = document.getElementById('modal-sector');
  if (sectorSel) sectorSel.style.display = mode === 'template' ? 'block' : 'none';
  modalOverlay.classList.add('visible');
  setTimeout(() => modalInput.focus(), 60);
}
function closeModal() { modalOverlay.classList.remove('visible'); }

document.getElementById('add-folder-btn').addEventListener('click', () => openModal('folder'));
document.getElementById('add-template-btn').addEventListener('click', () => {
  // v15: ouvrir le sélecteur de secteur
  openSectorPicker();
});
document.getElementById('modal-cancel').addEventListener('click', closeModal);
modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });
document.getElementById('modal-confirm').addEventListener('click', handleModalConfirm);
modalInput.addEventListener('keydown', e => {
  if (e.key === 'Enter')  handleModalConfirm();
  if (e.key === 'Escape') closeModal();
});

function handleModalConfirm() {
  const name = modalInput.value.trim();
  if (!name) { modalInput.focus(); return; }
  if (_modalMode === 'folder') {
    const folder = { id: bumpId(), name };
    state.folders.push(folder);
    state.templates[folder.id] = [];
    LS.set('dv_folders',   state.folders);
    LS.set('dv_templates', state.templates);
    closeModal();
    renderFolders();
    showToast(`✅ Dossier "${name}" créé`);
  } else {
    const fid   = state.currentFolderId;
    const sector= _selectedSector || 'restaurant';
    if (!state.templates[fid]) state.templates[fid] = [];
    const styleKeys = Object.keys(PREVIEW_STYLES);
    const tpl = { id:bumpId(), name, tag:'Vitrine', sector, date:new Date().toLocaleDateString('fr-FR',{month:'short',year:'numeric'}), style:styleKeys[Math.floor(Math.random()*styleKeys.length)] };
    state.templates[fid].push(tpl);
    LS.set('dv_templates', state.templates);
    // Pré-remplir la config avec les valeurs sectorielle
    const key = `${fid}_${tpl.id}`;
    state.templateConfigs[key] = getDefaultConfig(sector);
    LS.set('dv_configs', state.templateConfigs);
    closeModal();
    renderTemplates(fid);
    showToast(`✅ Maquette "${name}" ajoutée`);
  }
}

/* ── Sélecteur de secteur ── */
const sectorOverlay = document.getElementById('sector-picker-overlay');
let _sectorPickerName = '';

function openSectorPicker() {
  _selectedSector = 'restaurant';
  // Remplir la grille des secteurs
  const grid = document.getElementById('sectors-grid');
  if (grid) {
    grid.innerHTML = '';
    Object.entries(SECTOR_TEMPLATES).forEach(([key, tmpl]) => {
      const card = document.createElement('div');
      card.style.cssText = `display:flex;align-items:center;gap:12px;padding:14px 16px;border:1.5px solid var(--accent-light);border-radius:10px;cursor:pointer;background:var(--bg-secondary);transition:all .2s;margin-bottom:8px;`;
      card.innerHTML = `<span style="font-size:24px;">${tmpl.emoji}</span><div><div style="font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:600;">${esc(tmpl.label)}</div><div style="font-family:'DM Sans',sans-serif;font-size:12px;color:var(--text-secondary);margin-top:2px;">${esc(tmpl.desc||'')}</div></div>`;
      card.addEventListener('click', () => {
        grid.querySelectorAll('div[data-sector]').forEach(c => c.style.borderColor = 'var(--accent-light)');
        card.style.borderColor = 'var(--accent)';
        _selectedSector = key;
      });
      card.dataset.sector = key;
      if (key === 'restaurant') card.style.borderColor = 'var(--accent)';
      grid.appendChild(card);
    });
  }
  sectorOverlay.classList.add('visible');
}

document.getElementById('sector-picker-close').addEventListener('click', () => sectorOverlay.classList.remove('visible'));
document.getElementById('sector-picker-cancel').addEventListener('click', () => sectorOverlay.classList.remove('visible'));
sectorOverlay.addEventListener('click', e => { if (e.target === sectorOverlay) sectorOverlay.classList.remove('visible'); });
document.getElementById('sector-picker-confirm').addEventListener('click', () => {
  sectorOverlay.classList.remove('visible');
  // Ouvrir la modal de nom
  _modalMode = 'template';
  modalTitle.textContent = 'Nouvelle maquette';
  modalInput.placeholder = 'Nom de la maquette (ex: Bistro Lumière)';
  modalInput.value = '';
  const sectorSel = document.getElementById('modal-sector');
  if (sectorSel) sectorSel.style.display = 'none';
  modalOverlay.classList.add('visible');
  setTimeout(() => modalInput.focus(), 60);
});

/* ════════════════════════════════════════════════════════════
   IMPORT HTML — Parsing des sections
════════════════════════════════════════════════════════════ */

/**
 * Parse les commentaires <!-- ═══ SECTION : NOM ═══ --> dans le HTML importé
 * et retourne un tableau de sections { id, label, visible }.
 * Si aucun commentaire trouvé, retourne un tableau vide.
 */
function parseImportedSections(html) {
  const rx = /<!--\s*[═=]{2,}\s*SECTION\s*:\s*([^═=\-]+?)\s*[═=\-]{0,}\s*-->/gi;
  const sections = [];
  const seen = new Set();
  let m;
  while ((m = rx.exec(html)) !== null) {
    const rawLabel = m[1].trim();
    const id = 'imported_' + rawLabel.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
    if (!seen.has(id)) {
      seen.add(id);
      sections.push({ id, label: rawLabel, visible: true });
    }
  }
  return sections;
}

/**
 * Réorganise le HTML importé selon l'ordre et la visibilité des sections.
 * Coupe le HTML aux commentaires de section, réassemble dans le bon ordre.
 */
function reorderImportedHTML(html, sections) {
  if (!sections || sections.length === 0) return html;

  // Extraire head + pré-premier-commentaire, et post-dernier-commentaire
  const rx = /<!--\s*[═=]{2,}\s*SECTION\s*:\s*([^═=\-]+?)\s*[═=\-]{0,}\s*-->/gi;

  // Trouver toutes les positions des commentaires de section
  const matches = [];
  let m;
  rx.lastIndex = 0;
  while ((m = rx.exec(html)) !== null) {
    const rawLabel = m[1].trim();
    const id = 'imported_' + rawLabel.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
    matches.push({ id, index: m.index, matchEnd: m.index + m[0].length });
  }

  if (matches.length === 0) return html;

  // Extraire le "bloc" de chaque section (du commentaire jusqu'au prochain commentaire ou fin de body)
  const bodyEndRx = /<\/body>/i;
  const bodyEndMatch = bodyEndRx.exec(html);
  const bodyEnd = bodyEndMatch ? bodyEndMatch.index : html.length;

  // Partie avant le premier commentaire (head + ouverture body + contenu pré-sections)
  const beforeFirst = html.substring(0, matches[0].index);

  // Partie après le dernier bloc de section (scripts finaux + </body></html>)
  const lastMatch = matches[matches.length - 1];
  const afterLast = html.substring(bodyEnd); // de </body> jusqu'à la fin

  // Construire un map id → contenu HTML du bloc
  const blockMap = {};
  matches.forEach((match, i) => {
    const start = match.index;
    const end = i + 1 < matches.length ? matches[i + 1].index : bodyEnd;
    const rawLabel = html.substring(match.index, match.matchEnd).replace(/<!--\s*[═=]{2,}\s*SECTION\s*:\s*/i, '').replace(/\s*[═=\-]{0,}\s*-->/, '').trim();
    blockMap[match.id] = html.substring(start, end);
  });

  // Réassembler dans l'ordre des sections configurées
  let body = '';
  sections.forEach(sec => {
    if (sec.visible !== false && blockMap[sec.id]) {
      body += blockMap[sec.id];
    }
  });

  return beforeFirst + body + afterLast;
}

document.getElementById('import-html-btn').addEventListener('click', () => {
  document.getElementById('import-html-name').value = '';
  document.getElementById('import-html-code').value = '';
  document.getElementById('import-html-overlay').classList.add('visible');
  setTimeout(() => document.getElementById('import-html-name').focus(), 60);
});
document.getElementById('import-html-close').addEventListener('click',   () => document.getElementById('import-html-overlay').classList.remove('visible'));
document.getElementById('import-html-cancel').addEventListener('click',  () => document.getElementById('import-html-overlay').classList.remove('visible'));
document.getElementById('import-html-overlay').addEventListener('click', e => { if (e.target === document.getElementById('import-html-overlay')) document.getElementById('import-html-overlay').classList.remove('visible'); });

document.getElementById('import-html-confirm').addEventListener('click', () => {
  const name = document.getElementById('import-html-name').value.trim();
  const html = document.getElementById('import-html-code').value.trim();
  if (!name || !html) { showToast('⚠️ Nom et code HTML requis'); return; }
  const fid = state.currentFolderId;
  if (!state.templates[fid]) state.templates[fid] = [];
  const styleKeys = Object.keys(PREVIEW_STYLES);
  const tpl = { id:bumpId(), name, tag:'Import HTML', date:new Date().toLocaleDateString('fr-FR',{month:'short',year:'numeric'}), style:styleKeys[Math.floor(Math.random()*styleKeys.length)] };
  state.templates[fid].push(tpl);
  LS.set('dv_templates', state.templates);
  const key = `${fid}_${tpl.id}`;
  const parsedSections = parseImportedSections(html);
  if (!state.templateConfigs[key]) state.templateConfigs[key] = getDefaultConfig('restaurant');
  if (parsedSections.length > 0) {
    state.templateConfigs[key].sections = parsedSections;
    state.templateConfigs[key]._isImported = true;
  }
  LS.set('dv_configs', state.templateConfigs);
  LS.set('dv_imported_html_' + key, html);
  document.getElementById('import-html-overlay').classList.remove('visible');
  renderTemplates(fid);
  showToast(`✅ Maquette "${name}" importée`);
});

/* ════════════════════════════════════════════════════════════
   ÉDITEUR — OUVERTURE
════════════════════════════════════════════════════════════ */
function openEditor(tplId, folderId) {
  const folder = state.folders.find(f => f.id === folderId);
  const tpl    = (state.templates[folderId] || []).find(t => t.id === tplId);
  if (!tpl) return;

  state.currentTplId    = tplId;
  state.currentFolderId = folderId;

  document.getElementById('topbar').style.display = 'none';
  document.getElementById('page').style.display   = 'none';
  document.getElementById('editor-page').classList.add('active');

  document.getElementById('editor-template-name').textContent = tpl.name;
  document.getElementById('editor-folder-name').textContent   = folder ? folder.name : '';

  const key = `${folderId}_${tplId}`;
  if (!state.templateConfigs[key]) state.templateConfigs[key] = getDefaultConfig(tpl.sector || 'restaurant');
  const cfg = state.templateConfigs[key];

  applyConfigToPanel(cfg);
  renderVersions(key);
  renderSectionsList(key);
  restoreMediaPanel(key, cfg);
  attachPanelListeners();
  setDevice('desktop');
  updatePreview();

  document.getElementById('editor-panel').classList.remove('hidden');
  document.getElementById('present-btn').classList.remove('presenting');
  closeSectionSubpanel();

  // Auto-save toutes les 60s
  if (window._autoSaveInterval) clearInterval(window._autoSaveInterval);
  window._autoSaveInterval = setInterval(() => {
    if (document.getElementById('editor-page').classList.contains('active')) {
      saveCurrentVersion(true);
    }
  }, 60000);
}

/* ════════════════════════════════════════════════════════════
   PANEL — TABS
════════════════════════════════════════════════════════════ */
document.querySelectorAll('.panel-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const t = tab.dataset.ptab;
    document.querySelectorAll('.panel-tab').forEach(x => x.classList.toggle('active', x.dataset.ptab === t));
    document.querySelectorAll('.panel-tab-content').forEach(x => x.classList.toggle('active', x.dataset.ptabContent === t));
    closeSectionSubpanel();
  });
});

/* Panel section accordions */
document.querySelectorAll('.panel-section-header').forEach(h => {
  h.addEventListener('click', () => h.closest('.panel-section').classList.toggle('collapsed'));
});

/* ════════════════════════════════════════════════════════════
   PANEL LISTENERS
════════════════════════════════════════════════════════════ */
function attachPanelListeners() {
  if (_panelListenersAttached) return;
  _panelListenersAttached = true;

  const simpleIds = [
    'c-primary','c-secondary','c-accent','c-text','c-bg',
    't-heading','t-body','s-maxw',
    'comp-navbar','comp-hero','comp-contact','comp-gallery',
    'cnt-name','cnt-tagline','cnt-desc','cnt-phone','cnt-address','cnt-cta'
  ];
  simpleIds.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input',  updatePreview);
    el.addEventListener('change', updatePreview);
  });

  const sliders = [
    { id:'t-size',        valId:'t-size-val',        suffix:'px' },
    { id:'t-line',        valId:'t-line-val',        suffix:''   },
    { id:'s-padding',     valId:'s-padding-val',     suffix:'px' },
    { id:'s-radius',      valId:'s-radius-val',      suffix:'px' },
    { id:'comp-services', valId:'comp-services-val', suffix:''   },
  ];
  sliders.forEach(({ id, valId, suffix }) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', e => {
      const vEl = document.getElementById(valId);
      if (vEl) vEl.textContent = e.target.value + suffix;
      updatePreview();
    });
  });
}

/* ════════════════════════════════════════════════════════════
   APERÇU IFRAME
════════════════════════════════════════════════════════════ */
function applyPreviewScale(iframe, iDoc) {
  try {
    const deviceW   = getDeviceWidth();
    const wrap      = document.getElementById('preview-frame-wrap');
    const scaleWrap = document.getElementById('preview-scale-wrap');
    const container = document.getElementById('preview-iframe-container');
    if (!wrap || !scaleWrap || !container) return;

    const availW = wrap.clientWidth - 40;
    if (!availW) return;

    const scale = Math.min(1, availW / deviceW);

    let contentH = 600;
    try {
      const b = iDoc.body, d = iDoc.documentElement;
      contentH = Math.max(b.scrollHeight, b.offsetHeight, d.scrollHeight, d.offsetHeight, 600);
    } catch(e) {}

    iframe.style.width     = deviceW + 'px';
    iframe.style.height    = contentH + 'px';
    container.style.width  = deviceW + 'px';
    container.style.height = contentH + 'px';

    scaleWrap.style.width        = deviceW + 'px';
    scaleWrap.style.height       = contentH + 'px';
    scaleWrap.style.transform    = `scale(${scale})`;
    scaleWrap.style.marginBottom = Math.ceil(contentH * scale - contentH) + 'px';
  } catch(e) {
    console.warn('[DV] applyPreviewScale error:', e);
  }
}

function updatePreview() {
  clearTimeout(previewTimeout);
  previewTimeout = setTimeout(() => {
    const cfg  = readConfigFromPanel();
    let   html = generatePreviewHTML(cfg);

    if (!/<meta[^>]+viewport/i.test(html)) {
      const vp = '<meta name="viewport" content="width=device-width,initial-scale=1"/>';
      if      (/<\/head>/i.test(html))    html = html.replace(/<\/head>/i, vp + '</head>');
      else if (/<head[^>]*>/i.test(html)) html = html.replace(/(<head[^>]*>)/i, '$1' + vp);
    }

    const iframe  = document.getElementById('preview-iframe');
    if (!iframe) return;
    const deviceW = getDeviceWidth();
    iframe.style.width  = deviceW + 'px';
    iframe.style.height = '600px';

    const onLoad = () => {
      iframe.removeEventListener('load', onLoad);
      const iDoc = iframe.contentDocument || iframe.contentWindow.document;
      applyPreviewScale(iframe, iDoc);
    };
    iframe.addEventListener('load', onLoad);
    iframe.srcdoc = html;

    setTimeout(() => {
      const iDoc = iframe.contentDocument || iframe.contentWindow.document;
      if (iDoc && iDoc.body) applyPreviewScale(iframe, iDoc);
    }, 400);
  }, 80);
}

function setDevice(device) {
  state.currentDevice = device;
  document.querySelectorAll('.device-btn').forEach(b => b.classList.toggle('active', b.dataset.device === device));
  const c = document.getElementById('preview-iframe-container');
  c.className = '';
  if (device === 'tablet') c.classList.add('device-tablet');
  else if (device === 'mobile') c.classList.add('device-mobile');
  updatePreview();
}

document.querySelectorAll('.device-btn').forEach(b => b.addEventListener('click', () => setDevice(b.dataset.device)));

/* Resize recalcule le scale */
let _resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(_resizeTimeout);
  _resizeTimeout = setTimeout(() => {
    const iframe = document.getElementById('preview-iframe');
    if (!iframe) return;
    const iDoc = iframe.contentDocument || iframe.contentWindow.document;
    if (iDoc && iDoc.body) applyPreviewScale(iframe, iDoc);
  }, 150);
});

/* ── Toggle panneau ── */
document.getElementById('toggle-panel-btn').addEventListener('click', () => {
  const panel = document.getElementById('editor-panel');
  panel.classList.toggle('hidden');
  setTimeout(() => {
    const iframe = document.getElementById('preview-iframe');
    if (!iframe) return;
    const iDoc = iframe.contentDocument || iframe.contentWindow.document;
    if (iDoc && iDoc.body) applyPreviewScale(iframe, iDoc);
  }, 320);
});

/* ── Présentation ── */
document.getElementById('present-btn').addEventListener('click', () => {
  state.presenting = !state.presenting;
  const panel = document.getElementById('editor-panel');
  const btn   = document.getElementById('present-btn');
  if (state.presenting) {
    panel.classList.add('hidden');
    btn.classList.add('presenting');
    btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>Quitter présentation`;
  } else {
    panel.classList.remove('hidden');
    btn.classList.remove('presenting');
    btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>Présentation`;
  }
  setTimeout(() => {
    const iframe = document.getElementById('preview-iframe');
    if (!iframe) return;
    const iDoc = iframe.contentDocument || iframe.contentWindow.document;
    if (iDoc && iDoc.body) applyPreviewScale(iframe, iDoc);
  }, 320);
});

/* ════════════════════════════════════════════════════════════
   VERSIONS
════════════════════════════════════════════════════════════ */
document.getElementById('save-btn').addEventListener('click', () => saveCurrentVersion(false));

function saveCurrentVersion(silent) {
  const key = `${state.currentFolderId}_${state.currentTplId}`;
  const cfg = readConfigFromPanel();
  // Préserver sectionData et images de la config existante
  const prev = state.templateConfigs[key] || {};
  state.templateConfigs[key] = { ...prev, ...cfg };
  LS.set('dv_configs', state.templateConfigs);

  if (!state.versions[key]) state.versions[key] = [];
  const now   = new Date();
  const label = now.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'}) + ' ' + now.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
  state.versions[key].unshift({ label, cfg: JSON.parse(JSON.stringify(state.templateConfigs[key])) });
  if (state.versions[key].length > 8) state.versions[key].pop();
  LS.set('dv_versions', state.versions);
  renderVersions(key);

  const ind = document.getElementById('save-indicator');
  ind.classList.add('visible');
  setTimeout(() => ind.classList.remove('visible'), 2500);
  if (!silent) showToast('✅ Version sauvegardée');
}

function renderVersions(key) {
  const list     = document.getElementById('versions-list');
  const versions = state.versions[key] || [];
  if (versions.length === 0) {
    list.innerHTML = `<div style="font-size:12px;color:var(--text-secondary);font-family:'DM Sans',sans-serif;">Aucune version sauvegardée.</div>`;
    return;
  }
  list.innerHTML = versions.map((v, i) => `
    <div class="version-item">
      <div class="version-dot ${i===0?'current':''}"></div>
      <div class="version-name">${esc(v.label)}</div>
      ${i > 0
        ? `<button class="version-restore" data-idx="${i}" data-key="${key}">Restaurer</button>`
        : `<span style="font-size:11px;color:var(--accent);font-weight:600">Actuelle</span>`}
    </div>`).join('');
  list.querySelectorAll('.version-restore').forEach(b => {
    b.addEventListener('click', () => {
      const v = state.versions[b.dataset.key][+b.dataset.idx];
      if (v) {
        state.templateConfigs[b.dataset.key] = JSON.parse(JSON.stringify(v.cfg));
        LS.set('dv_configs', state.templateConfigs);
        applyConfigToPanel(v.cfg);
        updatePreview();
        showToast('↩️ Version restaurée');
      }
    });
  });
}

/* ── Retour éditeur → folder-detail ── */
document.getElementById('editor-back-btn').addEventListener('click', () => {
  if (window._autoSaveInterval) clearInterval(window._autoSaveInterval);
  navigate('folder-detail', state.currentFolderId);
});

/* ════════════════════════════════════════════════════════════
   PANEL SECTIONS — renderSectionsList
════════════════════════════════════════════════════════════ */
function renderSectionsList(key) {
  const k     = key || `${state.currentFolderId}_${state.currentTplId}`;
  const sects = getSections(k);
  const list  = document.getElementById('sections-list');
  const addBtn = document.getElementById('add-section-btn');
  list.innerHTML = '';

  // Déterminer si c'est un import HTML avec sections parsées
  const isImportedWithSections = sects.length > 0 && sects[0].id && sects[0].id.startsWith('imported_');

  // Afficher/masquer le bouton "Ajouter une section"
  if (addBtn) addBtn.style.display = isImportedWithSections ? 'none' : '';

  // Afficher un bandeau info pour les imports
  let infoEl = document.getElementById('sections-import-info');
  if (isImportedWithSections) {
    if (!infoEl) {
      infoEl = document.createElement('div');
      infoEl.id = 'sections-import-info';
      infoEl.style.cssText = 'margin:0 12px 10px;padding:9px 12px;background:rgba(193,123,94,0.08);border:1.5px solid var(--accent-light);border-radius:8px;font-family:"DM Sans",sans-serif;font-size:11px;color:var(--text-secondary);line-height:1.5;';
      infoEl.innerHTML = '📋 Sections détectées via <code style="font-size:10px;background:rgba(0,0,0,.06);padding:1px 4px;border-radius:3px;">SECTION : NOM</code>';
      list.parentNode.insertBefore(infoEl, list);
    }
    infoEl.style.display = '';
  } else {
    if (infoEl) infoEl.style.display = 'none';
  }

  sects.forEach((s, i) => {
    const item = document.createElement('div');
    item.className  = 'section-item';
    item.draggable  = true;
    item.dataset.idx = i;
    const hasEdit = !!SECTION_DEFINITIONS[s.id];
    const canDelete = s.id && (s.id.startsWith('custom_') || s.id.startsWith('imported_'));
    item.innerHTML = `
      <span class="section-drag-handle" title="Glisser pour réorganiser">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="8" y1="18" x2="16" y2="18"/></svg>
      </span>
      <span class="section-item-label">${esc(s.label)}</span>
      <div class="section-item-actions">
        <button class="section-toggle ${s.visible?'':'hidden-section'}" title="${s.visible?'Masquer':'Afficher'}">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            ${s.visible
              ? '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>'
              : '<path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>'}
          </svg>
        </button>
        ${hasEdit ? `<button class="section-edit-btn" title="Éditer cette section">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>` : ''}
        ${canDelete ? `<button class="section-del-btn" title="Supprimer">×</button>` : ''}
      </div>`;

    // Toggle visibility
    item.querySelector('.section-toggle').addEventListener('click', () => {
      dvPushUndo();
      const sec = getSections(k);
      sec[i].visible = !sec[i].visible;
      saveSectionsToConfig(k, sec);
      renderSectionsList(k);
      updatePreview();
    });

    // Edit section
    const editBtn = item.querySelector('.section-edit-btn');
    if (editBtn) {
      editBtn.addEventListener('click', () => openSectionSubpanel(s.id, k));
    }

    // Delete (custom only)
    const delBtn = item.querySelector('.section-del-btn');
    if (delBtn) {
      delBtn.addEventListener('click', () => {
        const sec = getSections(k);
        sec.splice(i, 1);
        saveSectionsToConfig(k, sec);
        renderSectionsList(k);
        updatePreview();
        showToast('🗑 Section supprimée');
      });
    }

    // Drag & drop
    item.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', i); item.classList.add('dragging'); });
    item.addEventListener('dragend',   () => item.classList.remove('dragging'));
    item.addEventListener('dragover',  e => { e.preventDefault(); item.classList.add('drag-over'); });
    item.addEventListener('dragleave', () => item.classList.remove('drag-over'));
    item.addEventListener('drop',      e => {
      e.preventDefault();
      item.classList.remove('drag-over');
      const from = +e.dataTransfer.getData('text/plain');
      const to   = i;
      if (from === to) return;
      dvPushUndo();
      const sec = getSections(k);
      const [moved] = sec.splice(from, 1);
      sec.splice(to, 0, moved);
      saveSectionsToConfig(k, sec);
      renderSectionsList(k);
      updatePreview();
    });

    list.appendChild(item);
  });
}

function saveSectionsToConfig(key, sects) {
  if (!state.templateConfigs[key]) state.templateConfigs[key] = getDefaultConfig('restaurant');
  state.templateConfigs[key].sections = sects;
  LS.set('dv_configs', state.templateConfigs);
}

/* ── Ajouter une section ── */
const addSectionOverlay = document.getElementById('add-section-overlay');
document.getElementById('add-section-btn').addEventListener('click', () => {
  renderAvailableSections();
  addSectionOverlay.classList.add('visible');
});
document.getElementById('add-section-close').addEventListener('click', () => addSectionOverlay.classList.remove('visible'));
addSectionOverlay.addEventListener('click', e => { if (e.target === addSectionOverlay) addSectionOverlay.classList.remove('visible'); });

function renderAvailableSections() {
  const key   = `${state.currentFolderId}_${state.currentTplId}`;
  const sects = getSections(key);
  const presentIds = new Set(sects.map(s => s.id));
  const container  = document.getElementById('available-sections-list');
  if (!container) return;
  container.innerHTML = '';
  AVAILABLE_SECTIONS.forEach(avail => {
    const alreadyPresent = presentIds.has(avail.id);
    const item = document.createElement('div');
    item.className = 'avail-section-item';
    item.innerHTML = `
      <span class="avail-section-icon">${avail.icon}</span>
      <div class="avail-section-info">
        <div class="avail-section-name">${esc(avail.label)}</div>
        <div class="avail-section-desc">${esc(avail.desc)}</div>
      </div>
      ${alreadyPresent
        ? `<span style="font-size:11px;color:var(--text-secondary);">Déjà présente</span>`
        : `<button class="avail-section-add" data-id="${avail.id}">Ajouter</button>`}`;
    if (!alreadyPresent) {
      item.querySelector('.avail-section-add').addEventListener('click', () => {
        const sec = getSections(key);
        sec.push({ id: avail.id, label: avail.label, visible: true });
        saveSectionsToConfig(key, sec);
        renderSectionsList(key);
        updatePreview();
        addSectionOverlay.classList.remove('visible');
        showToast(`✅ Section "${avail.label}" ajoutée`);
      });
    }
    container.appendChild(item);
  });
}

/* ════════════════════════════════════════════════════════════
   SOUS-PANNEAU D'ÉDITION DE SECTION
════════════════════════════════════════════════════════════ */
let _subpanelSectionId = null;
let _subpanelKey       = null;

function openSectionSubpanel(sectionId, key) {
  _subpanelSectionId = sectionId;
  _subpanelKey       = key;
  const def = SECTION_DEFINITIONS[sectionId];
  if (!def) return;
  document.getElementById('subpanel-title').textContent = def.label;
  // Charger les données actuelles
  const cfg  = state.templateConfigs[key] || {};
  const data = (cfg.sectionData && cfg.sectionData[sectionId]) || {};
  renderSectionSubpanel(sectionId, key, data, def);
  document.getElementById('section-subpanel').classList.add('open');
}

function closeSectionSubpanel() {
  document.getElementById('section-subpanel').classList.remove('open');
  _subpanelSectionId = null;
}

document.getElementById('subpanel-back').addEventListener('click', closeSectionSubpanel);

function renderSectionSubpanel(sectionId, key, data, def) {
  const scroll = document.getElementById('subpanel-scroll');
  scroll.innerHTML = '';
  const cfg = state.templateConfigs[key] || {};
  const imgs= (cfg.images) || {};

  def.fields.forEach(field => {
    const fieldWrap = document.createElement('div');
    fieldWrap.className = 'subpanel-field';

    if (field.type === 'text') {
      fieldWrap.innerHTML = `
        <label>${esc(field.label)}</label>
        <input type="text" data-field="${esc(field.key)}" value="${esc(data[field.key]||'')}" placeholder="${esc(field.placeholder||'')}"/>`;
    } else if (field.type === 'textarea') {
      fieldWrap.innerHTML = `
        <label>${esc(field.label)}</label>
        <textarea data-field="${esc(field.key)}" placeholder="${esc(field.placeholder||'')}">${esc(data[field.key]||'')}</textarea>`;
    } else if (field.type === 'counter') {
      const curVal = data[field.key] !== undefined ? data[field.key] : (field.min || 1);
      fieldWrap.innerHTML = `
        <label>${esc(field.label)}</label>
        <div class="subpanel-counter">
          <button class="subpanel-counter-btn" data-counter-dec data-field="${esc(field.key)}" data-min="${field.min||1}" data-max="${field.max||10}">−</button>
          <span class="subpanel-counter-val" data-counter-val data-field="${esc(field.key)}">${curVal}</span>
          <button class="subpanel-counter-btn" data-counter-inc data-field="${esc(field.key)}" data-min="${field.min||1}" data-max="${field.max||10}">+</button>
        </div>`;
    } else if (field.type === 'image') {
      const imgId  = field.imageId || field.key;
      const imgSrc = imgs[imgId] || '';
      fieldWrap.innerHTML = `
        <label>${esc(field.label)}</label>
        <div class="subpanel-img-cell ${imgSrc?'has-img':''}" data-img-id="${esc(imgId)}" title="Cliquer pour changer">
          ${imgSrc ? `<img src="${imgSrc}" alt="${esc(field.label)}"/>` : ''}
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent-light)" stroke-width="1.5" ${imgSrc?'style="display:none"':''}>
            <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
          </svg>
          <span class="subpanel-img-label" ${imgSrc?'style="display:none"':''}>Cliquer pour ajouter</span>
        </div>`;
      fieldWrap.querySelector('.subpanel-img-cell').addEventListener('click', () => {
        _dvPendingImageId = imgId;
        const picker = document.getElementById('dv-img-picker');
        picker.value = ''; picker.click();
      });
    }

    scroll.appendChild(fieldWrap);
  });

  // Counter buttons
  scroll.querySelectorAll('[data-counter-dec],[data-counter-inc]').forEach(btn => {
    btn.addEventListener('click', () => {
      const fieldKey = btn.dataset.field;
      const valEl    = scroll.querySelector(`[data-counter-val][data-field="${fieldKey}"]`);
      let   cur      = parseInt(valEl.textContent, 10);
      const min      = +btn.dataset.min;
      const max      = +btn.dataset.max;
      if (btn.hasAttribute('data-counter-dec')) cur = Math.max(min, cur - 1);
      else                                       cur = Math.min(max, cur + 1);
      valEl.textContent = cur;
    });
  });
}

/* ── Bouton Appliquer ── */
document.getElementById('subpanel-apply').addEventListener('click', () => {
  if (!_subpanelSectionId || !_subpanelKey) return;
  dvPushUndo();
  const scroll = document.getElementById('subpanel-scroll');
  const newData= {};

  scroll.querySelectorAll('[data-field]').forEach(el => {
    const fk = el.dataset.field;
    if (!fk) return;
    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
      newData[fk] = el.value;
    } else if (el.hasAttribute('data-counter-val')) {
      newData[fk] = parseInt(el.textContent, 10);
    }
  });

  if (!state.templateConfigs[_subpanelKey]) state.templateConfigs[_subpanelKey] = getDefaultConfig('restaurant');
  if (!state.templateConfigs[_subpanelKey].sectionData) state.templateConfigs[_subpanelKey].sectionData = {};
  state.templateConfigs[_subpanelKey].sectionData[_subpanelSectionId] = {
    ...(state.templateConfigs[_subpanelKey].sectionData[_subpanelSectionId] || {}),
    ...newData
  };
  LS.set('dv_configs', state.templateConfigs);
  updatePreview();
  showToast('✅ Section mise à jour');
  closeSectionSubpanel();
});

/* ════════════════════════════════════════════════════════════
   MÉDIAS — Logo & Galerie
════════════════════════════════════════════════════════════ */
function restoreMediaPanel(key, cfg) {
  const logoImg  = document.getElementById('logo-preview-img');
  const logoZone = document.getElementById('logo-drop-zone');
  if (cfg.images && cfg.images.logo) {
    if (logoImg)  logoImg.src = cfg.images.logo;
    if (logoZone) logoZone.classList.add('has-logo');
  } else {
    if (logoImg)  logoImg.src = '';
    if (logoZone) logoZone.classList.remove('has-logo');
  }
  renderMediaGallery(key, cfg);
}

function renderMediaGallery(key, cfg) {
  const grid = document.getElementById('media-gallery-grid');
  if (!grid) return;
  const imgs = (cfg && cfg.images) || {};
  grid.innerHTML = '';
  grid.style.gridTemplateColumns = '1fr 1fr 1fr';

  const isImported = !!LS.get('dv_imported_html_' + key, null);

  if (isImported) {
    const uploadedIds = Object.keys(imgs).filter(id => id.startsWith('img_'));
    const storedHtml  = LS.get('dv_imported_html_' + key, '');
    const allImgIds   = new Set(uploadedIds);
    const idRx = /data-dv-img-id="(img_\d+)"/g;
    let m;
    while ((m = idRx.exec(storedHtml)) !== null) allImgIds.add(m[1]);
    const sortedIds = Array.from(allImgIds).sort((a,b) => parseInt(a.replace('img_',''),10) - parseInt(b.replace('img_',''),10));

    if (sortedIds.length === 0) {
      grid.innerHTML = `<div style="grid-column:1/-1;font-family:'DM Sans',sans-serif;font-size:12px;color:var(--text-secondary);">Aucune image détectée.</div>`;
      return;
    }
    sortedIds.forEach((id, i) => {
      const cell = document.createElement('div');
      cell.className = 'media-gallery-cell' + (imgs[id] ? ' has-img' : '');
      if (imgs[id]) {
        cell.innerHTML = `<img src="${imgs[id]}" style="width:100%;height:100%;object-fit:cover;display:block;position:absolute;inset:0;"/>`;
      } else {
        cell.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent-light)" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><span class="media-gallery-cell-label">#${i+1}</span>`;
      }
      cell.addEventListener('click', () => { _dvPendingImageId = id; const p = document.getElementById('dv-img-picker'); p.value=''; p.click(); });
      grid.appendChild(cell);
    });
    return;
  }

  // Galerie fixe 6 cases
  for (let i = 0; i < 6; i++) {
    const id   = 'gallery_' + i;
    const cell = document.createElement('div');
    cell.className = 'media-gallery-cell' + (imgs[id] ? ' has-img' : '');
    cell.title     = `Photo ${i+1} — cliquer pour changer`;
    if (imgs[id]) {
      cell.innerHTML = `<img src="${imgs[id]}" style="width:100%;height:100%;object-fit:cover;display:block;position:absolute;inset:0;"/>`;
    } else {
      cell.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent-light)" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><span class="media-gallery-cell-label">${i+1}</span>`;
    }
    cell.addEventListener('click', () => { _dvPendingImageId = id; const p = document.getElementById('dv-img-picker'); p.value=''; p.click(); });
    grid.appendChild(cell);
  }
}

/* Logo upload */
document.getElementById('logo-file-input').addEventListener('change', async e => {
  const file=e.target.files[0]; if(!file) return; showToast('⏳ Upload logo...');
  const reader=new FileReader();
  reader.onload=async ev=>{
    const key=`${state.currentFolderId}_${state.currentTplId}`;
    if(!state.templateConfigs[key]) state.templateConfigs[key]=getDefaultConfig('restaurant');
    if(!state.templateConfigs[key].images) state.templateConfigs[key].images={};
    try {
      const url=await window._dvST.upload(window._dvStoragePath(key+'_logo'),ev.target.result);
      state.templateConfigs[key].images.logo=url; LS.set('dv_configs',state.templateConfigs);
      const img=document.getElementById('logo-preview-img'); const zone=document.getElementById('logo-drop-zone');
      if(img) img.src=url; if(zone) zone.classList.add('has-logo');
      updatePreview(); showToast('Logo chargé');
    } catch(err){showToast('Erreur upload logo');console.error(err);}
  };
  reader.readAsDataURL(file);
});

/* ════════════════════════════════════════════════════════════
   IMAGE UPLOADER GLOBAL — picker + context menu
════════════════════════════════════════════════════════════ */
document.getElementById('dv-img-picker').addEventListener('change', async e => {
  const file=e.target.files[0]; if(!file||!_dvPendingImageId) return;
  showToast('Upload image...'); const pid=_dvPendingImageId; _dvPendingImageId=null;
  const reader=new FileReader();
  reader.onload=async ev=>{
    const key=`${state.currentFolderId}_${state.currentTplId}`;
    if(!state.templateConfigs[key]) state.templateConfigs[key]=getDefaultConfig('restaurant');
    if(!state.templateConfigs[key].images) state.templateConfigs[key].images={};
    try {
      const url=await window._dvST.upload(window._dvStoragePath(key+'_'+pid),ev.target.result);
      state.templateConfigs[key].images[pid]=url; LS.set('dv_configs',state.templateConfigs);
      updatePreview(); renderMediaGallery(key,state.templateConfigs[key]);
      if(pid==='logo'){
        const img=document.getElementById('logo-preview-img'); const zone=document.getElementById('logo-drop-zone');
        if(img) img.src=url; if(zone) zone.classList.add('has-logo');
      }
      if(_subpanelSectionId&&_subpanelKey){
        const def=SECTION_DEFINITIONS[_subpanelSectionId];
        const data=(state.templateConfigs[_subpanelKey].sectionData&&state.templateConfigs[_subpanelKey].sectionData[_subpanelSectionId])||{};
        if(def) renderSectionSubpanel(_subpanelSectionId,_subpanelKey,data,def);
      }
      showToast('Image chargee');
    } catch(err){showToast('Erreur upload');console.error(err);}
  };
  reader.readAsDataURL(file);
});

/* postMessage depuis l'iframe */
window.addEventListener('message', e => {
  if (!e.data) return;
  if (e.data.type === 'DV_IMG_CLICK') {
    _dvPendingImageId = e.data.imageId;
    const picker = document.getElementById('dv-img-picker');
    picker.value = ''; picker.click();
  } else if (e.data.type === 'DV_IMG_CONTEXTMENU') {
    showDvImgContextMenu(e.data.x, e.data.y, e.data.imageId);
  }
});

let _dvCtxMenuOpen = false;
function showDvImgContextMenu(iframeX, iframeY, imageId) {
  const menu      = document.getElementById('dv-img-ctx-menu');
  const iframe    = document.getElementById('preview-iframe');
  const iframeRect= iframe.getBoundingClientRect();
  const scaleWrap = document.getElementById('preview-scale-wrap');
  const scaleStr  = (scaleWrap && scaleWrap.style.transform) || 'scale(1)';
  const scaleMatch= scaleStr.match(/scale\(([\d.]+)\)/);
  const scale     = scaleMatch ? parseFloat(scaleMatch[1]) : 1;
  const pageX     = iframeRect.left + iframeX * scale;
  const pageY     = iframeRect.top  + iframeY * scale;
  menu.style.left = Math.min(pageX, window.innerWidth  - 180) + 'px';
  menu.style.top  = Math.min(pageY, window.innerHeight - 100) + 'px';
  menu.style.display = 'block';
  _dvCtxMenuOpen = true;
  document.getElementById('dv-ctx-change').onclick = () => {
    hideDvImgContextMenu();
    _dvPendingImageId = imageId;
    const picker = document.getElementById('dv-img-picker');
    picker.value = ''; picker.click();
  };
  document.getElementById('dv-ctx-delete').onclick = () => {
    hideDvImgContextMenu();
    dvDeleteImage(imageId);
  };
}
function hideDvImgContextMenu() {
  document.getElementById('dv-img-ctx-menu').style.display = 'none';
  _dvCtxMenuOpen = false;
}
document.addEventListener('click', e => {
  if (_dvCtxMenuOpen && !e.target.closest('#dv-img-ctx-menu')) hideDvImgContextMenu();
});

function dvDeleteImage(imageId) {
  const key = `${state.currentFolderId}_${state.currentTplId}`;
  if (!state.templateConfigs[key] || !state.templateConfigs[key].images) return;
  delete state.templateConfigs[key].images[imageId];
  if (imageId === 'logo') {
    const img  = document.getElementById('logo-preview-img');
    const zone = document.getElementById('logo-drop-zone');
    if (img)  { img.src = ''; }
    if (zone) zone.classList.remove('has-logo');
  }
  LS.set('dv_configs', state.templateConfigs);
  updatePreview();
  renderMediaGallery(key, state.templateConfigs[key]);
  showToast('🗑 Image supprimée');
}

/* ════════════════════════════════════════════════════════════
   EXPORT PDF
════════════════════════════════════════════════════════════ */
document.getElementById('export-pdf-btn').addEventListener('click', exportPDF);
function exportPDF() {
  const cfg      = readConfigFromPanel();
  const tpl      = (state.templates[state.currentFolderId]||[]).find(t=>t.id===state.currentTplId);
  const name     = cfg.cntName || (tpl ? tpl.name : 'Site');
  const date     = new Date().toLocaleDateString('fr-FR',{day:'2-digit',month:'long',year:'numeric'});
  const previewHtml = generatePreviewHTML(cfg);
  const bodyMatch   = previewHtml.match(/<body[^>]*>([\s\S]*)<\/body>/i);
  let bodyContent   = bodyMatch ? bodyMatch[1] : previewHtml;
  let headStyles    = '';
  const headMatch   = previewHtml.match(/<head[\s\S]*?<\/head>/i);
  if (headMatch) {
    const links  = headMatch[0].match(/<link[^>]+>/gi)  || [];
    const styles = headMatch[0].match(/<style[^>]*>[\s\S]*?<\/style>/gi) || [];
    headStyles   = [...links,...styles].join('\n');
  }
  const coverHtml = `<div style="padding:60px;background:#F0EFEB;min-height:100vh;display:flex;flex-direction:column;justify-content:space-between;page-break-after:always;font-family:'DM Sans',sans-serif;"><div style="font-family:serif;font-size:13px;letter-spacing:.15em;text-transform:uppercase;color:#C17B5E;">DRAFTVAULT — Proposition de site vitrine</div><div><div style="font-family:serif;font-size:42px;font-weight:700;color:#1A1A1A;margin-bottom:12px;">${esc(name)}</div><div style="font-size:16px;color:#666;margin-bottom:8px;">${esc(cfg.cntTagline||'Maquette web')}</div><div style="height:2px;background:#C17B5E;width:60px;margin:20px 0;"></div><div style="font-size:14px;color:#444;">${esc(cfg.cntAddress||'')}${cfg.cntPhone?' · '+esc(cfg.cntPhone):''}</div></div><div style="font-size:13px;color:#999;">Document généré le ${date}</div></div>`;
  const pdfDoc = `<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"/><title>Export — ${esc(name)}</title>${headStyles}<style>@media print{body{margin:0;}.dv-pdf-cover{page-break-after:always;}}@page{size:A4 landscape;margin:10mm;}body{margin:0;}</style></head><body>${coverHtml}<div>${bodyContent}</div><script>window.onload=function(){window.print();};<\/script></body></html>`;
  let win = null;
  try { win = window.open('','_blank','width=1200,height=900'); } catch(e) {}
  if (win && !win.closed) {
    try { win.document.write(pdfDoc); win.document.close(); showToast('📄 Fenêtre d\'impression ouverte'); return; }
    catch(e) { try { win.close(); } catch(e2) {} }
  }
  const blob = new Blob([pdfDoc],{type:'text/html;charset=utf-8'});
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(blob);
  a.download = (name.replace(/[^a-z0-9_\-]/gi,'_')||'maquette')+'-export.html';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(a.href),2000);
  showToast('📥 HTML téléchargé — ouvrez et imprimez (Ctrl+P)');
}

/* ════════════════════════════════════════════════════════════
   PANNEAU INFO MAQUETTE (drawer droit)
════════════════════════════════════════════════════════════ */
document.getElementById('info-btn').addEventListener('click', () => {
  openInfoDrawer(state.currentTplId, state.currentFolderId);
});

function openInfoDrawer(tplId, folderId) {
  if (!tplId || !folderId) return;
  state.currentTplId    = tplId;
  state.currentFolderId = folderId;
  const folder = state.folders.find(f => f.id === folderId);
  const tpl    = (state.templates[folderId]||[]).find(t => t.id === tplId);
  const meta   = getMeta(folderId, tplId);
  document.getElementById('info-drawer-title').textContent  = tpl  ? tpl.name   : 'Maquette';
  document.getElementById('info-drawer-folder').textContent = folder ? folder.name : '';
  const el = (id) => document.getElementById(id);
  if (el('info-tpl-name'))   el('info-tpl-name').value  = meta.name  || (tpl ? tpl.name : '');
  if (el('info-client-name'))el('info-client-name').value= meta.client|| '';
  if (el('info-status'))     el('info-status').value    = meta.status|| 'draft';
  if (el('info-notes'))      el('info-notes').value     = meta.notes || '';
  renderDrawerTags(meta.tags || []);
  renderHistorique(meta.historique || []);
  switchDrawerTab('info');
  document.getElementById('info-drawer-overlay').classList.add('visible');
  document.getElementById('info-drawer').classList.add('open');
}

function closeInfoDrawer() {
  document.getElementById('info-drawer-overlay').classList.remove('visible');
  document.getElementById('info-drawer').classList.remove('open');
}

document.getElementById('info-drawer-close').addEventListener('click', closeInfoDrawer);
document.getElementById('info-drawer-overlay').addEventListener('click', closeInfoDrawer);

function switchDrawerTab(tab) {
  document.querySelectorAll('.drawer-tab').forEach(t => t.classList.toggle('active', t.dataset.dtab === tab));
  document.querySelectorAll('.drawer-tab-content').forEach(c => c.classList.toggle('active', c.id === 'dtab-' + tab));
}
document.querySelectorAll('.drawer-tab').forEach(t => t.addEventListener('click', () => switchDrawerTab(t.dataset.dtab)));

function renderDrawerTags(tags) {
  const wrap = document.getElementById('tags-wrap');
  if (!wrap) return;
  wrap.innerHTML = tags.map(tag => `
    <div class="tag-item">${esc(tag)}<button class="tag-remove" data-tag="${esc(tag)}">×</button></div>`).join('');
  wrap.querySelectorAll('.tag-remove').forEach(b => {
    b.addEventListener('click', () => {
      const key  = `${state.currentFolderId}_${state.currentTplId}`;
      const meta = getMeta(state.currentFolderId, state.currentTplId);
      meta.tags  = meta.tags.filter(t => t !== b.dataset.tag);
      saveMeta();
      renderDrawerTags(meta.tags);
    });
  });
}

document.getElementById('tag-add-btn').addEventListener('click', () => {
  const input = document.getElementById('tag-input');
  const tag   = input.value.trim();
  if (!tag) return;
  const meta  = getMeta(state.currentFolderId, state.currentTplId);
  if (!meta.tags.includes(tag)) meta.tags.push(tag);
  saveMeta(); input.value = ''; renderDrawerTags(meta.tags);
});
document.getElementById('tag-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('tag-add-btn').click();
});

function renderHistorique(historique) {
  const body = document.getElementById('history-body');
  if (!body) return;
  if (!historique || historique.length === 0) {
    body.innerHTML = `<div style="font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text-secondary);padding:16px 0;">Aucune entrée d'historique.</div>`;
    return;
  }
  body.innerHTML = historique.slice().reverse().map(h =>
    `<div style="display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid rgba(217,184,164,.3);">
      <div style="font-family:'DM Sans',sans-serif;font-size:12px;color:var(--text-secondary);white-space:nowrap;flex-shrink:0;">${esc(h.date||'')}</div>
      <div style="font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text-main);">${esc(h.note||'')}</div>
    </div>`
  ).join('');
}

document.getElementById('info-save-btn').addEventListener('click', () => {
  const meta = getMeta(state.currentFolderId, state.currentTplId);
  const el   = (id) => document.getElementById(id);
  if (el('info-tpl-name'))    meta.name   = el('info-tpl-name').value.trim();
  if (el('info-client-name')) meta.client = el('info-client-name').value.trim();
  if (el('info-status'))      meta.status = el('info-status').value;
  if (el('info-notes'))       meta.notes  = el('info-notes').value;
  saveMeta();
  // Mettre à jour le nom dans le template
  const tpl = (state.templates[state.currentFolderId]||[]).find(t => t.id === state.currentTplId);
  if (tpl && meta.name) tpl.name = meta.name;
  LS.set('dv_templates', state.templates);
  document.getElementById('editor-template-name').textContent = meta.name || (tpl ? tpl.name : '');
  showToast('✅ Infos sauvegardées');
  closeInfoDrawer();
});

/* ════════════════════════════════════════════════════════════
   CLIENTS / PROJETS (stub)
════════════════════════════════════════════════════════════ */
function initClients() {
  const grid  = document.getElementById('projects-grid');
  const empty = document.getElementById('projects-empty');
  const clients = state.clients || [];
  grid.innerHTML = ''; empty.style.display = clients.length === 0 ? 'block' : 'none';
  clients.forEach((client, i) => {
    const card = document.createElement('div');
    card.className = 'project-card';
    card.style.animationDelay = (i * 0.04) + 's';
    card.innerHTML = `
      <div class="project-card-header">
        <div>
          <div class="project-card-name">${esc(client.name)}</div>
          <div class="project-card-company">${esc(client.company||'')}</div>
        </div>
        <div class="project-card-actions">
          <button class="project-card-del-btn" data-del="${client.id}">Supprimer</button>
        </div>
      </div>
      <div class="project-card-meta">
        ${client.phone ? `<span>📞 ${esc(client.phone)}</span>` : ''}
        ${client.email ? `<span>✉️ ${esc(client.email)}</span>` : ''}
      </div>`;
    card.querySelector('[data-del]').addEventListener('click', e => {
      e.stopPropagation();
      if (!confirm(`Supprimer le client "${client.name}" ?`)) return;
      state.clients = state.clients.filter(c => c.id !== client.id);
      LS.set('dv_clients', state.clients);
      initClients();
      showToast('🗑 Client supprimé');
    });
    grid.appendChild(card);
  });
}

document.getElementById('add-client-btn').addEventListener('click', () => {
  const name = prompt('Nom du client :');
  if (!name) return;
  const client = { id: bumpId(), name, company:'', phone:'', email:'' };
  state.clients.push(client);
  LS.set('dv_clients', state.clients);
  initClients();
  showToast(`✅ Client "${name}" créé`);
});

/* ════════════════════════════════════════════════════════════
   NOTES
════════════════════════════════════════════════════════════ */
function openNotes() {
  document.getElementById('notes-overlay').classList.add('visible');
  document.getElementById('notes-panel').classList.add('open');
  renderNotesList();
}
function closeNotes() {
  document.getElementById('notes-overlay').classList.remove('visible');
  document.getElementById('notes-panel').classList.remove('open');
}
document.getElementById('notes-nav-btn').addEventListener('click', openNotes);
document.getElementById('notes-close').addEventListener('click', closeNotes);
document.getElementById('notes-overlay').addEventListener('click', closeNotes);
document.getElementById('new-note-btn').addEventListener('click', () => {
  const note = { id: bumpId(), title:'Nouvelle note', content:'', date: new Date().toLocaleDateString('fr-FR') };
  state.notes.unshift(note);
  LS.set('dv_notes', state.notes);
  renderNotesList();
  selectNote(note.id);
});

function renderNotesList() {
  const list = document.getElementById('notes-list');
  list.innerHTML = '';
  state.notes.forEach(note => {
    const item = document.createElement('div');
    item.className = 'note-item' + (state.activeNoteId === note.id ? ' active' : '');
    item.innerHTML = `<div class="note-item-title">${esc(note.title||'Note')}</div><div class="note-item-date">${esc(note.date||'')}</div>`;
    item.addEventListener('click', () => selectNote(note.id));
    list.appendChild(item);
  });
}

function selectNote(id) {
  state.activeNoteId = id;
  const note = state.notes.find(n => n.id === id);
  if (!note) return;
  const hint    = document.getElementById('note-empty-hint');
  const titleEl = document.getElementById('note-title-input');
  const contEl  = document.getElementById('note-content-input');
  hint.style.display    = 'none';
  titleEl.style.display = 'block';
  contEl.style.display  = 'block';
  titleEl.value = note.title || '';
  contEl.value  = note.content || '';
  renderNotesList();
  const saveNote = () => {
    note.title   = titleEl.value;
    note.content = contEl.value;
    LS.set('dv_notes', state.notes);
    renderNotesList();
  };
  titleEl.oninput = saveNote;
  contEl.oninput  = saveNote;
}

/* ════════════════════════════════════════════════════════════
   SYNC (import / export JSON)
════════════════════════════════════════════════════════════ */
function openSync()  { document.getElementById('sync-overlay').classList.add('visible'); }
function closeSync() { document.getElementById('sync-overlay').classList.remove('visible'); }
document.getElementById('sync-nav-btn').addEventListener('click', openSync);
document.getElementById('sync-close').addEventListener('click',   closeSync);
document.getElementById('sync-overlay').addEventListener('click', e => { if (e.target === document.getElementById('sync-overlay')) closeSync(); });

document.getElementById('sync-export-all').addEventListener('click', () => {
  const data = {
    dv_folders:    state.folders,
    dv_templates:  state.templates,
    dv_configs:    state.templateConfigs,
    dv_meta:       state.templateMeta,
    dv_clients:    state.clients,
    dv_notes:      state.notes,
    dv_versions:   state.versions,
    dv_nextId:     state.nextId,
    exported:      new Date().toISOString(),
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(blob);
  a.download = 'draftvault-backup-' + new Date().toLocaleDateString('fr-FR').replace(/\//g,'-') + '.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(a.href), 2000);
  showToast('📦 Export téléchargé');
});

document.getElementById('sync-export-configs').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify({dv_configs:state.templateConfigs}, null, 2)], {type:'application/json'});
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(blob);
  a.download = 'draftvault-configs.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(a.href), 2000);
  showToast('📦 Configs exportées');
});

document.getElementById('sync-import-file').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (data.dv_folders)   { state.folders          = data.dv_folders;   LS.set('dv_folders', state.folders); }
      if (data.dv_templates) { state.templates         = data.dv_templates; LS.set('dv_templates', state.templates); }
      if (data.dv_configs)   { state.templateConfigs   = data.dv_configs;   LS.set('dv_configs', state.templateConfigs); }
      if (data.dv_meta)      { state.templateMeta      = data.dv_meta;      LS.set('dv_meta', state.templateMeta); }
      if (data.dv_clients)   { state.clients           = data.dv_clients;   LS.set('dv_clients', state.clients); }
      if (data.dv_notes)     { state.notes             = data.dv_notes;     LS.set('dv_notes', state.notes); }
      if (data.dv_versions)  { state.versions          = data.dv_versions;  LS.set('dv_versions', state.versions); }
      if (data.dv_nextId)    { state.nextId            = data.dv_nextId;    LS.set('dv_nextId', state.nextId); }
      closeSync();
      navigate('home');
      showToast('✅ Données importées avec succès');
    } catch(err) {
      showToast('❌ Fichier JSON invalide');
    }
  };
  reader.readAsText(file);
});

/* ════════════════════════════════════════════════════════════
   RACCOURCIS & RÉGLAGES (stub minimal)
════════════════════════════════════════════════════════════ */
// openShortcuts / openSettings délèguent toujours à window.renderShortcutsInfo/Editor
// qui sont définies plus bas. Aucune dépendance au stub local.
function openShortcuts() {
  document.getElementById('shortcuts-overlay').classList.add('visible');
  if (typeof window.renderShortcutsInfo === 'function') window.renderShortcutsInfo();
}
function closeShortcuts() { document.getElementById('shortcuts-overlay').classList.remove('visible'); }
function openSettings() {
  document.getElementById('settings-overlay').classList.add('visible');
  if (typeof window.renderShortcutsEditor === 'function') window.renderShortcutsEditor();
}
function closeSettings() { document.getElementById('settings-overlay').classList.remove('visible'); }

document.getElementById('shortcuts-nav-btn').addEventListener('click', openShortcuts);
document.getElementById('shortcuts-close').addEventListener('click',   closeShortcuts);
document.getElementById('shortcuts-overlay').addEventListener('click', e => { if (e.target === document.getElementById('shortcuts-overlay')) closeShortcuts(); });
document.getElementById('settings-nav-btn').addEventListener('click',  openSettings);
document.getElementById('settings-close').addEventListener('click',    closeSettings);
document.getElementById('settings-overlay').addEventListener('click',  e => { if (e.target === document.getElementById('settings-overlay')) closeSettings(); });

/* ════════════════════════════════════════════════════════════
   RACCOURCIS CLAVIER GLOBAUX
════════════════════════════════════════════════════════════ */
document.addEventListener('keydown', e => {
  const typing       = ['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName);
  const editorActive = document.getElementById('editor-page').classList.contains('active');

  // Escape → fermer tout
  if (e.key === 'Escape') {
    closeModal(); closeInfoDrawer(); closeShortcuts(); closeSettings(); closeSync(); closeNotes();
    closeSectionSubpanel();
    if (state.presenting) document.getElementById('present-btn').click();
    document.getElementById('add-section-overlay').classList.remove('visible');
    document.getElementById('sector-picker-overlay').classList.remove('visible');
    document.getElementById('import-html-overlay').classList.remove('visible');
    return;
  }

  if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); if (editorActive && !window._dv4ShortcutsActive) saveCurrentVersion(false); return; }
  if ((e.ctrlKey || e.metaKey) && e.key === 'p') { e.preventDefault(); if (editorActive && !window._dv4ShortcutsActive) document.getElementById('present-btn').click(); return; }
  if ((e.ctrlKey || e.metaKey) && e.key === 'e') { e.preventDefault(); if (editorActive && !window._dv4ShortcutsActive) exportPDF(); return; }
  if ((e.ctrlKey || e.metaKey) && e.key === 'f' && !editorActive) { e.preventDefault(); if (!window._dv4ShortcutsActive) document.getElementById('search').focus(); return; }
  if ((e.ctrlKey || e.metaKey) && e.key === 'n' && !typing) { e.preventDefault(); if (!window._dv4ShortcutsActive) { if (state.currentPage === 'home') openModal('folder'); else if (state.currentPage === 'folder-detail') openSectorPicker(); } return; }

  // Vues device dans l'éditeur
  if (editorActive && !typing) {
    if (e.key === '1') { setDevice('desktop'); return; }
    if (e.key === '2') { setDevice('tablet');  return; }
    if (e.key === '3') { setDevice('mobile');  return; }
  }

  // Backspace → retour
  if (e.key === 'Backspace' && !typing && state.currentPage === 'folder-detail') { navigate('home'); return; }
});

/* ════════════════════════════════════════════════════════════
   INITIALISATION
════════════════════════════════════════════════════════════ */
/* ════════════════════════════════════════════════════════════
   PHASE 4 — Historique, Devis, Clients, Raccourcis, Notes++,
             Miniatures colorées, Undo/Redo éditeur
════════════════════════════════════════════════════════════ */

/* ════════════════════════════════════════════════════════════
   1. addHistoryEntry(key, note)
════════════════════════════════════════════════════════════ */
function addHistoryEntry(key, note) {
  const [fid, tid] = key.split('_');
  const meta = getMeta(fid, tid);
  if (!meta.historique) meta.historique = [];
  const now = new Date();
  const date = now.toLocaleDateString('fr-FR', { day:'2-digit', month:'short' }) + ' '
             + now.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
  meta.historique.unshift({ date, note });
  if (meta.historique.length > 30) meta.historique.pop();
  saveMeta();
}

/* ── Hook addHistoryEntry dans saveCurrentVersion via rebind du save-btn ──
   On rebind le bouton save et l'autosave pour injecter addHistoryEntry */
(function() {
  const saveBtn = document.getElementById('save-btn');
  if (saveBtn) {
    const fresh = saveBtn.cloneNode(true);
    saveBtn.replaceWith(fresh);
    fresh.addEventListener('click', () => {
      saveCurrentVersion(false);
      const key = `${state.currentFolderId}_${state.currentTplId}`;
      addHistoryEntry(key, 'Version sauvegardée manuellement');
    });
  }
})();

/* ════════════════════════════════════════════════════════════
   PATCH — renderTemplates et openEditor : router vers les versions Phase 4
   Appelé après le chargement complet de Phase 4
════════════════════════════════════════════════════════════ */
(function patchPhase3Refs() {
  // Les fonctions Phase 3 appellent renderTemplates() en référence locale.
  // On remplace la référence locale en rebindant les événements qui déclenchent renderTemplates.

  // 1. Bouton retour sur folder-detail est déjà OK (navigate → window.renderTemplates via navigate)
  // 2. Import HTML confirm
  const importConfirmBtn = document.getElementById('import-html-confirm');
  if (importConfirmBtn) {
    const fresh = importConfirmBtn.cloneNode(true);
    importConfirmBtn.replaceWith(fresh);
    fresh.addEventListener('click', () => {
      const name = document.getElementById('import-html-name').value.trim();
      const html = document.getElementById('import-html-code').value.trim();
      if (!name || !html) { showToast('⚠️ Nom et code HTML requis'); return; }
      const fid = state.currentFolderId;
      if (!state.templates[fid]) state.templates[fid] = [];
      const styleKeys = Object.keys(PREVIEW_STYLES);
      const tpl = { id:bumpId(), name, tag:'Import HTML', date:new Date().toLocaleDateString('fr-FR',{month:'short',year:'numeric'}), style:styleKeys[Math.floor(Math.random()*styleKeys.length)] };
      state.templates[fid].push(tpl);
      LS.set('dv_templates', state.templates);
      const key = `${fid}_${tpl.id}`;
      const parsedSections = parseImportedSections(html);
      if (!state.templateConfigs[key]) state.templateConfigs[key] = getDefaultConfig('restaurant');
      if (parsedSections.length > 0) {
        state.templateConfigs[key].sections = parsedSections;
        state.templateConfigs[key]._isImported = true;
      }
      LS.set('dv_configs', state.templateConfigs);
      LS.set('dv_imported_html_' + key, html);
      document.getElementById('import-html-overlay').classList.remove('visible');
      addHistoryEntry(key, 'Import HTML créé');
      window.renderTemplates(fid);
      showToast(`✅ Maquette "${name}" importée`);
    });
  }

})();

/* ── Patch switchDrawerTab pour charger le devis à la volée ── */
const _origSwitchDrawerTab = switchDrawerTab;
window.switchDrawerTab = function(tab) {
  _origSwitchDrawerTab(tab);
  if (tab === 'devis') renderDevis(state.currentFolderId, state.currentTplId);
  if (tab === 'history') {
    const meta = getMeta(state.currentFolderId, state.currentTplId);
    renderHistorique(meta.historique || []);
  }
};
// Re-bind drawer tab clicks avec la version patchée
document.querySelectorAll('.drawer-tab').forEach(t => {
  t.replaceWith(t.cloneNode(true)); // retirer les anciens listeners
});
document.querySelectorAll('.drawer-tab').forEach(t => {
  t.addEventListener('click', () => window.switchDrawerTab(t.dataset.dtab));
});

/* ════════════════════════════════════════════════════════════
   2. DEVIS — renderDevis
════════════════════════════════════════════════════════════ */
function renderDevis(folderId, tplId) {
  const body = document.getElementById('devis-body');
  if (!body || !folderId || !tplId) return;
  const meta = getMeta(folderId, tplId);
  if (!meta.devis) meta.devis = { status:'draft', lines:[] };
  const devis = meta.devis;

  const statusLabels = { draft:'Brouillon', sent:'Envoyé', accepted:'Accepté' };

  function calcTotal() {
    return (devis.lines || []).reduce((s, l) => s + (+(l.qty||0)) * (+(l.unitPrice||0)), 0);
  }

  function saveAndRender() {
    saveMeta();
    renderDevis(folderId, tplId);
  }

  body.innerHTML = `
    <!-- En-tête statut -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
      <span class="devis-status ${devis.status}">${statusLabels[devis.status]||'Brouillon'}</span>
      <select id="devis-status-sel" style="flex:1;padding:5px 8px;border:1.5px solid var(--accent-light);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:12px;background:var(--bg-main);color:var(--text-main);outline:none;">
        <option value="draft"    ${devis.status==='draft'   ?'selected':''}>Brouillon</option>
        <option value="sent"     ${devis.status==='sent'    ?'selected':''}>Envoyé</option>
        <option value="accepted" ${devis.status==='accepted'?'selected':''}>Accepté</option>
      </select>
    </div>

    <!-- En-têtes colonnes -->
    <div style="display:grid;grid-template-columns:1fr 56px 72px 72px 28px;gap:6px;padding:0 0 6px;border-bottom:1.5px solid var(--accent-light);margin-bottom:8px;">
      <span style="font-family:'Space Grotesk',sans-serif;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-secondary);">Prestation</span>
      <span style="font-family:'Space Grotesk',sans-serif;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-secondary);text-align:center;">Qté</span>
      <span style="font-family:'Space Grotesk',sans-serif;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-secondary);text-align:right;">P.U.</span>
      <span style="font-family:'Space Grotesk',sans-serif;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text-secondary);text-align:right;">Total</span>
      <span></span>
    </div>

    <!-- Lignes -->
    <div id="devis-lines-container"></div>

    <!-- Total HT -->
    <div class="devis-total-row">
      <span class="devis-total-label">Total HT</span>
      <span class="devis-total-amount" id="devis-total-display">${calcTotal().toFixed(2)} €</span>
    </div>

    <!-- Actions -->
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">
      <button id="devis-add-line-btn" style="flex:1;padding:9px;border:1.5px dashed var(--accent-light);border-radius:7px;background:transparent;font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all .2s;">+ Ajouter une ligne</button>
      <button id="devis-copy-btn" style="padding:9px 14px;border:1.5px solid var(--accent-light);border-radius:7px;background:transparent;font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:600;color:var(--text-main);cursor:pointer;white-space:nowrap;transition:all .2s;">📋 Copier</button>
    </div>`;

  /* Rendre les lignes */
  function renderLines() {
    const container = document.getElementById('devis-lines-container');
    if (!container) return;
    container.innerHTML = '';
    (devis.lines || []).forEach((line, i) => {
      const lineTotal = (+(line.qty||0)) * (+(line.unitPrice||0));
      const row = document.createElement('div');
      row.style.cssText = 'display:grid;grid-template-columns:1fr 56px 72px 72px 28px;gap:6px;margin-bottom:8px;align-items:center;';
      row.innerHTML = `
        <input class="dv-line-label" data-idx="${i}" type="text" value="${esc(line.label||'')}" placeholder="Ex: Maquette web…"
          style="padding:7px 9px;border:1.5px solid var(--accent-light);border-radius:6px;font-family:'DM Sans',sans-serif;font-size:13px;background:var(--bg-main);color:var(--text-main);outline:none;width:100%;"/>
        <input class="dv-line-qty" data-idx="${i}" type="number" value="${line.qty||1}" min="0" step="0.5"
          style="padding:7px 6px;border:1.5px solid var(--accent-light);border-radius:6px;font-family:'DM Sans',sans-serif;font-size:13px;background:var(--bg-main);color:var(--text-main);outline:none;text-align:center;width:100%;"/>
        <input class="dv-line-price" data-idx="${i}" type="number" value="${line.unitPrice||0}" min="0" step="10"
          style="padding:7px 6px;border:1.5px solid var(--accent-light);border-radius:6px;font-family:'DM Sans',sans-serif;font-size:13px;background:var(--bg-main);color:var(--text-main);outline:none;text-align:right;width:100%;"/>
        <div style="font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:600;color:var(--text-main);text-align:right;padding-right:2px;">${lineTotal.toFixed(0)} €</div>
        <button class="dv-line-del" data-idx="${i}"
          style="background:none;border:none;cursor:pointer;color:var(--text-secondary);font-size:18px;line-height:1;opacity:.5;padding:2px;transition:opacity .2s,color .2s;"
          onmouseenter="this.style.opacity='1';this.style.color='var(--danger)'"
          onmouseleave="this.style.opacity='.5';this.style.color='var(--text-secondary)'">×</button>`;
      container.appendChild(row);
    });

    /* Listeners sur les inputs */
    container.querySelectorAll('.dv-line-label').forEach(inp => {
      inp.addEventListener('input', e => {
        devis.lines[+e.target.dataset.idx].label = e.target.value;
        saveMeta(); updateTotal();
      });
    });
    container.querySelectorAll('.dv-line-qty').forEach(inp => {
      inp.addEventListener('input', e => {
        devis.lines[+e.target.dataset.idx].qty = +e.target.value;
        saveMeta(); renderLines(); updateTotal();
      });
    });
    container.querySelectorAll('.dv-line-price').forEach(inp => {
      inp.addEventListener('input', e => {
        devis.lines[+e.target.dataset.idx].unitPrice = +e.target.value;
        saveMeta(); renderLines(); updateTotal();
      });
    });
    container.querySelectorAll('.dv-line-del').forEach(btn => {
      btn.addEventListener('click', e => {
        devis.lines.splice(+e.target.dataset.idx, 1);
        saveMeta(); renderLines(); updateTotal();
      });
    });
  }

  function updateTotal() {
    const tot = document.getElementById('devis-total-display');
    if (tot) tot.textContent = calcTotal().toFixed(2) + ' €';
  }

  renderLines();

  /* Statut */
  document.getElementById('devis-status-sel').addEventListener('change', e => {
    devis.status = e.target.value;
    saveMeta();
    // Mettre à jour le badge
    const badge = body.querySelector('.devis-status');
    if (badge) { badge.className = `devis-status ${devis.status}`; badge.textContent = statusLabels[devis.status]; }
  });

  /* Ajouter une ligne */
  document.getElementById('devis-add-line-btn').addEventListener('click', () => {
    if (!devis.lines) devis.lines = [];
    devis.lines.push({ id: bumpId(), label:'', qty:1, unitPrice:0 });
    saveMeta(); renderLines(); updateTotal();
  });
  document.getElementById('devis-add-line-btn').addEventListener('mouseenter', e => {
    e.target.style.borderColor='var(--accent)'; e.target.style.color='var(--accent)';
  });
  document.getElementById('devis-add-line-btn').addEventListener('mouseleave', e => {
    e.target.style.borderColor='var(--accent-light)'; e.target.style.color='var(--text-secondary)';
  });

  /* Copier le devis */
  document.getElementById('devis-copy-btn').addEventListener('click', () => {
    const tpl  = (state.templates[folderId]||[]).find(t => t.id === tplId);
    const name = (meta.name || (tpl ? tpl.name : 'Client'));
    const date = new Date().toLocaleDateString('fr-FR');
    let txt = `DEVIS — ${name}\nDate : ${date}\nStatut : ${statusLabels[devis.status]||'Brouillon'}\n\n`;
    txt += '─'.repeat(52) + '\n';
    txt += 'Prestation'.padEnd(28) + 'Qté'.padStart(6) + 'P.U.'.padStart(10) + 'Total'.padStart(10) + '\n';
    txt += '─'.repeat(52) + '\n';
    (devis.lines || []).forEach(l => {
      const tot = ((+(l.qty||0)) * (+(l.unitPrice||0))).toFixed(0);
      txt += (l.label||'—').substring(0,26).padEnd(28)
           + String(l.qty||0).padStart(6)
           + (String(l.unitPrice||0)+' €').padStart(10)
           + (tot+' €').padStart(10) + '\n';
    });
    txt += '─'.repeat(52) + '\n';
    txt += 'TOTAL HT'.padEnd(44) + (calcTotal().toFixed(2)+' €').padStart(8) + '\n';
    navigator.clipboard.writeText(txt).then(
      () => showToast('📋 Devis copié dans le presse-papier'),
      () => showToast('⚠️ Copie non supportée dans ce navigateur')
    );
  });
}

/* ════════════════════════════════════════════════════════════
   3. CLIENTS — Modal complète
════════════════════════════════════════════════════════════ */

/* Fermer la modal client */
document.getElementById('client-modal-close').addEventListener('click', () => {
  document.getElementById('client-modal-overlay').classList.remove('visible');
});
document.getElementById('client-modal-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('client-modal-overlay'))
    document.getElementById('client-modal-overlay').classList.remove('visible');
});

function openClientModal(clientId) {
  const isEdit = !!clientId;
  const client = isEdit ? state.clients.find(c => c.id === clientId) : null;
  document.getElementById('client-modal-title').textContent = isEdit ? 'Modifier le client' : 'Nouveau client';

  document.getElementById('client-modal-body').innerHTML = `
    <div class="client-fields-grid">
      <div class="client-field" style="grid-column:1/-1;">
        <label>Nom *</label>
        <input type="text" id="cm-name" value="${esc(client ? client.name : '')}" placeholder="Jean Dupont…"/>
      </div>
      <div class="client-field">
        <label>Entreprise</label>
        <input type="text" id="cm-company" value="${esc(client ? client.company||'' : '')}" placeholder="Nom de la société…"/>
      </div>
      <div class="client-field">
        <label>Statut</label>
        <select id="cm-status">
          <option value="prospect"  ${(!client||client.status==='prospect') ?'selected':''}>Prospect</option>
          <option value="active"    ${(client&&client.status==='active')    ?'selected':''}>Actif</option>
          <option value="completed" ${(client&&client.status==='completed') ?'selected':''}>Terminé</option>
          <option value="paused"    ${(client&&client.status==='paused')    ?'selected':''}>En pause</option>
        </select>
      </div>
      <div class="client-field">
        <label>Téléphone</label>
        <input type="tel" id="cm-phone" value="${esc(client ? client.phone||'' : '')}" placeholder="06 00 00 00 00"/>
      </div>
      <div class="client-field">
        <label>Email</label>
        <input type="email" id="cm-email" value="${esc(client ? client.email||'' : '')}" placeholder="client@exemple.fr"/>
      </div>
      <div class="client-field" style="grid-column:1/-1;">
        <label>Notes libres</label>
        <textarea id="cm-notes" placeholder="Infos utiles, préférences, historique…">${esc(client ? client.notes||'' : '')}</textarea>
      </div>
    </div>
    <button class="client-save-btn" id="cm-save-btn">
      ${isEdit ? '✅ Enregistrer les modifications' : '✅ Créer le client'}
    </button>
    ${isEdit ? `<button id="cm-delete-btn" style="width:100%;padding:10px;margin-top:8px;border:1.5px solid rgba(231,76,60,.3);border-radius:8px;background:transparent;color:var(--danger);font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:background .2s;">🗑 Supprimer ce client</button>` : ''}`;

  document.getElementById('cm-save-btn').addEventListener('click', () => {
    const name = document.getElementById('cm-name').value.trim();
    if (!name) { showToast('⚠️ Le nom est obligatoire'); document.getElementById('cm-name').focus(); return; }
    if (isEdit) {
      const c  = state.clients.find(c => c.id === clientId);
      c.name    = name;
      c.company = document.getElementById('cm-company').value.trim();
      c.status  = document.getElementById('cm-status').value;
      c.phone   = document.getElementById('cm-phone').value.trim();
      c.email   = document.getElementById('cm-email').value.trim();
      c.notes   = document.getElementById('cm-notes').value.trim();
      showToast(`✅ Client "${name}" mis à jour`);
    } else {
      state.clients.push({
        id:      bumpId(),
        name,
        company: document.getElementById('cm-company').value.trim(),
        status:  document.getElementById('cm-status').value,
        phone:   document.getElementById('cm-phone').value.trim(),
        email:   document.getElementById('cm-email').value.trim(),
        notes:   document.getElementById('cm-notes').value.trim(),
      });
      showToast(`✅ Client "${name}" créé`);
    }
    LS.set('dv_clients', state.clients);
    document.getElementById('client-modal-overlay').classList.remove('visible');
    initClients();
    refreshClientSelectInDrawer();
  });

  if (isEdit) {
    document.getElementById('cm-delete-btn').addEventListener('click', () => {
      if (!confirm(`Supprimer définitivement "${client.name}" ?`)) return;
      state.clients = state.clients.filter(c => c.id !== clientId);
      LS.set('dv_clients', state.clients);
      document.getElementById('client-modal-overlay').classList.remove('visible');
      initClients();
      refreshClientSelectInDrawer();
      showToast('🗑 Client supprimé');
    });
  }

  // Focus
  document.getElementById('client-modal-overlay').classList.add('visible');
  setTimeout(() => document.getElementById('cm-name').focus(), 80);
}

/* Remplacer initClients avec la version complète */
window.initClients = function() {
  const grid    = document.getElementById('projects-grid');
  const empty   = document.getElementById('projects-empty');
  const clients = state.clients || [];
  grid.innerHTML = ''; empty.style.display = clients.length === 0 ? 'block' : 'none';

  const statusColor = { prospect:'#666', active:'#3A8040', completed:'#3A6AA0', paused:'#8A5A10' };
  const statusLabel = { prospect:'Prospect', active:'Actif', completed:'Terminé', paused:'En pause' };
  const avatarColors= ['#C17B5E','#2D6A4F','#6B4F8A','#2A5FA8','#B88A1A','#5A3A3A'];

  clients.forEach((client, i) => {
    const initials   = (client.name || '?').split(' ').map(w => w[0]).slice(0,2).join('').toUpperCase();
    const color      = avatarColors[i % avatarColors.length];
    const status     = client.status || 'prospect';
    const card       = document.createElement('div');
    card.className   = 'project-card';
    card.style.cursor= 'pointer';
    card.style.animationDelay = (i * 0.04) + 's';
    card.innerHTML   = `
      <div class="project-card-header">
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="width:42px;height:42px;border-radius:50%;background:${color};display:flex;align-items:center;justify-content:center;flex-shrink:0;">
            <span style="font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:700;color:#fff;">${esc(initials)}</span>
          </div>
          <div>
            <div class="project-card-name">${esc(client.name)}</div>
            <div class="project-card-company">${esc(client.company||'')}</div>
          </div>
        </div>
        <span class="client-status-badge status-${status}">${statusLabel[status]||status}</span>
      </div>
      <div class="project-card-meta" style="margin-top:12px;">
        ${client.phone ? `<span>📞 ${esc(client.phone)}</span>` : ''}
        ${client.email ? `<span>✉️ ${esc(client.email)}</span>`  : ''}
      </div>
      ${client.notes ? `<div style="margin-top:10px;font-family:'DM Sans',sans-serif;font-size:12px;color:var(--text-secondary);line-height:1.5;border-top:1px solid rgba(217,184,164,.3);padding-top:8px;">${esc(client.notes.substring(0,100))}${client.notes.length>100?'…':''}</div>` : ''}`;
    card.addEventListener('click', () => openClientModal(client.id));
    grid.appendChild(card);
  });
};

/* Remplacer le listener "Ajouter un client" (cloner pour retirer l'ancien) */
(function() {
  const btn = document.getElementById('add-client-btn');
  const fresh = btn.cloneNode(true);
  btn.replaceWith(fresh);
  fresh.addEventListener('click', () => openClientModal());
})();

/* ── Dans le drawer info : remplacer le champ texte client par un <select> ── */
function refreshClientSelectInDrawer() {
  const wrap = document.getElementById('info-client-name');
  if (!wrap) return;
  // Transformer en select si c'est encore un input
  if (wrap.tagName === 'INPUT' || wrap.tagName === 'SELECT') {
    const sel = document.createElement('select');
    sel.id    = 'info-client-name';
    sel.style.cssText = wrap.style.cssText;
    sel.className     = wrap.className;
    const noneOpt = document.createElement('option');
    noneOpt.value = ''; noneOpt.textContent = '— Aucun client —';
    sel.appendChild(noneOpt);
    (state.clients || []).forEach(c => {
      const opt = document.createElement('option');
      opt.value       = c.name;
      opt.textContent = c.name + (c.company ? ` (${c.company})` : '');
      sel.appendChild(opt);
    });
    // Restaurer la valeur courante
    const meta = getMeta(state.currentFolderId, state.currentTplId);
    sel.value = meta.client || '';
    wrap.replaceWith(sel);
  }
}

/* ════════════════════════════════════════════════════════════
   4. RACCOURCIS PERSONNALISABLES
════════════════════════════════════════════════════════════ */
const DEFAULT_SHORTCUTS = [
  { id:'save',    label:'Sauvegarder',        default:'ctrl+s' },
  { id:'present', label:'Mode présentation',  default:'ctrl+p' },
  { id:'export',  label:'Exporter PDF',       default:'ctrl+e' },
  { id:'search',  label:'Rechercher',         default:'ctrl+f' },
  { id:'new',     label:'Nouveau',            default:'ctrl+n' },
  { id:'undo',    label:'Annuler (Undo)',      default:'ctrl+z' },
  { id:'dev1',    label:'Vue Desktop',        default:'1' },
  { id:'dev2',    label:'Vue Tablette',       default:'2' },
  { id:'dev3',    label:'Vue Mobile',         default:'3' },
];

function loadShortcuts() { return LS.get('dv_shortcuts', JSON.parse(JSON.stringify(DEFAULT_SHORTCUTS))); }
function saveShortcutsData(sc) { LS.set('dv_shortcuts', sc); }

function formatShortcutKey(raw) {
  if (!raw) return '—';
  return raw.split('+').map(p => {
    if (p === 'ctrl')  return 'Ctrl';
    if (p === 'shift') return 'Shift';
    if (p === 'alt')   return 'Alt';
    return p.toUpperCase();
  }).join('+');
}

function matchShortcut(e, raw) {
  if (!raw) return false;
  const parts = raw.toLowerCase().split('+');
  const key   = parts[parts.length - 1];
  const ctrl  = parts.includes('ctrl');
  const shift = parts.includes('shift');
  const alt   = parts.includes('alt');
  const eKey  = e.key.length === 1 ? e.key.toLowerCase() : e.key.toLowerCase();
  return (!!e.ctrlKey === ctrl) && (!!e.shiftKey === shift) && (!!e.altKey === alt) && (eKey === key);
}

/* Remplacer renderShortcutsInfo() pour afficher avec les raccourcis personnalisés */
window.renderShortcutsInfo = function() {
  const body = document.getElementById('shortcuts-body');
  if (!body) return;
  const sc = loadShortcuts();
  body.innerHTML = sc.map(s =>
    `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(217,184,164,.3);">
      <span style="font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text-main);">${esc(s.label)}</span>
      <kbd style="font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:600;background:var(--bg-secondary);border:1.5px solid var(--accent-light);border-radius:5px;padding:3px 8px;">${esc(formatShortcutKey(s.default))}</kbd>
    </div>`
  ).join('') + `
    <div style="margin-top:14px;font-family:'DM Sans',sans-serif;font-size:12px;color:var(--text-secondary);line-height:1.5;padding:10px 12px;background:rgba(193,123,94,.06);border-radius:8px;">
      💡 Personnalisez vos raccourcis dans <strong>Réglages</strong>.
    </div>`;
};

/* renderShortcutsEditor dans les réglages */
window.renderShortcutsEditor = function() {
  const list = document.getElementById('shortcuts-editor-list');
  if (!list) return;
  const sc = loadShortcuts();
  list.innerHTML = '';

  sc.forEach((s, i) => {
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid rgba(217,184,164,.3);';
    row.innerHTML = `
      <div style="flex:1;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text-main);">${esc(s.label)}</div>
      <input type="text" class="sc-capture" data-idx="${i}" value="${esc(formatShortcutKey(s.default))}"
        readonly placeholder="Cliquez…"
        style="width:130px;text-align:center;padding:6px 10px;border:1.5px solid var(--accent-light);border-radius:7px;font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:600;background:var(--bg-main);color:var(--text-main);cursor:pointer;outline:none;transition:border-color .2s;"/>`;
    list.appendChild(row);

    const inp = row.querySelector('.sc-capture');
    inp.addEventListener('focus', () => { inp.style.borderColor='var(--accent)'; inp.style.background='rgba(193,123,94,.06)'; inp.value='Appuyez sur une touche…'; });
    inp.addEventListener('blur',  () => { inp.style.borderColor='var(--accent-light)'; inp.style.background='var(--bg-main)'; inp.value = formatShortcutKey(sc[i].default); });
    inp.addEventListener('keydown', e => {
      e.preventDefault(); e.stopPropagation();
      if (['Control','Shift','Alt','Meta'].includes(e.key)) return;
      const parts = [];
      if (e.ctrlKey)  parts.push('ctrl');
      if (e.shiftKey) parts.push('shift');
      if (e.altKey)   parts.push('alt');
      const k = e.key.length === 1 ? e.key.toLowerCase() : e.key.toLowerCase();
      parts.push(k);
      const raw = parts.join('+');
      sc[i].default = raw;
      inp.value = formatShortcutKey(raw);
      inp.blur();
    });
  });

  // Boutons bas
  const actions = list.nextElementSibling || (() => {
    const d = document.createElement('div');
    d.style.cssText = 'display:flex;gap:10px;margin-top:18px;';
    list.after(d); return d;
  })();
  // Les boutons sont déjà dans le HTML (#shortcuts-reset-btn, #shortcuts-save-btn)
  // On rebranche les listeners en les cloant pour éviter les doublons
  const resetBtn = document.getElementById('shortcuts-reset-btn');
  const saveBtn  = document.getElementById('shortcuts-save-btn');
  if (resetBtn) {
    const r2 = resetBtn.cloneNode(true); resetBtn.replaceWith(r2);
    r2.addEventListener('click', () => {
      const fresh = JSON.parse(JSON.stringify(DEFAULT_SHORTCUTS));
      saveShortcutsData(fresh);
      window.renderShortcutsEditor();
      window.renderShortcutsInfo();
      showToast('↩️ Raccourcis réinitialisés');
    });
  }
  if (saveBtn) {
    const s2 = saveBtn.cloneNode(true); saveBtn.replaceWith(s2);
    s2.addEventListener('click', () => {
      saveShortcutsData(sc);
      window.renderShortcutsInfo();
      closeSettings();
      showToast('✅ Raccourcis sauvegardés');
    });
  }
};

/* Remplacer le keydown global par une version qui lit loadShortcuts() */
(function() {
  // Activer le flag pour désactiver les raccourcis hardcodés Phase 3
  window._dv4ShortcutsActive = true;

  // On ajoute un second listener en capture qui intercepte les raccourcis configurables
  // Le listener original Phase 3 reste pour Escape, Backspace, chiffres device
  document.addEventListener('keydown', function dvShortcuts4(e) {
    const typing       = ['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName);
    const editorActive = document.getElementById('editor-page').classList.contains('active');
    if (e.key === 'Escape') return; // déjà géré

    const sc = loadShortcuts();
    const get = id => (sc.find(s => s.id === id) || {}).default;

    // Undo Ctrl+Z
    if (matchShortcut(e, get('undo')) && editorActive) { e.preventDefault(); dvUndo(); return; }
    // Sauvegarder
    if (matchShortcut(e, get('save')) && editorActive && !typing) { e.preventDefault(); window.saveCurrentVersion(false); return; }
    // Présentation
    if (matchShortcut(e, get('present')) && editorActive) { e.preventDefault(); document.getElementById('present-btn').click(); return; }
    // Export
    if (matchShortcut(e, get('export')) && editorActive) { e.preventDefault(); exportPDF(); return; }
    // Recherche
    if (matchShortcut(e, get('search')) && !editorActive && !typing) { e.preventDefault(); document.getElementById('search').focus(); return; }
    // Nouveau
    if (matchShortcut(e, get('new')) && !typing) {
      e.preventDefault();
      if (state.currentPage === 'home') openModal('folder');
      else if (state.currentPage === 'folder-detail') openSectorPicker();
      return;
    }
    // Vues device (gardées dans listener original aussi, mais on couvre ici les personnalisées)
    if (!typing && editorActive) {
      if (matchShortcut(e, get('dev1'))) { setDevice('desktop'); return; }
      if (matchShortcut(e, get('dev2'))) { setDevice('tablet');  return; }
      if (matchShortcut(e, get('dev3'))) { setDevice('mobile');  return; }
    }
  }, true); // capture pour priorité
})();

/* ════════════════════════════════════════════════════════════
   5. NOTES — suppression & duplication
════════════════════════════════════════════════════════════ */
/* Remplacer renderNotesList avec une version enrichie */
window.renderNotesList = function() {
  const list = document.getElementById('notes-list');
  list.innerHTML = '';
  state.notes.forEach(note => {
    const item = document.createElement('div');
    item.className = 'note-item' + (state.activeNoteId === note.id ? ' active' : '');
    item.innerHTML = `
      <div style="flex:1;min-width:0;">
        <div class="note-item-title">${esc(note.title||'Note')}</div>
        <div class="note-item-date">${esc(note.date||'')}</div>
      </div>
      <button class="note-del-btn" data-id="${note.id}" title="Supprimer"
        style="background:none;border:none;cursor:pointer;color:var(--text-secondary);opacity:.4;font-size:16px;line-height:1;padding:4px;flex-shrink:0;border-radius:4px;transition:opacity .2s,color .2s;"
        onmouseenter="this.style.opacity='1';this.style.color='var(--danger)'"
        onmouseleave="this.style.opacity='.4';this.style.color='var(--text-secondary)'">×</button>`;
    item.style.cssText = 'display:flex;align-items:center;gap:4px;';
    item.addEventListener('click', e => {
      if (e.target.closest('.note-del-btn')) return;
      selectNote(note.id);
    });
    item.querySelector('.note-del-btn').addEventListener('click', e => {
      e.stopPropagation();
      const hasContent = !!(note.title && note.title !== 'Nouvelle note') || !!note.content;
      if (hasContent && !confirm(`Supprimer la note "${note.title}" ?`)) return;
      const idx = state.notes.findIndex(n => n.id === note.id);
      state.notes.splice(idx, 1);
      LS.set('dv_notes', state.notes);
      // Si c'était la note active, sélectionner la suivante ou vider
      if (state.activeNoteId === note.id) {
        state.activeNoteId = null;
        const next = state.notes[Math.max(0, idx - 1)];
        if (next) selectNote(next.id);
        else {
          document.getElementById('note-empty-hint').style.display = '';
          document.getElementById('note-title-input').style.display  = 'none';
          document.getElementById('note-content-input').style.display = 'none';
        }
      }
      window.renderNotesList();
    });
    list.appendChild(item);
  });
};

/* Bouton "Dupliquer" — injecter dans notes-header-actions si pas déjà présent */
(function() {
  const actions = document.querySelector('.notes-header-actions');
  if (!actions || document.getElementById('dup-note-btn')) return;
  const btn = document.createElement('button');
  btn.id          = 'dup-note-btn';
  btn.title       = 'Dupliquer la note sélectionnée';
  btn.textContent = '⎘ Dupliquer';
  btn.style.cssText = 'display:none;'; // masqué par défaut, affiché quand note active
  actions.insertBefore(btn, document.getElementById('notes-close'));
  btn.addEventListener('click', () => {
    if (!state.activeNoteId) return;
    const orig = state.notes.find(n => n.id === state.activeNoteId);
    if (!orig) return;
    const copy = { id:bumpId(), title:orig.title+' (copie)', content:orig.content, date:new Date().toLocaleDateString('fr-FR') };
    state.notes.unshift(copy);
    LS.set('dv_notes', state.notes);
    window.renderNotesList();
    selectNote(copy.id);
    showToast('✅ Note dupliquée');
  });
})();

/* Patch selectNote pour afficher/masquer le bouton Dupliquer */
const _origSelectNote = selectNote;
window.selectNote = function(id) {
  _origSelectNote(id);
  const btn = document.getElementById('dup-note-btn');
  if (btn) btn.style.display = id ? 'inline-block' : 'none';
};

/* ════════════════════════════════════════════════════════════
   6. MINIATURES DE PREVIEW COLORÉES
════════════════════════════════════════════════════════════ */
/* Remplacer buildPreview pour utiliser les vraies couleurs si dispo */
window.buildPreview = function(style, folderId, tplId) {
  let P = '#C17B5E', BG = '#FFFFFF', S = '#F0EFEB', TX = '#1A1A1A';
  if (folderId && tplId) {
    const key = `${folderId}_${tplId}`;
    const cfg = state.templateConfigs[key];
    if (cfg) {
      P  = cfg.cPrimary   || P;
      BG = cfg.cBg        || BG;
      S  = cfg.cSecondary || S;
      TX = cfg.cText      || TX;
    }
  }

  // Créer un mini wireframe SVG inline
  return `<div style="position:relative;width:100%;height:100%;background:${BG};overflow:hidden;">
    <svg viewBox="0 0 260 160" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:100%;display:block;">
      <!-- Navbar -->
      <rect x="0" y="0" width="260" height="22" fill="${P}"/>
      <circle cx="12" cy="11" r="4" fill="rgba(255,255,255,.4)"/>
      <rect x="20" y="7" width="40" height="8" rx="2" fill="rgba(255,255,255,.5)"/>
      <rect x="180" y="7" width="24" height="8" rx="2" fill="rgba(255,255,255,.3)"/>
      <rect x="210" y="7" width="24" height="8" rx="2" fill="rgba(255,255,255,.3)"/>

      <!-- Hero -->
      <rect x="0" y="22" width="150" height="68" fill="${S}"/>
      <rect x="150" y="22" width="110" height="68" fill="${P}22"/>
      <rect x="10" y="32" width="70" height="10" rx="3" fill="${TX}22"/>
      <rect x="10" y="46" width="90" height="6" rx="2" fill="${TX}14"/>
      <rect x="10" y="56" width="80" height="6" rx="2" fill="${TX}14"/>
      <rect x="10" y="68" width="44" height="14" rx="4" fill="${P}"/>
      <!-- Image hero placeholder -->
      <rect x="158" y="28" width="94" height="56" rx="6" fill="${P}30"/>
      <circle cx="205" cy="44" r="10" fill="${P}40"/>
      <polygon points="205,38 215,50 195,50" fill="${P}60"/>

      <!-- Services -->
      <rect x="0" y="94" width="260" height="66" fill="${BG}"/>
      <rect x="10" y="100" width="70" height="7" rx="2" fill="${TX}15"/>
      <rect x="10" y="110" width="55" height="5" rx="2" fill="${TX}10"/>
      <!-- 3 cards -->
      <rect x="10"  y="118" width="72" height="36" rx="4" fill="${S}"/>
      <rect x="20"  y="124" width="32" height="5" rx="2" fill="${P}60"/>
      <rect x="20"  y="132" width="50" height="4" rx="2" fill="${TX}15"/>
      <rect x="20"  y="138" width="40" height="4" rx="2" fill="${TX}10"/>

      <rect x="94"  y="118" width="72" height="36" rx="4" fill="${S}"/>
      <rect x="104" y="124" width="32" height="5" rx="2" fill="${P}60"/>
      <rect x="104" y="132" width="50" height="4" rx="2" fill="${TX}15"/>
      <rect x="104" y="138" width="40" height="4" rx="2" fill="${TX}10"/>

      <rect x="178" y="118" width="72" height="36" rx="4" fill="${S}"/>
      <rect x="188" y="124" width="32" height="5" rx="2" fill="${P}60"/>
      <rect x="188" y="132" width="50" height="4" rx="2" fill="${TX}15"/>
      <rect x="188" y="138" width="40" height="4" rx="2" fill="${TX}10"/>
    </svg>
  </div>`;
};

/* ════════════════════════════════════════════════════════════
   7. UNDO / REDO — Ctrl+Z dans l'éditeur
════════════════════════════════════════════════════════════ */
const DV_UNDO_STACK   = [];  // états précédents
const DV_REDO_STACK   = [];  // états annulés
const DV_UNDO_MAXSIZE = 40;
let   _undoCapturing  = false;

/** Capture l'état courant du panel dans la pile undo */
function dvPushUndo() {
  if (_undoCapturing) return;
  const cfg = readConfigFromPanel();
  const key = `${state.currentFolderId}_${state.currentTplId}`;
  // Inclure sectionData et images depuis le state
  const prev = state.templateConfigs[key] || {};
  const snap  = JSON.stringify({ ...prev, ...cfg });
  // Ne pas dupliquer si identique au précédent
  if (DV_UNDO_STACK.length && DV_UNDO_STACK[DV_UNDO_STACK.length - 1] === snap) return;
  DV_UNDO_STACK.push(snap);
  if (DV_UNDO_STACK.length > DV_UNDO_MAXSIZE) DV_UNDO_STACK.shift();
  DV_REDO_STACK.length = 0; // on efface le redo dès qu'on fait une nouvelle action
  dvUpdateUndoIndicator();
}

/** Annuler la dernière modification */
function dvUndo() {
  if (DV_UNDO_STACK.length < 2) { showToast('⚠️ Aucune modification à annuler'); return; }
  // Sauvegarder l'état courant dans redo
  const current = DV_UNDO_STACK.pop();
  DV_REDO_STACK.push(current);
  // Appliquer le précédent
  const prev = JSON.parse(DV_UNDO_STACK[DV_UNDO_STACK.length - 1]);
  const key  = `${state.currentFolderId}_${state.currentTplId}`;
  _undoCapturing = true;
  state.templateConfigs[key] = prev;
  LS.set('dv_configs', state.templateConfigs);
  applyConfigToPanel(prev);
  updatePreview();
  _undoCapturing = false;
  dvUpdateUndoIndicator();
  showToast('↩️ Modification annulée');
}

/** Rétablir (Ctrl+Y ou Ctrl+Shift+Z) */
function dvRedo() {
  if (DV_REDO_STACK.length === 0) { showToast('⚠️ Aucune action à rétablir'); return; }
  const next = JSON.parse(DV_REDO_STACK.pop());
  DV_UNDO_STACK.push(JSON.stringify(next));
  const key = `${state.currentFolderId}_${state.currentTplId}`;
  _undoCapturing = true;
  state.templateConfigs[key] = next;
  LS.set('dv_configs', state.templateConfigs);
  applyConfigToPanel(next);
  updatePreview();
  _undoCapturing = false;
  dvUpdateUndoIndicator();
  showToast('↪️ Modification rétablie');
}

/** Affiche un petit indicateur undo/redo près du bouton save */
function dvUpdateUndoIndicator() {
  let ind = document.getElementById('undo-indicator');
  if (!ind) {
    ind = document.createElement('span');
    ind.id = 'undo-indicator';
    ind.style.cssText = 'font-family:"DM Sans",sans-serif;font-size:11px;color:var(--text-secondary);opacity:.7;';
    const saveBtn = document.getElementById('save-btn');
    if (saveBtn && saveBtn.parentNode) saveBtn.parentNode.insertBefore(ind, saveBtn);
  }
  const undoCount = Math.max(0, DV_UNDO_STACK.length - 1);
  ind.textContent = undoCount > 0 ? `↩ ${undoCount}` : '';
}

/** Capturer l'état après chaque modification du panel (post-changement, avec debounce) */
(function() {
  const panelEl = document.getElementById('editor-panel');
  if (!panelEl) return;

  // Pré-capture : mémoriser l'état AVANT modification (pour avoir un point de retour valide)
  // On écoute le "mousedown" et "focus" pour capturer l'état juste avant que l'user commence à modifier
  let _preCaptureSnap = null;

  function _preCapture() {
    if (_undoCapturing) return;
    if (!document.getElementById('editor-page').classList.contains('active')) return;
    const cfg = readConfigFromPanel();
    const key = `${state.currentFolderId}_${state.currentTplId}`;
    const prev = state.templateConfigs[key] || {};
    _preCaptureSnap = JSON.stringify({ ...prev, ...cfg });
  }

  // On capture l'état avant qu'une modification commence
  panelEl.addEventListener('mousedown', _preCapture, true);
  panelEl.addEventListener('focus', _preCapture, true);
  panelEl.addEventListener('keydown', _preCapture, true);

  // On enregistre l'état pré-modification dans le stack après chaque changement
  // Écoute en bubble (après que la valeur soit mise à jour dans le DOM)
  let _undoDebounceTimer = null;
  ['input', 'change'].forEach(evt => {
    panelEl.addEventListener(evt, () => {
      if (_undoCapturing) return;
      if (!document.getElementById('editor-page').classList.contains('active')) return;

      // Pousser l'état PRÉ-modification si disponible et pas encore dans le stack
      if (_preCaptureSnap !== null) {
        const last = DV_UNDO_STACK.length ? DV_UNDO_STACK[DV_UNDO_STACK.length - 1] : null;
        if (last !== _preCaptureSnap) {
          DV_UNDO_STACK.push(_preCaptureSnap);
          if (DV_UNDO_STACK.length > DV_UNDO_MAXSIZE) DV_UNDO_STACK.shift();
          DV_REDO_STACK.length = 0;
          dvUpdateUndoIndicator();
        }
        _preCaptureSnap = null;
      }

      // Debounce : mettre à jour l'état courant après la fin de la saisie
      clearTimeout(_undoDebounceTimer);
      _undoDebounceTimer = setTimeout(() => {
        if (_undoCapturing) return;
        dvPushUndo();
      }, 400);
    }); // bubble phase, pas capture
  });
})();

/** Ctrl+Y / Ctrl+Shift+Z pour redo */
document.addEventListener('keydown', e => {
  if (!document.getElementById('editor-page').classList.contains('active')) return;
  const typing = ['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName);
  if (typing) return;
  if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'z') { e.preventDefault(); dvRedo(); return; }
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'y') { e.preventDefault(); dvRedo(); return; }
}, true);

/** Réinitialiser les stacks à l'ouverture d'un éditeur */
(function() {
  const _base = openEditor;
  window._dvOpenEditorWithUndo = function(tplId, folderId) {
    DV_UNDO_STACK.length = 0;
    DV_REDO_STACK.length = 0;
    _base(tplId, folderId);
    // Historique
    const key = `${folderId}_${tplId}`;
    addHistoryEntry(key, "Ouverture de l'éditeur");
    // Capturer l'état initial comme base undo
    setTimeout(() => {
      const cfg = state.templateConfigs[key] || {};
      DV_UNDO_STACK.push(JSON.stringify(cfg));
      dvUpdateUndoIndicator();
    }, 200);
    // Dirty reset après init
    setTimeout(() => _dvSetDirty(false), 260);
  };
})();

/* ════════════════════════════════════════════════════════════
   PHASE 5 — Polissage, actions manquantes, expérience complète
════════════════════════════════════════════════════════════ */

/* ─── Style dynamique : dirty indicator + context menu ─── */
(function injectStyles() {
  const style = document.createElement('style');
  style.textContent = `
    /* ── Indicateur non sauvegardé ── */
    #editor-template-name.dirty::after {
      content: ' ●';
      color: var(--accent);
      font-size: 0.75em;
      vertical-align: middle;
    }

    /* ── Menu contextuel template ── */
    .tpl-ctx-menu {
      position: fixed;
      background: var(--bg-main);
      border: 1.5px solid var(--accent-light);
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      padding: 6px 0;
      z-index: 500;
      min-width: 172px;
      animation: modalIn 0.15s ease both;
    }
    .tpl-ctx-item {
      display: flex; align-items: center; gap: 10px;
      padding: 9px 16px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      color: var(--text-main);
      cursor: pointer;
      transition: background var(--transition), color var(--transition);
      white-space: nowrap;
    }
    .tpl-ctx-item:hover { background: rgba(193,123,94,0.08); color: var(--accent); }
    .tpl-ctx-item.danger { color: var(--danger); }
    .tpl-ctx-item.danger:hover { background: rgba(231,76,60,0.07); }
    .tpl-ctx-sep { height: 1px; background: var(--accent-light); margin: 4px 0; }

    /* ── Onboarding banner ── */
    #dv-onboarding-banner {
      display: flex; align-items: flex-start; gap: 18px;
      background: var(--bg-secondary);
      border: 1.5px solid var(--accent-light);
      border-radius: 12px;
      padding: 22px 24px;
      margin-bottom: 24px;
      animation: fadeIn 0.4s ease both;
      position: relative;
    }
    #dv-onboarding-banner .ob-icon { font-size: 36px; flex-shrink: 0; }
    #dv-onboarding-banner .ob-content { flex: 1; }
    #dv-onboarding-banner .ob-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 18px; font-weight: 700;
      color: var(--text-main); margin-bottom: 5px;
    }
    #dv-onboarding-banner .ob-sub {
      font-family: 'DM Sans', sans-serif;
      font-size: 13px; color: var(--text-secondary);
      line-height: 1.55; margin-bottom: 16px;
    }
    #dv-onboarding-banner .ob-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .ob-btn-primary {
      padding: 9px 18px; border: none; border-radius: 8px;
      background: var(--accent); color: white;
      font-family: 'Space Grotesk', sans-serif; font-size: 13px; font-weight: 600;
      cursor: pointer; transition: opacity var(--transition);
    }
    .ob-btn-primary:hover { opacity: 0.88; }
    .ob-btn-secondary {
      padding: 9px 18px; border: 1.5px solid var(--accent-light); border-radius: 8px;
      background: transparent; color: var(--text-main);
      font-family: 'Space Grotesk', sans-serif; font-size: 13px; font-weight: 600;
      cursor: pointer; transition: border-color var(--transition), color var(--transition);
    }
    .ob-btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
    #dv-onboarding-close {
      position: absolute; top: 12px; right: 14px;
      background: none; border: none; cursor: pointer;
      color: var(--text-secondary); font-size: 18px; line-height: 1;
      opacity: 0.5; transition: opacity var(--transition);
      padding: 4px;
    }
    #dv-onboarding-close:hover { opacity: 1; color: var(--accent); }

    /* ── Badge secteur sur dossier ── */
    .folder-sector-badge {
      position: absolute; bottom: 10px; left: 12px;
      font-family: 'DM Sans', sans-serif; font-size: 10px; font-weight: 500;
      padding: 2px 8px; border-radius: 20px;
      background: rgba(193,123,94,0.12); color: var(--accent);
      max-width: calc(100% - 24px); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }

    /* ── Bouton renommer dossier ── */
    .folder-rename-btn {
      position: absolute; top: 10px; right: 38px;
      background: none; border: none; cursor: pointer;
      color: var(--text-secondary); padding: 4px; border-radius: 50%;
      display: flex; align-items: center;
      transition: color var(--transition), background var(--transition);
    }
    .folder-rename-btn:hover { color: var(--accent); background: rgba(193,123,94,0.1); }

    /* ── Bouton "…" sur template card ── */
    .tpl-more-btn {
      position: absolute; top: 8px; right: 8px;
      background: var(--bg-main); border: 1.5px solid var(--accent-light);
      border-radius: 50%; width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 15px; color: var(--text-secondary);
      z-index: 10; opacity: 0;
      transition: opacity var(--transition), color var(--transition), background var(--transition);
    }
    .template-card:hover .tpl-more-btn { opacity: 1; }
    .tpl-more-btn:hover { color: var(--accent); background: rgba(193,123,94,0.1); }

    /* ── Bouton télécharger HTML dans topbar ── */
    #download-html-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 7px 14px;
      border: 1.5px solid var(--accent-light);
      border-radius: 8px;
      background: transparent;
      color: var(--text-main);
      font-family: 'Space Grotesk', sans-serif; font-size: 13px; font-weight: 600;
      cursor: pointer;
      transition: border-color var(--transition), color var(--transition), background var(--transition);
    }
    #download-html-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(193,123,94,0.06); }

    /* ── Bouton copier config ── */
    #copy-config-btn {
      width: 100%; padding: 9px; margin-top: 12px;
      border: 1.5px dashed var(--accent-light); border-radius: 8px;
      background: transparent; color: var(--text-secondary);
      font-family: 'Space Grotesk', sans-serif; font-size: 12px; font-weight: 600;
      cursor: pointer; transition: border-color var(--transition), color var(--transition);
    }
    #copy-config-btn:hover { border-color: var(--accent); color: var(--accent); }
  `;
  document.head.appendChild(style);
})();


/* ════════════════════════════════════════════════════════════
   1. renderFolders — renommer + badge secteur
════════════════════════════════════════════════════════════ */
window.renderFolders = function() {
  const grid  = document.getElementById('folders-grid');
  const empty = document.getElementById('empty-state');
  const q     = state.searchQuery.toLowerCase().trim();
  const vis   = state.folders.filter(f => f.name.toLowerCase().includes(q));
  grid.innerHTML = '';
  empty.style.display = vis.length === 0 ? 'block' : 'none';

  // Afficher le banner onboarding si jamais lancé
  _dvShowOnboardingIfNeeded();

  vis.forEach((folder, i) => {
    const cnt   = (state.templates[folder.id] || []).length;
    const card  = document.createElement('div');
    card.className = 'folder-card';
    card.style.animationDelay = (i * 0.04) + 's';

    // Badge secteur : couleur primaire du premier template du dossier
    let sectorBadge = '';
    const firstTpl = (state.templates[folder.id] || [])[0];
    if (firstTpl) {
      const firstCfg = state.templateConfigs[`${folder.id}_${firstTpl.id}`];
      const sColor   = firstCfg && firstCfg.cPrimary ? firstCfg.cPrimary : null;
      const sLabel   = firstTpl.sector
        ? (Object.values ? (Object.values(SECTOR_TEMPLATES||{}).find(s=>s&&s.label)?.label||firstTpl.sector) : firstTpl.sector)
        : (firstTpl.tag || '');
      if (sLabel) {
        const bg = sColor ? sColor + '18' : 'rgba(193,123,94,0.12)';
        const fg = sColor || 'var(--accent)';
        sectorBadge = `<div class="folder-sector-badge" style="background:${bg};color:${fg};">${esc(sLabel)}</div>`;
      }
    }

    card.innerHTML = `
      <button class="folder-rename-btn" title="Renommer ce dossier" data-rename="${folder.id}">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      </button>
      <button class="folder-info-btn" title="Supprimer ce dossier" data-del-folder="${folder.id}">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
      </button>
      <div class="folder-name">${esc(folder.name)}</div>
      <div class="folder-count">${cnt} maquette${cnt !== 1 ? 's' : ''}</div>
      ${sectorBadge}`;

    card.addEventListener('click', e => {
      if (e.target.closest('[data-del-folder]') || e.target.closest('[data-rename]')) return;
      window.navigate ? window.navigate('folder-detail', folder.id) : navigate('folder-detail', folder.id);
    });

    card.querySelector('[data-del-folder]').addEventListener('click', e => {
      e.stopPropagation();
      if (!confirm(`Supprimer le dossier "${folder.name}" et toutes ses maquettes ?`)) return;
      state.folders = state.folders.filter(f => f.id !== folder.id);
      delete state.templates[folder.id];
      LS.set('dv_folders',   state.folders);
      LS.set('dv_templates', state.templates);
      window.renderFolders();
      showToast('🗑 Dossier supprimé');
    });

    card.querySelector('[data-rename]').addEventListener('click', e => {
      e.stopPropagation();
      const newName = prompt('Nouveau nom du dossier :', folder.name);
      if (!newName || !newName.trim() || newName.trim() === folder.name) return;
      folder.name = newName.trim();
      LS.set('dv_folders', state.folders);
      window.renderFolders();
      showToast(`✏️ Dossier renommé en "${folder.name}"`);
    });

    grid.appendChild(card);
  });
};

/* ── Gestionnaire unique du menu contextuel ── */
let _ctxMenuEl = null;
function _closeCtxMenu() {
  if (_ctxMenuEl) { _ctxMenuEl.remove(); _ctxMenuEl = null; }
}
document.addEventListener('click', _closeCtxMenu);
document.addEventListener('keydown', e => { if (e.key === 'Escape') _closeCtxMenu(); });

function _openCtxMenu(items, x, y) {
  _closeCtxMenu();
  const menu = document.createElement('div');
  menu.className = 'tpl-ctx-menu';
  items.forEach(item => {
    if (item === 'sep') {
      menu.appendChild(Object.assign(document.createElement('div'), { className:'tpl-ctx-sep' }));
      return;
    }
    const el = document.createElement('div');
    el.className = 'tpl-ctx-item' + (item.danger ? ' danger' : '');
    el.innerHTML = `<span style="font-size:15px;width:18px;text-align:center;flex-shrink:0;">${item.icon}</span>${esc(item.label)}`;
    el.addEventListener('click', e => { e.stopPropagation(); _closeCtxMenu(); item.action(); });
    menu.appendChild(el);
  });
  document.body.appendChild(menu);
  _ctxMenuEl = menu;
  // Position avec protection bord d'écran
  requestAnimationFrame(() => {
    const r = menu.getBoundingClientRect();
    let lx = x, ly = y;
    if (lx + r.width  > window.innerWidth  - 8) lx = window.innerWidth  - r.width  - 8;
    if (ly + r.height > window.innerHeight - 8) ly = window.innerHeight - r.height - 8;
    menu.style.left = lx + 'px';
    menu.style.top  = ly + 'px';
  });
}


/* ════════════════════════════════════════════════════════════
   3. Notes — suppression & duplication (déjà en Phase 4)
      Vérification : renderNotesList et dup-note-btn déjà patchés.
      On s'assure juste que les listeners sont actifs.
════════════════════════════════════════════════════════════ */
/* (Déjà implémenté en Phase 4 : bouton × et bouton Dupliquer) */


/* ════════════════════════════════════════════════════════════
   4. Téléchargement HTML depuis l'éditeur
════════════════════════════════════════════════════════════ */
(function addDownloadHtmlBtn() {
  const topbar   = document.getElementById('editor-topbar');
  const exportBtn= document.getElementById('export-pdf-btn');
  if (!topbar || document.getElementById('download-html-btn')) return;

  const btn = document.createElement('button');
  btn.id = 'download-html-btn';
  btn.innerHTML = `
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    Télécharger HTML`;
  topbar.insertBefore(btn, exportBtn);

  btn.addEventListener('click', () => {
    const cfg = readConfigFromPanel();
    const html = generatePreviewHTML(cfg);
    const tplId    = state.currentTplId;
    const folderId = state.currentFolderId;
    const tpl      = (state.templates[folderId]||[]).find(t => t.id === tplId);
    const meta     = getMeta(folderId, tplId);
    const rawName  = (meta && meta.name) || (tpl && tpl.name) || 'maquette';
    const safeName = rawName.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    const date     = new Date().toISOString().slice(0,10);
    const filename = `${safeName}-${date}.html`;

    const a    = document.createElement('a');
    a.href     = 'data:text/html;charset=utf-8,' + encodeURIComponent(html);
    a.download = filename;
    a.click();
    showToast('📄 HTML téléchargé');
  });
})();


/* ════════════════════════════════════════════════════════════
   5. Recherche étendue — déjà gérée dans window.renderTemplates
      Le listener #search est rebindé en section 1 ci-dessus.
════════════════════════════════════════════════════════════ */


/* ════════════════════════════════════════════════════════════
   6. Onboarding — premier lancement
════════════════════════════════════════════════════════════ */
function _dvShowOnboardingIfNeeded() {
  const done        = LS.get('dv_onboarding_done', false);
  const hasFolders  = state.folders.length > 0;
  const existing    = document.getElementById('dv-onboarding-banner');

  // Retirer le banner si dossiers créés ou déjà fermé
  if (done || hasFolders) {
    if (existing) existing.remove();
    return;
  }
  if (existing) return; // déjà affiché

  const banner = document.createElement('div');
  banner.id    = 'dv-onboarding-banner';
  banner.innerHTML = `
    <div class="ob-icon">👋</div>
    <div class="ob-content">
      <div class="ob-title">Bienvenue dans DraftVault</div>
      <div class="ob-sub">Créez votre premier dossier client et générez une maquette en 30 secondes. Tout est stocké localement, rien ne quitte votre machine.</div>
      <div class="ob-actions">
        <button class="ob-btn-primary" id="ob-create-folder">📁 Créer un dossier</button>
        <button class="ob-btn-secondary" id="ob-import-html">⬆️ Importer un HTML</button>
      </div>
    </div>
    <button id="dv-onboarding-close" title="Ne plus afficher">×</button>`;

  const grid = document.getElementById('folders-grid');
  grid.parentNode.insertBefore(banner, grid);

  banner.querySelector('#ob-create-folder').addEventListener('click', () => openModal('folder'));
  banner.querySelector('#ob-import-html').addEventListener('click', () => {
    document.getElementById('import-html-overlay').classList.add('visible');
  });
  banner.querySelector('#dv-onboarding-close').addEventListener('click', () => {
    LS.set('dv_onboarding_done', true);
    banner.style.animation = 'none';
    banner.style.opacity   = '0';
    banner.style.transition= 'opacity 0.3s ease';
    setTimeout(() => banner.remove(), 320);
  });
}


/* ════════════════════════════════════════════════════════════
   7. Indicateur "non sauvegardé" (_dvDirty)
════════════════════════════════════════════════════════════ */
let _dvDirty = false;

function _dvSetDirty(dirty) {
  _dvDirty = dirty;
  const el = document.getElementById('editor-template-name');
  if (!el) return;
  if (dirty) el.classList.add('dirty');
  else        el.classList.remove('dirty');
}

/* Hooker le panel : chaque input/change → dirty */
(function() {
  const panelEl = document.getElementById('editor-panel');
  if (!panelEl) return;
  ['input','change'].forEach(evt => {
    panelEl.addEventListener(evt, () => {
      if (!document.getElementById('editor-page').classList.contains('active')) return;
      if (!_undoCapturing) _dvSetDirty(true);
    });
  });
})();

/* Patch save-btn pour remettre à zéro le dirty */
(function() {
  const saveBtn = document.getElementById('save-btn');
  if (!saveBtn) return;
  const fresh = saveBtn.cloneNode(true);
  saveBtn.replaceWith(fresh);
  fresh.addEventListener('click', () => {
    saveCurrentVersion(false);
    const key = `${state.currentFolderId}_${state.currentTplId}`;
    addHistoryEntry(key, 'Version sauvegardée manuellement');
    _dvSetDirty(false);
  });
})();



/* ════════════════════════════════════════════════════════════
   8. Export config JSON depuis le panel (bouton "Copier la config")
════════════════════════════════════════════════════════════ */
(function addCopyConfigBtn() {
  const versionsList = document.getElementById('versions-list');
  if (!versionsList || document.getElementById('copy-config-btn')) return;

  const btn    = document.createElement('button');
  btn.id       = 'copy-config-btn';
  btn.textContent = '📋 Copier la config JSON';
  versionsList.parentNode.appendChild(btn);

  btn.addEventListener('click', () => {
    const cfg = readConfigFromPanel();
    // Exclure les images (peuvent être lourdes)
    const { images, ...cfgWithoutImages } = (cfg || {});
    const json = JSON.stringify(cfgWithoutImages, null, 2);
    navigator.clipboard.writeText(json).then(
      () => showToast('📋 Config copiée dans le presse-papier'),
      () => {
        // Fallback : créer un input temporaire
        const tmp = document.createElement('textarea');
        tmp.value = json; document.body.appendChild(tmp);
        tmp.select(); document.execCommand('copy'); tmp.remove();
        showToast('📋 Config copiée');
      }
    );
  });
})();

/* ════════════════════════════════════════════════════════════
   NAVIGATE & SEARCH — VERSION FINALE CONSOLIDÉE
   Remplace tous les patches intermédiaires des phases 3, 4, 5.
   Garantit que window.renderFolders, window.renderTemplates
   et window._dvShowOnboardingIfNeeded sont toujours appelés.
════════════════════════════════════════════════════════════ */
(function() {
  const _navBase = navigate; // fonction Phase 3 locale

  window.navigate = function(page, folderId, tplId) {
    _navBase(page, folderId, tplId);
    if (page === 'home') {
      window.renderFolders();
    } else if (page === 'folder-detail' && folderId) {
      window.renderTemplates(folderId);
    }
  };

  // Rebind TOUS les boutons de navigation
  document.querySelectorAll('[data-page]').forEach(b => {
    const fresh = b.cloneNode(true);
    b.replaceWith(fresh);
    fresh.addEventListener('click', () => window.navigate(fresh.dataset.page));
  });
  const backBtn = document.getElementById('back-btn');
  if (backBtn) {
    const fresh = backBtn.cloneNode(true);
    backBtn.replaceWith(fresh);
    fresh.addEventListener('click', () => window.navigate('home'));
  }
  const editorBackBtn = document.getElementById('editor-back-btn');
  if (editorBackBtn) {
    const fresh = editorBackBtn.cloneNode(true);
    editorBackBtn.replaceWith(fresh);
    fresh.addEventListener('click', () => window.navigate('folder-detail', state.currentFolderId));
  }

  // Barre de recherche — rebind unique
  const searchEl = document.getElementById('search');
  if (searchEl) {
    const fresh = searchEl.cloneNode(true);
    searchEl.replaceWith(fresh);
    fresh.addEventListener('input', e => {
      state.searchQuery = e.target.value;
      if      (state.currentPage === 'home')          window.renderFolders();
      else if (state.currentPage === 'folder-detail') window.renderTemplates(state.currentFolderId);
    });
  }
})();

/* ── renderTemplates FINAL (unique, avec search + buildPreview + menu "…") ── */
window.renderTemplates = function(folderId) {
  const folder       = state.folders.find(f => f.id === folderId);
  const allTemplates = state.templates[folderId] || [];
  const q            = state.searchQuery.toLowerCase().trim();
  const templates    = q ? allTemplates.filter(t =>
    t.name.toLowerCase().includes(q) ||
    ((getMeta(folderId, t.id).tag || t.tag || '').toLowerCase().includes(q))
  ) : allTemplates;
  const grid  = document.getElementById('templates-grid');
  const empty = document.getElementById('templates-empty');
  if (!grid) return;
  document.getElementById('detail-title').textContent    = folder ? folder.name : 'Dossier';
  document.getElementById('detail-subtitle').textContent =
    `${allTemplates.length} maquette${allTemplates.length !== 1 ? 's' : ''}${q ? ' (filtré)' : ''}`;
  grid.innerHTML = '';
  empty.style.display = templates.length === 0 ? 'block' : 'none';

  const statusColors = { draft:'#999', review:'#3A6AA0', validated:'#3A8040', accepted:'#3A8040', sent:'#C17B5E', delivered:'#C17B5E' };
  const statusLabels = { draft:'Brouillon', review:'En révision', validated:'Validé', accepted:'Accepté', sent:'Envoyé', delivered:'Livré' };

  templates.forEach((tpl, i) => {
    const meta   = getMeta(folderId, tpl.id);
    const status = meta.status || 'draft';
    const card   = document.createElement('div');
    card.className = 'template-card';
    card.style.animationDelay = (i * 0.05) + 's';
    card.innerHTML = `
      <div class="template-preview">${window.buildPreview(tpl.style || 'light', folderId, tpl.id)}</div>
      <div class="template-overlay">
        <button class="overlay-open-btn" data-open>
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Ouvrir
        </button>
        <button class="overlay-info-btn" data-info>
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          Infos
        </button>
      </div>
      <div class="template-card-body">
        <div class="template-name">${esc(tpl.name)}</div>
        <div class="template-meta">
          <span class="template-tag">${esc(meta.tag || tpl.tag || 'Vitrine')}</span>
          <span style="display:flex;align-items:center;gap:5px;">
            <span style="width:7px;height:7px;border-radius:50%;background:${statusColors[status]};display:inline-block;"></span>
            <span style="font-size:11px;color:${statusColors[status]}">${statusLabels[status] || 'Brouillon'}</span>
          </span>
        </div>
      </div>
      <button class="tpl-more-btn" title="Plus d'actions" data-more>···</button>`;

    card.querySelector('[data-open]').addEventListener('click', e => { e.stopPropagation(); window._dvOpenEditorWithUndo(tpl.id, folderId); });
    card.querySelector('[data-info]').addEventListener('click', e => { e.stopPropagation(); openInfoDrawer(tpl.id, folderId); });
    card.addEventListener('click', e => {
      if (e.target.closest('[data-more]')) return;
      window._dvOpenEditorWithUndo(tpl.id, folderId);
    });

    card.querySelector('[data-more]').addEventListener('click', e => {
      e.stopPropagation();
      const rect = e.currentTarget.getBoundingClientRect();
      _openCtxMenu([
        {
          icon: '✏️', label: 'Renommer',
          action: () => {
            const newName = prompt('Nouveau nom de la maquette :', tpl.name);
            if (!newName || !newName.trim() || newName.trim() === tpl.name) return;
            tpl.name = newName.trim();
            LS.set('dv_templates', state.templates);
            window.renderTemplates(folderId);
            showToast(`✏️ Maquette renommée en "${tpl.name}"`);
          }
        },
        {
          icon: '⎘', label: 'Dupliquer',
          action: () => {
            const newId  = bumpId();
            const newTpl = { ...tpl, id: newId, name: `Copie de ${tpl.name}`, date: new Date().toLocaleDateString('fr-FR', { month:'short', year:'numeric' }) };
            if (!state.templates[folderId]) state.templates[folderId] = [];
            state.templates[folderId].push(newTpl);
            const srcKey = `${folderId}_${tpl.id}`;
            const dstKey = `${folderId}_${newId}`;
            if (state.templateConfigs[srcKey]) state.templateConfigs[dstKey] = JSON.parse(JSON.stringify(state.templateConfigs[srcKey]));
            const srcMeta = getMeta(folderId, tpl.id);
            state.templateMeta[dstKey] = JSON.parse(JSON.stringify({ ...srcMeta, name: newTpl.name, historique: [], devis: { status:'draft', lines:[] } }));
            LS.set('dv_templates', state.templates);
            LS.set('dv_configs',   state.templateConfigs);
            LS.set('dv_meta',      state.templateMeta);
            window.renderTemplates(folderId);
            showToast(`⎘ Maquette dupliquée : "${newTpl.name}"`);
          }
        },
        {
          icon: '📁', label: 'Déplacer vers…',
          action: () => {
            const otherFolders = state.folders.filter(f => f.id !== folderId);
            if (otherFolders.length === 0) { showToast('⚠️ Aucun autre dossier disponible'); return; }
            const list  = otherFolders.map((f, idx) => `${idx + 1}. ${f.name}`).join('\n');
            const input = prompt(`Déplacer "${tpl.name}" vers :\n${list}\n\nEntrez le numéro :`, '1');
            if (!input) return;
            const idx = parseInt(input.trim()) - 1;
            if (isNaN(idx) || idx < 0 || idx >= otherFolders.length) { showToast('⚠️ Numéro invalide'); return; }
            const target = otherFolders[idx];
            state.templates[folderId] = (state.templates[folderId] || []).filter(t => t.id !== tpl.id);
            if (!state.templates[target.id]) state.templates[target.id] = [];
            state.templates[target.id].push(tpl);
            const srcKey = `${folderId}_${tpl.id}`;
            const dstKey = `${target.id}_${tpl.id}`;
            if (state.templateConfigs[srcKey]) { state.templateConfigs[dstKey] = state.templateConfigs[srcKey]; delete state.templateConfigs[srcKey]; }
            if (state.templateMeta[srcKey])    { state.templateMeta[dstKey]    = state.templateMeta[srcKey];    delete state.templateMeta[srcKey]; }
            if (state.versions && state.versions[srcKey]) { state.versions[dstKey] = state.versions[srcKey]; delete state.versions[srcKey]; }
            LS.set('dv_templates', state.templates);
            LS.set('dv_configs',   state.templateConfigs);
            LS.set('dv_meta',      state.templateMeta);
            if (state.versions) LS.set('dv_versions', state.versions);
            window.renderTemplates(folderId);
            showToast(`📁 Maquette déplacée vers "${target.name}"`);
          }
        },
        'sep',
        {
          icon: '🗑', label: 'Supprimer', danger: true,
          action: () => {
            if (!confirm(`Supprimer définitivement "${tpl.name}" ?`)) return;
            state.templates[folderId] = (state.templates[folderId] || []).filter(t => t.id !== tpl.id);
            const key = `${folderId}_${tpl.id}`;
            delete state.templateConfigs[key];
            delete state.templateMeta[key];
            if (state.versions) delete state.versions[key];
            LS.set('dv_templates', state.templates);
            LS.set('dv_configs',   state.templateConfigs);
            LS.set('dv_meta',      state.templateMeta);
            if (state.versions) LS.set('dv_versions', state.versions);
            window.renderTemplates(folderId);
            showToast('🗑 Maquette supprimée');
          }
        }
      ], rect.left, rect.bottom + 6);
    });

    grid.appendChild(card);
  });
};


/* navigate() lancé depuis _dvInitState */
console.log('DraftVault v20 — Sections import HTML + Undo/Redo complet.');

</script>

<!-- ══ ÉCRANS AUTH / LOADING (hors app-root) ══ -->
<style>
#dv-auth-screen  { position:fixed;inset:0;z-index:9999;background:var(--bg-main);display:flex;align-items:center;justify-content:center; }
#dv-loading-screen { position:fixed;inset:0;z-index:9998;background:var(--bg-main);display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px; }
#dv-app-root { display:none;flex:1;overflow:hidden;min-width:0; }
body { flex-direction:row!important; }
@keyframes dvp{0%,100%{opacity:.25;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
</style>

<div id="dv-auth-screen">
  <div style="background:var(--bg-secondary);border:1.5px solid var(--accent-light);border-radius:20px;padding:52px 48px;max-width:400px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.10);">
    <div style="font-family:'Space Grotesk',sans-serif;font-size:28px;font-weight:800;color:var(--accent);letter-spacing:-1px;margin-bottom:6px;">DRAFTVAULT</div>
    <div style="font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text-secondary);margin-bottom:36px;">Connectez-vous pour acceder a vos maquettes</div>
    <button id="dv-google-signin" style="display:flex;align-items:center;justify-content:center;gap:12px;width:100%;padding:14px 24px;border:1.5px solid #dadce0;border-radius:10px;background:white;font-family:'Space Grotesk',sans-serif;font-size:14px;font-weight:600;color:#3c4043;cursor:pointer;">
      <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
      Continuer avec Google
    </button>
    <div id="dv-auth-error" style="margin-top:14px;font-family:'DM Sans',sans-serif;font-size:12px;color:#e74c3c;min-height:18px;"></div>
  </div>
</div>

<div id="dv-loading-screen">
  <div style="font-family:'Space Grotesk',sans-serif;font-size:24px;font-weight:800;color:var(--accent);">DRAFTVAULT</div>
  <div style="display:flex;gap:8px;">
    <span style="width:8px;height:8px;border-radius:50%;background:var(--accent);animation:dvp 1.2s ease-in-out 0s   infinite;display:inline-block;"></span>
    <span style="width:8px;height:8px;border-radius:50%;background:var(--accent);animation:dvp 1.2s ease-in-out 0.2s infinite;display:inline-block;"></span>
    <span style="width:8px;height:8px;border-radius:50%;background:var(--accent);animation:dvp 1.2s ease-in-out 0.4s infinite;display:inline-block;"></span>
  </div>
  <div style="font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text-secondary);">Chargement de vos donnees...</div>
</div>

<script type="module">
import { initializeApp }  from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
                           from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { getFirestore, doc, getDoc, setDoc, deleteDoc }
                           from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { getStorage, ref as sref, uploadString, getDownloadURL, deleteObject }
                           from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

const fbapp = initializeApp({
  apiKey:'AIzaSyC6FwiC_zQS2MzD9TvtqTkDJtNmh1k-GmM',
  authDomain:'draftvault.firebaseapp.com', projectId:'draftvault',
  storageBucket:'draftvault.firebasestorage.app',
  messagingSenderId:'320159770703',
  appId:'1:320159770703:web:5e49a81e819944a053e23a'
});
const fbauth=getAuth(fbapp), fbdb=getFirestore(fbapp), fbst=getStorage(fbapp);
let _uid=null;

async function compress(d,maxW=1200,q=0.82){
  return new Promise(r=>{
    const img=new Image();
    img.onload=()=>{
      const sc=Math.min(1,maxW/img.width),cv=document.createElement('canvas');
      cv.width=Math.round(img.width*sc); cv.height=Math.round(img.height*sc);
      cv.getContext('2d').drawImage(img,0,0,cv.width,cv.height);
      r(cv.toDataURL('image/jpeg',q));
    }; img.src=d;
  });
}
function uref(k){ return doc(fbdb,'users',_uid,'store',k); }

window._dvDB={
  get:async(k,df=null)=>{try{const s=await getDoc(uref(k));return s.exists()?s.data().v:df;}catch(e){return df;}},
  set:async(k,v)=>{try{await setDoc(uref(k),{v});}catch(e){console.error('DB',k,e);}},
  del:async(k)=>{try{await deleteDoc(uref(k));}catch(e){}}
};
window._dvST={
  upload:async(path,dataUrl)=>{
    const comp=await compress(dataUrl);
    const r=sref(fbst,path);
    await uploadString(r,comp,'data_url');
    return await getDownloadURL(r);
  },
  del:async(path)=>{try{await deleteObject(sref(fbst,path));}catch(e){}}
};
window._dvGetUID=()=>_uid;
window._dvStoragePath=k=>'users/'+_uid+'/images/'+k;
window._dvSignOut=()=>signOut(fbauth);

async function loadAll(){
  const keys=['dv_folders','dv_templates','dv_configs','dv_meta','dv_clients','dv_notes','dv_versions','dv_nextId','dv_shortcuts'];
  const defs={dv_folders:[],dv_templates:{},dv_configs:{},dv_meta:{},dv_clients:[],dv_notes:[],dv_versions:{},dv_nextId:100,dv_shortcuts:null};
  const res=await Promise.all(keys.map(k=>window._dvDB.get(k,defs[k])));
  const out={};keys.forEach((k,i)=>out[k]=res[i]);return out;
}

onAuthStateChanged(fbauth, async user=>{
  const ae=document.getElementById('dv-auth-screen');
  const le=document.getElementById('dv-loading-screen');
  const ap=document.getElementById('dv-app-root');
  if(user){
    _uid=user.uid;
    ae.style.display='none'; le.style.display='flex'; ap.style.display='none';
    const data=await loadAll();
    le.style.display='none'; ap.style.display='flex';
    window._dvInitState(data,user);
  } else {
    _uid=null;
    ae.style.display='flex'; le.style.display='none'; ap.style.display='none';
  }
});

document.getElementById('dv-google-signin').addEventListener('click', async()=>{
  document.getElementById('dv-auth-error').textContent='';
  try{ await signInWithPopup(fbauth, new GoogleAuthProvider()); }
  catch(e){ document.getElementById('dv-auth-error').textContent='Erreur: '+e.code; console.error(e); }
});
document.getElementById('dv-signout-btn').addEventListener('click', ()=>signOut(fbauth));
</script>

</body>
</html>